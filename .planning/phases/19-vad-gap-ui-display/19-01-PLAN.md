---
phase: 19-vad-gap-ui-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui.js
  - style.css
autonomous: true

must_haves:
  truths:
    - "Hovering over pause indicator shows tooltip with VAD percentage and factual hint"
    - "Hovering over hesitation indicator shows tooltip with VAD percentage and factual hint"
    - "Pause indicators with VAD >= 30% display in orange color"
    - "Hesitation indicators with VAD >= 30% display with orange left border"
  artifacts:
    - path: "js/ui.js"
      provides: "VAD tooltip builder and indicator rendering with VAD class"
      contains: "buildVADTooltipInfo"
    - path: "style.css"
      provides: "Orange color classes for VAD indicators"
      contains: ".pause-indicator-vad"
  key_links:
    - from: "js/ui.js"
      to: "pause._vadAnalysis"
      via: "tooltip string concatenation"
      pattern: "_vadAnalysis\\.speechPercent"
    - from: "js/ui.js"
      to: "style.css"
      via: "classList.add('pause-indicator-vad')"
      pattern: "pause-indicator-vad"
---

<objective>
Display VAD acoustic context on pause and hesitation indicators so teachers understand what happened during reported gaps.

Purpose: Teachers currently see pause and hesitation indicators but cannot tell if the gap was true silence or contained sounding-out / timestamp drift. This plan adds tooltips showing VAD percentage and factual descriptions, plus visual distinction (orange color) for gaps with significant speech activity.

Output: Updated ui.js with VAD tooltips and orange indicator classes; updated style.css with .pause-indicator-vad and .word-hesitation-vad classes.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Phase 18 created `_vadAnalysis` properties on diagnostics.longPauses and diagnostics.onsetDelays:
- `_vadAnalysis.speechPercent` - 0-100, one decimal place
- `_vadAnalysis.label` - one of: "silence confirmed", "mostly silent", "mixed signal", "speech detected", "continuous speech"

Per 19-CONTEXT.md decisions:
- Tooltip format: "VAD: X% - factual hint"
- Orange color (#ff9800) for indicators with VAD >= 30%
- Factual descriptions: "no speech detected", "minimal speech detected", "partial speech during gap", "speech detected during gap", "continuous speech during gap"
- Single orange shade (no gradient)
- Hesitation indicators also get orange treatment (consistent)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VAD tooltip helper function to ui.js</name>
  <files>js/ui.js</files>
  <action>
Add a helper function near the top of ui.js (after buildNLTooltip, around line 65) to build VAD tooltip text:

```javascript
/**
 * Build tooltip portion for VAD gap analysis.
 * Per CONTEXT.md: VAD percentage first, then factual hint.
 * @param {Object|null} vadAnalysis - _vadAnalysis from diagnostics
 * @returns {string} Tooltip portion or empty string if no VAD data
 */
function buildVADTooltipInfo(vadAnalysis) {
  if (!vadAnalysis) return '';

  const factualHints = {
    'silence confirmed': 'no speech detected',
    'mostly silent': 'minimal speech detected',
    'mixed signal': 'partial speech during gap',
    'speech detected': 'speech detected during gap',
    'continuous speech': 'continuous speech during gap'
  };

  const hint = factualHints[vadAnalysis.label] || vadAnalysis.label;
  return `\nVAD: ${vadAnalysis.speechPercent}% - ${hint}`;
}
```

This function will be called by both pause and hesitation indicator rendering.
  </action>
  <verify>grep -n "buildVADTooltipInfo" js/ui.js shows the function definition</verify>
  <done>Helper function exists and maps all 5 acoustic labels to factual descriptions</done>
</task>

<task type="auto">
  <name>Task 2: Add VAD info to pause and hesitation tooltips</name>
  <files>js/ui.js</files>
  <action>
Modify the pause indicator rendering (around line 519-533) to:
1. Add VAD class if speechPercent >= 30
2. Append VAD tooltip info

Find this block:
```javascript
if (hasPause) {
  const pause = longPauseMap.get(currentHypIndex - 1);
  const pauseSpan = document.createElement('span');
  pauseSpan.className = 'pause-indicator';
  const pauseMs = Math.round(pause.gap * 1000);
  pauseSpan.title = 'Long pause: ' + pauseMs + 'ms (error: >= 3000ms)';
```

Update to:
```javascript
if (hasPause) {
  const pause = longPauseMap.get(currentHypIndex - 1);
  const pauseSpan = document.createElement('span');
  pauseSpan.className = 'pause-indicator';

  // VAD visual distinction: orange if speech >= 30%
  if (pause._vadAnalysis && pause._vadAnalysis.speechPercent >= 30) {
    pauseSpan.classList.add('pause-indicator-vad');
  }

  const pauseMs = Math.round(pause.gap * 1000);
  let pauseTooltip = 'Long pause: ' + pauseMs + 'ms (error: >= 3000ms)';
  pauseTooltip += buildVADTooltipInfo(pause._vadAnalysis);
  pauseSpan.title = pauseTooltip;
```

Modify the hesitation indicator rendering (around line 493-509) to:
1. Add VAD class if speechPercent >= 30
2. Append VAD tooltip info after existing hesitation note

Find this existing block:
```javascript
if (currentHypIndex !== null && onsetDelayMap.has(currentHypIndex)) {
  const delay = onsetDelayMap.get(currentHypIndex);
  span.classList.add('word-hesitation');
```

Add VAD class check after the word-hesitation class:
```javascript
if (currentHypIndex !== null && onsetDelayMap.has(currentHypIndex)) {
  const delay = onsetDelayMap.get(currentHypIndex);
  span.classList.add('word-hesitation');

  // VAD visual distinction: orange if speech >= 30%
  if (delay._vadAnalysis && delay._vadAnalysis.speechPercent >= 30) {
    span.classList.add('word-hesitation-vad');
  }
```

Then at the end of the hesitation block (after building hesitationNote), add:
```javascript
  // Add VAD info to tooltip
  hesitationNote += buildVADTooltipInfo(delay._vadAnalysis);
  span.title += hesitationNote;
```
  </action>
  <verify>grep -n "_vadAnalysis" js/ui.js shows references in both pause and hesitation blocks</verify>
  <done>Pause indicators show "VAD: X% - hint" in tooltip; hesitation indicators show same; both add VAD class when >= 30%</done>
</task>

<task type="auto">
  <name>Task 3: Add CSS classes for VAD visual distinction</name>
  <files>style.css</files>
  <action>
Add two CSS classes at the end of style.css (after the .word-struggle class, around line 383):

```css
/* VAD Gap UI Display (Phase 19)
 * Orange color for pause/hesitation indicators with VAD speech >= 30%
 * Helps teachers distinguish gaps with speech activity from true silence
 */
.pause-indicator-vad {
  color: #ff9800;  /* Orange - differentiates from default gray */
}

.word-hesitation-vad {
  border-left-color: #ff9800;  /* Orange left border instead of default orange */
}
```

Note: The existing .word-hesitation already has border-left: 3px solid #ff9800 (orange).
The .word-hesitation-vad class explicitly sets border-left-color to ensure the orange is applied
even if base hesitation styling changes in the future. This is intentional redundancy per CONTEXT.md
decision for consistent treatment.
  </action>
  <verify>grep -n "pause-indicator-vad" style.css shows the class; grep -n "word-hesitation-vad" style.css shows the class</verify>
  <done>Both CSS classes exist with #ff9800 orange color</done>
</task>

</tasks>

<verification>
After all tasks:

1. Open app in browser, load a recording with pauses/hesitations
2. Verify pause indicators:
   - Hover shows tooltip with "Long pause: Xms (error: >= 3000ms)" AND "VAD: X% - factual hint"
   - If VAD >= 30%, pause text should be orange
   - If VAD < 30%, pause text should be default gray (#999)

3. Verify hesitation indicators:
   - Hover shows tooltip with hesitation info AND "VAD: X% - factual hint"
   - If VAD >= 30%, left border should be orange (#ff9800)
   - If VAD < 30%, left border should be default orange (already was)

4. Check debug panel shows VAD gap analysis counts (from Phase 18)
</verification>

<success_criteria>
- [ ] UI-01: Hovering over pause indicator shows "VAD: X% - factual hint" in tooltip
- [ ] UI-02: Hovering over hesitation indicator shows "VAD: X% - factual hint" in tooltip
- [ ] UI-03: Pause indicators with VAD >= 30% display in orange color (#ff9800)
- [ ] Hesitation indicators with VAD >= 30% have orange left border (consistent treatment)
- [ ] All 5 acoustic labels map to factual descriptions
- [ ] Version timestamp updated in index.html
</success_criteria>

<output>
After completion, create `.planning/phases/19-vad-gap-ui-display/19-01-SUMMARY.md`
</output>
