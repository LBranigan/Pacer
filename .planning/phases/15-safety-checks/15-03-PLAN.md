---
phase: 15-safety-checks
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - js/app.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Safety checks run after disfluency detection, before alignment"
    - "_safety field persisted in saved assessments"
    - "Collapse state available for Phase 16 UI banner"
    - "Safety stats logged to debug stages"
  artifacts:
    - path: "js/app.js"
      provides: "Integrated safety check pipeline"
      contains: "applySafetyChecks"
  key_links:
    - from: "js/app.js"
      to: "js/safety-checker.js"
      via: "import applySafetyChecks"
      pattern: "import.*applySafetyChecks.*safety-checker"
---

<objective>
Integrate safety checks into the app.js assessment flow and persist _safety data.

Purpose: Complete Phase 15 by wiring safety-checker.js into the existing pipeline, ensuring rate anomalies and uncorroborated sequences are detected during assessment and data is available for Phase 16 UI display.

Output: Updated app.js with safety check step, version timestamp updated.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-safety-checks/15-CONTEXT.md
@.planning/phases/15-safety-checks/15-02-SUMMARY.md
@js/app.js
@js/safety-checker.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add safety checker import to app.js</name>
  <files>js/app.js</files>
  <action>
Add import at the top of app.js with other imports:

```javascript
import { applySafetyChecks } from './safety-checker.js';
```

Place it after the disfluency-detector import to maintain logical grouping:
```javascript
import { detectDisfluencies } from './disfluency-detector.js';
import { applySafetyChecks } from './safety-checker.js';
```
  </action>
  <verify>Run `grep "applySafetyChecks" js/app.js` shows the import line</verify>
  <done>Safety checker import added to app.js</done>
</task>

<task type="auto">
  <name>Task 2: Insert safety checks into assessment flow</name>
  <files>js/app.js</files>
  <action>
In the handleAnalyze function (or runAnalysis), insert safety checks AFTER disfluency detection, BEFORE alignment.

Find the section that looks like:
```javascript
// Pipeline: Classify -> Filter ghosts -> Detect disfluencies -> Align
setStatus('Detecting disfluencies...');
const disfluencyResult = detectDisfluencies(wordsForAlignment);
const wordsWithDisfluency = disfluencyResult.words;
```

Insert AFTER disfluency detection:
```javascript
// Pipeline: Classify -> Filter ghosts -> Detect disfluencies -> Safety checks -> Align
setStatus('Running safety checks...');
const audioDurationMs = /* get from VAD result or calculate from last word endTime */;
const safetyResult = applySafetyChecks(wordsWithDisfluency, referenceText, audioDurationMs);
const wordsWithSafety = safetyResult.words;

addStage('safety_checks', {
  rateAnomalies: safetyResult._safety.rateAnomalies,
  uncorroboratedSequences: safetyResult._safety.uncorroboratedSequences,
  collapse: safetyResult._safety.collapse
});

if (safetyResult._safety.collapse.collapsed) {
  console.warn('[ORF] Confidence collapse detected:', safetyResult._safety.collapse.percent.toFixed(1) + '% flagged');
}
```

Get audioDurationMs from:
- If vadResult exists and has durationMs, use that
- Else calculate from last word's endTime: `parseTime(wordsWithDisfluency[wordsWithDisfluency.length - 1]?.endTime) * 1000 || 0`

Update alignment to use wordsWithSafety instead of wordsWithDisfluency.
  </action>
  <verify>Run `grep -A5 "safety_checks" js/app.js` shows the addStage call with safety data</verify>
  <done>Safety checks integrated into pipeline between disfluency and alignment</done>
</task>

<task type="auto">
  <name>Task 3: Persist _safety field and update version</name>
  <files>js/app.js, index.html</files>
  <action>
1. In app.js, find where assessment data is saved (saveAssessment call) and ensure _safety is included.

Look for the data object that includes _ensemble, _vad, _classification, _disfluency. Add _safety:

```javascript
// In the data object being saved:
_safety: safetyResult._safety,
```

2. Update version timestamp in index.html #version element to current datetime (format: v YYYY-MM-DD HH:MM)

3. Update the pipeline comment to reflect the new step:
```javascript
// Pipeline: Classify -> Filter ghosts -> Detect disfluencies -> Safety checks -> Align
```
  </action>
  <verify>
- Run `grep "_safety" js/app.js` shows the field being persisted
- Check index.html #version element is updated
  </verify>
  <done>_safety field persisted in saved assessments, version updated</done>
</task>

</tasks>

<verification>
- [ ] applySafetyChecks imported in app.js
- [ ] Safety checks run after disfluency detection, before alignment
- [ ] audioDurationMs obtained from VAD result or calculated from word timestamps
- [ ] safety_checks stage added to debug log
- [ ] Collapse warning logged when detected
- [ ] _safety field included in saved assessment data
- [ ] Version timestamp updated in index.html
- [ ] Pipeline comment updated to include "Safety checks" step
</verification>

<success_criteria>
Phase 15 complete with:
- Safety checks integrated into assessment pipeline
- Rate anomalies and uncorroborated sequences flagged
- Confidence collapse state detected and logged
- _safety field persisted for Phase 16 UI display
- Debug log includes safety check statistics
</success_criteria>

<output>
After completion, create `.planning/phases/15-safety-checks/15-03-SUMMARY.md`
</output>
