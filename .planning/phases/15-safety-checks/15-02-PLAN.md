---
phase: 15-safety-checks
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - js/safety-checker.js
autonomous: true

must_haves:
  truths:
    - "Long uncorroborated sequences (7+ in-ref, 3+ not-in-ref) are flagged"
    - "Strong corroboration (source='both' + conf>=0.93) overrides rate and sequence flags"
    - "Ghost flags are never removed by corroboration override"
    - "Confidence collapse detected when >40% words have trustLevel 'none' or _flags"
  artifacts:
    - path: "js/safety-checker.js"
      provides: "Complete safety check pipeline"
      exports: ["detectRateAnomalies", "detectUncorroboratedSequences", "applyCorroborationOverride", "applySafetyChecks"]
  key_links:
    - from: "js/safety-checker.js"
      to: "js/confidence-config.js"
      via: "import for reference set building"
      pattern: "import.*confidence-classifier"
---

<objective>
Add uncorroborated sequence detection, corroboration override, and confidence collapse detection to complete the safety checker module.

Purpose: Flag long stretches of uncorroborated `latest_only` words as suspicious, while allowing strong corroboration to override flags. Detect confidence collapse state for UI banner display.

Output: Complete `js/safety-checker.js` with all safety check functions.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-safety-checks/15-CONTEXT.md
@.planning/phases/15-safety-checks/15-RESEARCH.md
@.planning/phases/15-safety-checks/15-01-SUMMARY.md
@js/safety-config.js
@js/safety-checker.js
@js/confidence-classifier.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add uncorroborated sequence detection</name>
  <files>js/safety-checker.js</files>
  <action>
Add `detectUncorroboratedSequences(words, referenceSet)` function:

1. Import `buildReferenceSet` from `./confidence-classifier.js` (for caller to build set)

2. Track two separate counters as we iterate:
   - `inRefCount` - consecutive latest_only words IN reference
   - `notInRefCount` - consecutive latest_only words NOT in reference

3. For each word:
   - If `word._source === 'both'` (corroborated):
     - Reset BOTH counters to 0
   - Else if `word._source === 'latest_only'`:
     - Check if word is in referenceSet (use canonical form)
     - If in reference: increment inRefCount
     - Else: increment notInRefCount
     - If inRefCount >= 7 OR notInRefCount >= 3:
       - Flag current word AND all words back to start of current sequence
   - Else (default_only or other):
     - Reset counters (default_only breaks the sequence)

4. Track sequence start index to enable back-flagging all words in the sequence.

5. Use addFlag helper to add UNCORROBORATED_SEQUENCE flag.

Per CONTEXT.md: "Flag each word in the suspicious sequence (not just first/last)"
  </action>
  <verify>Run `grep -n "detectUncorroboratedSequences" js/safety-checker.js` shows function exported</verify>
  <done>Uncorroborated sequence detection with split thresholds (7 in-ref, 3 not-in-ref)</done>
</task>

<task type="auto">
  <name>Task 2: Add corroboration override and collapse detection</name>
  <files>js/safety-checker.js</files>
  <action>
Add two functions:

1. `applyCorroborationOverride(words)`:
   - For each word where `_source === 'both'` AND `confidence >= 0.93`:
     - Remove RATE_ANOMALY flag from `_flags` if present
     - Remove UNCORROBORATED_SEQUENCE flag from `_flags` if present
     - NEVER remove `vad_ghost` flag (check before removing)
   - Per CONTEXT.md: "Ghost flags take priority - show ghost flag but still track other flags"
   - Return words array

2. `detectConfidenceCollapse(words)`:
   - Count words with `trustLevel === 'none'` OR `_flags.length > 0`
   - Calculate percentage: flaggedCount / words.length * 100
   - Return object: `{ collapsed: boolean, percent: number, flaggedCount: number }`
   - Collapsed = true if percent > 40

These functions complete the flag resolution rules from CONTEXT.md.
  </action>
  <verify>Run `grep -n "applyCorroborationOverride\|detectConfidenceCollapse" js/safety-checker.js` shows both functions</verify>
  <done>Corroboration override preserves ghost flags, collapse detection at 40% threshold</done>
</task>

<task type="auto">
  <name>Task 3: Create main applySafetyChecks orchestrator</name>
  <files>js/safety-checker.js</files>
  <action>
Add `applySafetyChecks(words, referenceText, audioDurationMs)` as the main entry point:

```javascript
export function applySafetyChecks(words, referenceText, audioDurationMs) {
  // Skip safety checks for single-word utterances
  if (words.length <= 1) {
    return {
      words,
      _safety: {
        rateAnomalies: 0,
        uncorroboratedSequences: 0,
        collapse: { collapsed: false, percent: 0, flaggedCount: 0 },
        skipped: 'single_word_utterance'
      }
    };
  }

  // Build reference set for sequence detection
  const referenceSet = buildReferenceSet(referenceText);

  // Step 1: Detect rate anomalies (3-word sliding window)
  detectRateAnomalies(words, audioDurationMs);

  // Step 2: Detect uncorroborated sequences (split thresholds)
  detectUncorroboratedSequences(words, referenceSet);

  // Step 3: Apply corroboration override (remove flags for strong corroboration)
  applyCorroborationOverride(words);

  // Step 4: Detect confidence collapse state
  const collapse = detectConfidenceCollapse(words);

  // Count flags for summary
  const rateAnomalies = words.filter(w => w._flags?.includes('rate_anomaly')).length;
  const uncorroboratedSequences = words.filter(w => w._flags?.includes('uncorroborated_sequence')).length;

  return {
    words,
    _safety: {
      rateAnomalies,
      uncorroboratedSequences,
      collapse
    }
  };
}
```

This is the function app.js will call in 15-03.
  </action>
  <verify>Run `grep -n "export function applySafetyChecks" js/safety-checker.js` shows the main function</verify>
  <done>Main safety check orchestrator ready for app.js integration</done>
</task>

</tasks>

<verification>
- [ ] detectUncorroboratedSequences uses split thresholds (7 in-ref, 3 not-in-ref)
- [ ] Corroborated words (source='both') reset sequence counters
- [ ] applyCorroborationOverride never removes vad_ghost flag
- [ ] Strong corroboration requires source='both' AND confidence >= 0.93
- [ ] detectConfidenceCollapse returns collapsed=true when >40% have flags/none
- [ ] applySafetyChecks returns { words, _safety } structure
- [ ] Single-word utterances skip rate and sequence checks
</verification>

<success_criteria>
Complete safety checker module with:
- Uncorroborated sequence detection (split thresholds)
- Corroboration override (preserves ghost flags)
- Confidence collapse detection (40% threshold)
- applySafetyChecks orchestrator function
</success_criteria>

<output>
After completion, create `.planning/phases/15-safety-checks/15-02-SUMMARY.md`
</output>
