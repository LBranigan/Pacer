---
phase: 15-safety-checks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/safety-config.js
  - js/safety-checker.js
autonomous: true

must_haves:
  truths:
    - "Rate anomaly detection flags >5 words/second as physically impossible"
    - "3-word sliding window catches bursts while tolerating variation"
    - "Edge tolerance (300ms) relaxes thresholds at audio boundaries"
  artifacts:
    - path: "js/safety-config.js"
      provides: "Safety thresholds and flag constants"
      exports: ["SAFETY_THRESHOLDS", "SAFETY_FLAGS"]
    - path: "js/safety-checker.js"
      provides: "Rate anomaly detection logic"
      exports: ["addFlag", "detectRateAnomalies"]
  key_links:
    - from: "js/safety-checker.js"
      to: "js/safety-config.js"
      via: "import thresholds"
      pattern: "import.*SAFETY_THRESHOLDS.*safety-config"
    - from: "js/safety-checker.js"
      to: "js/diagnostics.js"
      via: "parseTime function"
      pattern: "import.*parseTime.*diagnostics"
---

<objective>
Create safety configuration and rate anomaly detection for Phase 15 Safety Checks.

Purpose: Flag words spoken at physically impossible rates (>5 words/second) using a 3-word sliding window algorithm, enabling teachers to identify ASR hallucinations.

Output: `js/safety-config.js` with thresholds/flags, `js/safety-checker.js` with rate anomaly detection.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-safety-checks/15-CONTEXT.md
@.planning/phases/15-safety-checks/15-RESEARCH.md
@js/confidence-config.js
@js/disfluency-config.js
@js/diagnostics.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create safety-config.js</name>
  <files>js/safety-config.js</files>
  <action>
Create `js/safety-config.js` following the pattern from confidence-config.js and disfluency-config.js:

```javascript
/**
 * Safety check configuration.
 * Per CONTEXT.md: Flag physically impossible or suspicious ASR outputs.
 */

export const SAFETY_THRESHOLDS = Object.freeze({
  // Rate anomaly detection
  MAX_WORDS_PER_SECOND: 5,          // >5 w/s is physically impossible
  RATE_WINDOW_SIZE: 3,              // 3-word sliding window
  EDGE_TOLERANCE_MS: 300,           // Relaxed thresholds at audio edges

  // Uncorroborated sequence detection (split by reference presence)
  UNCORROBORATED_IN_REF_THRESHOLD: 7,      // 7+ consecutive latest_only IN reference
  UNCORROBORATED_NOT_IN_REF_THRESHOLD: 3,  // 3+ consecutive latest_only NOT in reference

  // Corroboration override
  STRONG_CORROBORATION_CONF: 0.93,  // Matches CONFIDENCE_THRESHOLDS.HIGH

  // Confidence collapse detection
  COLLAPSE_THRESHOLD_PERCENT: 40,   // >40% flagged/none triggers collapse
});

export const SAFETY_FLAGS = Object.freeze({
  RATE_ANOMALY: 'rate_anomaly',
  UNCORROBORATED_SEQUENCE: 'uncorroborated_sequence',
});
```

Include JSDoc header explaining purpose.
  </action>
  <verify>File exists at js/safety-config.js with SAFETY_THRESHOLDS and SAFETY_FLAGS exports</verify>
  <done>Safety configuration module exists with all thresholds from CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 2: Create safety-checker.js with rate anomaly detection</name>
  <files>js/safety-checker.js</files>
  <action>
Create `js/safety-checker.js` with rate anomaly detection:

1. Import dependencies:
   - `parseTime` from `./diagnostics.js`
   - `SAFETY_THRESHOLDS, SAFETY_FLAGS` from `./safety-config.js`

2. Create `addFlag(word, flag)` helper:
   - Initialize `word._flags = []` if not exists
   - Check for duplicate before pushing
   - Return word for chaining

3. Create `detectRateAnomalies(words, audioDurationMs)`:
   - Skip if fewer than 3 words (RATE_WINDOW_SIZE)
   - Calculate edge boundaries: first 300ms, last 300ms
   - For each 3-word window (i = 0 to words.length - 3):
     - Parse start time of first word, end time of last word
     - Calculate window duration in seconds
     - Calculate rate = 3 / duration (words per second)
     - If rate > 5 AND window NOT within edge tolerance:
       - Add RATE_ANOMALY flag to all 3 words in window
   - Use addFlag helper to avoid duplicates
   - Return words array (mutated)

Edge tolerance check:
- Window STARTS within 300ms of recording start (startTime * 1000 < 300)
- OR window ENDS within 300ms of recording end (endTime * 1000 > audioDurationMs - 300)

Per CONTEXT.md: "first/last 300ms of audio get relaxed rate thresholds" means we skip flagging, not apply different thresholds.
  </action>
  <verify>Run `grep -n "detectRateAnomalies\|addFlag" js/safety-checker.js` shows both functions exported</verify>
  <done>Rate anomaly detection implemented with 3-word sliding window and edge tolerance</done>
</task>

<task type="auto">
  <name>Task 3: Update version and verify module loads</name>
  <files>index.html</files>
  <action>
1. Update version timestamp in index.html #version element to current datetime (format: v YYYY-MM-DD HH:MM)

2. Verify the new modules are syntactically correct by checking browser console would load them:
   - Confirm safety-config.js has valid ES module syntax
   - Confirm safety-checker.js has valid ES module syntax
   - Confirm imports reference correct paths
  </action>
  <verify>Version updated in index.html. Both JS files have valid syntax (no parse errors when opened in browser)</verify>
  <done>Safety modules ready for integration in 15-02</done>
</task>

</tasks>

<verification>
- [ ] js/safety-config.js exists with SAFETY_THRESHOLDS and SAFETY_FLAGS
- [ ] js/safety-checker.js exists with addFlag and detectRateAnomalies
- [ ] Rate detection uses 3-word sliding window
- [ ] Edge tolerance (300ms) implemented
- [ ] No duplicate flags added (addFlag helper deduplicates)
- [ ] Version updated in index.html
</verification>

<success_criteria>
Rate anomaly detection module complete:
- SAFETY_THRESHOLDS.MAX_WORDS_PER_SECOND = 5
- 3-word sliding window algorithm implemented
- Edge tolerance skips flagging at audio boundaries
- Follows existing config/module patterns (confidence-config.js, disfluency-config.js)
</success_criteria>

<output>
After completion, create `.planning/phases/15-safety-checks/15-01-SUMMARY.md`
</output>
