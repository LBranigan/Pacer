---
phase: 03-diagnostics
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: [js/app.js, js/ui.js, style.css]
autonomous: false

must_haves:
  truths:
    - "After assessment, onset delays appear as colored borders on flagged words with severity tooltip"
    - "Long pauses (3s+) are shown as pause indicators between words"
    - "Self-corrections are displayed in a separate section, not counted as errors"
    - "Morphological errors show wavy underline with suffix mismatch tooltip"
    - "Prosody proxy score is displayed in the metrics bar alongside WCPM and accuracy"
  artifacts:
    - path: "js/app.js"
      provides: "Diagnostics pipeline integration"
      contains: "runDiagnostics"
    - path: "js/ui.js"
      provides: "Diagnostic result rendering"
      contains: "displayDiagnostics"
    - path: "style.css"
      provides: "Diagnostic visual styles"
      contains: "word-onset-delay"
  key_links:
    - from: "js/app.js"
      to: "js/diagnostics.js"
      via: "import runDiagnostics"
      pattern: "import.*runDiagnostics.*diagnostics"
    - from: "js/app.js"
      to: "js/ui.js"
      via: "passes diagnostics result to display function"
      pattern: "displayAlignmentResults.*diagnostics"
    - from: "js/ui.js"
      to: "style.css"
      via: "CSS classes for diagnostic indicators"
      pattern: "word-onset-delay|pause-indicator|word-morphological"
---

<objective>
Wire diagnostics into the assessment pipeline and render results visually with appropriate styles.

Purpose: Make diagnostic findings visible to teachers in the assessment results UI.
Output: Updated app.js (calls diagnostics), ui.js (renders diagnostic overlays), style.css (diagnostic styles).
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-diagnostics/03-RESEARCH.md
@.planning/phases/03-diagnostics/03-01-SUMMARY.md
@js/app.js
@js/ui.js
@style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire diagnostics into app.js and update ui.js to render diagnostic results</name>
  <files>js/app.js, js/ui.js, style.css</files>
  <action>
**app.js changes:**
- Add import: `import { runDiagnostics } from './diagnostics.js';`
- After computing alignment, wcpm, accuracy, call: `const diagnostics = runDiagnostics(transcriptWords, alignment, referenceText, sttLookup);`
- Pass diagnostics to display: `displayAlignmentResults(alignment, wcpm, accuracy, sttLookup, diagnostics);`

**ui.js changes to `displayAlignmentResults`:**
Add `diagnostics` parameter (default null for backward compat). After existing rendering, overlay diagnostic indicators:

1. **Onset delays:** Build a Set of word indices from `diagnostics.onsetDelays`. When rendering alignment words, if the corresponding STT word index has an onset delay, add CSS class `word-onset-{severity}` (developing/flag/frustration) and append delay info to tooltip.
   - To map alignment items to STT indices: track a hypIndex counter. For each alignment item with a non-null hyp, use the current hypIndex and increment it. Check if that hypIndex is in the onset delays set.

2. **Long pauses:** Insert pause indicator elements between words where `diagnostics.longPauses` reports a gap. Use a small inline element: `<span class="pause-indicator" title="Pause: {gap}s">[{gap}s]</span>`.
   - Map afterWordIndex from longPauses to alignment rendering position using the same hypIndex tracking.

3. **Self-corrections:** Add a new section after insertions section (similar pattern). Label: "Self-corrections (not counted as errors):". Show each repeated word/phrase with its repeat type. Use CSS class `word-self-correction`.

4. **Morphological errors:** In the alignment word rendering loop, for substitution items, check if this ref/hyp pair appears in `diagnostics.morphologicalErrors`. If so, add class `word-morphological` and append suffix info to tooltip.

5. **Prosody proxy:** Add a new metric box to the metrics bar: value = `diagnostics.prosodyProxy.ratio`, label = "Prosody". Add tooltip with details (avgPauseAtPunct, avgPauseMid, counts).

**style.css additions:**
```css
/* Onset delay indicators */
.word-onset-developing { border-left: 3px solid #ff9800; padding-left: 4px; }
.word-onset-flag { border-left: 3px solid #f44336; padding-left: 4px; }
.word-onset-frustration { border-left: 3px solid #9c27b0; padding-left: 4px; background: #f3e5f5; }

/* Pause indicators */
.pause-indicator { color: #999; font-size: 0.75rem; margin: 0 2px; font-style: italic; }

/* Self-correction */
.word-self-correction { background: #e1bee7; color: #6a1b9a; }

/* Morphological error */
.word-morphological { text-decoration: underline wavy #e65100; text-underline-offset: 3px; }
```

Keep the existing diagnostic-free behavior working when diagnostics is null/undefined.
  </action>
  <verify>
1. Open index.html in browser
2. Enter a reference passage and record/upload audio
3. Check that WCPM, Accuracy, and Prosody metrics all appear in the metrics bar
4. If any onset delays detected, words should have colored left borders
5. If any self-corrections, a separate section should appear below insertions
6. Check browser console for zero errors
  </verify>
  <done>
All five diagnostic categories are visually rendered: onset delay borders, pause indicators, self-correction section, morphological underlines, prosody metric box. Diagnostics pipeline runs after alignment without breaking existing functionality.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full diagnostics pipeline: computation module + visual display of onset delays, pauses, self-corrections, morphological errors, and prosody proxy in assessment results</what-built>
  <how-to-verify>
    1. Open index.html in browser
    2. Enter a reference passage (e.g., "The big brown dog jumped over the lazy cat and ran away quickly.")
    3. Record yourself reading it with: (a) a deliberate long pause mid-sentence, (b) repeat a word ("the the big"), (c) read slowly
    4. Verify the results show:
       - Metrics bar has WCPM, Accuracy, and Prosody boxes
       - Words with onset delays have colored left borders (orange/red/purple)
       - Long pauses show [Xs] indicators between words
       - Self-corrections section appears if you repeated words
       - Substitutions with morphological similarity show wavy underlines
    5. Hover over flagged words to see diagnostic tooltips
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- app.js imports and calls runDiagnostics, passes result to displayAlignmentResults
- ui.js renders all 5 diagnostic categories visually
- style.css has classes for onset-delay, pause-indicator, self-correction, morphological
- Prosody ratio appears in metrics bar
- Existing functionality (WCPM, accuracy, word coloring) still works when diagnostics is null
</verification>

<success_criteria>
All five diagnostic findings are visible in the assessment results UI. Teachers can see onset delays, pauses, self-corrections, morphological errors, and prosody score after each assessment.
</success_criteria>

<output>
After completion, create `.planning/phases/03-diagnostics/03-02-SUMMARY.md`
</output>
