---
phase: 16-ui-enhancements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui.js
  - js/metrics.js
  - js/app.js
  - style.css
autonomous: true

must_haves:
  truths:
    - "WCPM displays as range (e.g., 85-92)"
    - "Primary value (min) is prominent, range is smaller below"
    - "Fluency concerns summary appears below WCPM"
    - "Summary shows counts by severity"
    - "Collapse state hides WCPM and shows warning banner"
  artifacts:
    - path: "js/ui.js"
      provides: "WCPM range display and fluency summary"
      contains: "wcpm-range"
    - path: "js/metrics.js"
      provides: "computeWCPMRange function"
      contains: "wcpmMin"
    - path: "style.css"
      provides: "WCPM range and summary styling"
      contains: "wcpm-container"
  key_links:
    - from: "js/app.js"
      to: "js/metrics.js"
      via: "import and call computeWCPMRange"
      pattern: "computeWCPMRange"
    - from: "js/app.js"
      to: "js/ui.js"
      via: "pass disfluencySummary and safetyData to displayAlignmentResults"
      pattern: "displayAlignmentResults.*disfluency"
---

<objective>
Display WCPM as a range reflecting uncertainty, with fluency concerns summary below showing disfluency counts by severity.

Purpose: Per CONTEXT.md: "Conservative WCPM value = underpromise philosophy â€” better to report lower and be accurate". Teachers see uncertainty in the data.

Output: WCPM box shows min value prominently with range below, fluency summary shows "3 significant, 5 moderate, 8 minor".
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ui-enhancements/16-CONTEXT.md
@.planning/phases/16-ui-enhancements/16-RESEARCH.md

@js/ui.js (displayAlignmentResults, wcpmBox creation around line 142)
@js/metrics.js (computeWCPM function)
@js/app.js (displayAlignmentResults call around line 610, disfluencyResult around line 220, safetyResult around line 245)
@js/disfluency-detector.js (summary structure: { minor, moderate, significant })
@style.css (existing .metric-box styling)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WCPM range and summary CSS</name>
  <files>style.css</files>
  <action>
Add CSS classes for WCPM range display and fluency summary at end of file:

```css
/* WCPM range display (Phase 16) */
.wcpm-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.wcpm-primary {
  font-size: 1.5rem;
  font-weight: 700;
  color: #333;
  line-height: 1.2;
}

.wcpm-range {
  font-size: 0.75rem;
  color: #666;
  margin-top: 0.1rem;
}

.wcpm-label {
  font-size: 0.8rem;
  color: #666;
  font-weight: 600;
  margin-top: 0.25rem;
}

/* Fluency concerns summary (Phase 16) */
.fluency-summary {
  font-size: 0.8rem;
  color: #666;
  margin-top: 0.5rem;
  text-align: center;
}

.fluency-summary .significant { color: #f44336; font-weight: 600; }
.fluency-summary .moderate { color: #ff9800; }
.fluency-summary .minor { color: #ffc107; }

/* Collapse warning banner (Phase 16) */
.collapse-banner {
  background: #fff3e0;
  border: 1px solid #ff9800;
  border-radius: 6px;
  padding: 0.75rem 1rem;
  margin-bottom: 0.75rem;
  color: #e65100;
  font-weight: 600;
  text-align: center;
}
```

Per CONTEXT.md: "primary value prominent above, range shown smaller below"
  </action>
  <verify>grep "wcpm-container" style.css returns the container class</verify>
  <done>CSS classes exist for WCPM range layout, fluency summary colors, and collapse banner</done>
</task>

<task type="auto">
  <name>Task 2: Add computeWCPMRange to metrics.js</name>
  <files>js/metrics.js</files>
  <action>
Add new function after computeAccuracy:

```javascript
/**
 * Compute WCPM range accounting for uncertainty from disfluencies.
 * Per CONTEXT.md: Conservative (min) value is primary.
 *
 * Range calculation:
 * - wcpmMin: Excludes words with significant/moderate disfluency (they may not have been "correctly" read)
 * - wcpmMax: Standard WCPM (all correct words counted)
 *
 * @param {Array<{type: string, severity?: string}>} alignmentResult - From alignWords() with disfluency data
 * @param {number} elapsedSeconds - Reading duration in seconds
 * @returns {{ wcpmMin: number, wcpmMax: number, correctCount: number, elapsedSeconds: number }}
 */
export function computeWCPMRange(alignmentResult, elapsedSeconds) {
  if (!elapsedSeconds || elapsedSeconds <= 0) {
    return { wcpmMin: 0, wcpmMax: 0, correctCount: 0, elapsedSeconds: elapsedSeconds || 0 };
  }

  // Count correct words
  const correctWords = alignmentResult.filter(w => w.type === 'correct');
  const correctCount = correctWords.length;

  // Standard WCPM (max) - all correct words
  const wcpmMax = Math.round((correctCount / elapsedSeconds) * 60 * 10) / 10;

  // Conservative WCPM (min) - exclude words with significant/moderate disfluency
  // These words may have been technically "correct" but with struggle
  const confidentCorrect = correctWords.filter(w => {
    const severity = w.severity || 'none';
    return severity === 'none' || severity === 'minor';
  }).length;

  const wcpmMin = Math.round((confidentCorrect / elapsedSeconds) * 60 * 10) / 10;

  return {
    wcpmMin,
    wcpmMax,
    correctCount,
    elapsedSeconds
  };
}
```

Note: The disfluency severity needs to be on alignment items. If not available, wcpmMin will equal wcpmMax (graceful degradation).
  </action>
  <verify>grep "computeWCPMRange" js/metrics.js returns the function definition</verify>
  <done>Function computes wcpmMin and wcpmMax based on disfluency severity</done>
</task>

<task type="auto">
  <name>Task 3: Update displayAlignmentResults for range display and summary</name>
  <files>js/ui.js</files>
  <action>
Modify displayAlignmentResults to accept and display WCPM range and disfluency summary.

1. Update function signature to accept new parameters:
```javascript
export function displayAlignmentResults(alignment, wcpm, accuracy, sttLookup, diagnostics, transcriptWords, tierBreakdown, disfluencySummary, safetyData) {
```

2. Replace WCPM box creation (around line 142-145) with range display:

```javascript
// WCPM box with range display
const wcpmBox = document.createElement('div');
wcpmBox.className = 'metric-box';

// Check for collapse state
if (safetyData?.collapse?.collapsed) {
  // Show collapse banner instead of WCPM
  const banner = document.createElement('div');
  banner.className = 'collapse-banner';
  banner.textContent = 'Results may be unreliable due to poor audio quality';
  metricsBar.appendChild(banner);
} else if (wcpm) {
  // Normal WCPM range display
  const container = document.createElement('div');
  container.className = 'wcpm-container';

  const primary = document.createElement('div');
  primary.className = 'wcpm-primary';
  primary.textContent = wcpm.wcpmMin ?? wcpm.wcpm ?? 'N/A';

  const range = document.createElement('div');
  range.className = 'wcpm-range';
  // Show range only if different
  if (wcpm.wcpmMin !== undefined && wcpm.wcpmMax !== undefined && wcpm.wcpmMin !== wcpm.wcpmMax) {
    range.textContent = `${wcpm.wcpmMin}-${wcpm.wcpmMax} WCPM`;
  } else {
    range.textContent = `${wcpm.wcpm ?? wcpm.wcpmMin} WCPM`;
  }

  const label = document.createElement('div');
  label.className = 'wcpm-label';
  label.textContent = 'WCPM';

  container.appendChild(primary);
  container.appendChild(range);

  wcpmBox.appendChild(container);
  metricsBar.appendChild(wcpmBox);

  // Fluency concerns summary - directly below WCPM per CONTEXT.md
  if (disfluencySummary && disfluencySummary.totalWordsWithDisfluency > 0) {
    const summary = document.createElement('div');
    summary.className = 'fluency-summary';

    const parts = [];
    if (disfluencySummary.significant > 0) {
      parts.push(`<span class="significant">${disfluencySummary.significant} significant</span>`);
    }
    if (disfluencySummary.moderate > 0) {
      parts.push(`<span class="moderate">${disfluencySummary.moderate} moderate</span>`);
    }
    if (disfluencySummary.minor > 0) {
      parts.push(`<span class="minor">${disfluencySummary.minor} minor</span>`);
    }

    summary.innerHTML = parts.join(', ');
    wcpmBox.appendChild(summary);
  }
} else {
  wcpmBox.innerHTML = '<span class="metric-value">N/A</span><span class="metric-label">WCPM</span>';
  metricsBar.appendChild(wcpmBox);
}
```

3. Keep the rest of the function unchanged (accuracy box, errors box, tier breakdown).
  </action>
  <verify>
1. Read js/ui.js and confirm displayAlignmentResults accepts disfluencySummary parameter
2. Verify collapse banner is shown when safetyData.collapse.collapsed is true
3. Verify fluency summary shows severity-colored counts
  </verify>
  <done>WCPM displays as range with fluency summary below, collapse state shows warning banner</done>
</task>

<task type="auto">
  <name>Task 4: Wire computeWCPMRange and pass new parameters in app.js</name>
  <files>js/app.js</files>
  <action>
Update app.js to use computeWCPMRange and pass disfluencySummary/safetyData to displayAlignmentResults.

1. Add import for computeWCPMRange at top of file (around line 8, with other metrics imports):
```javascript
import { computeWCPM, computeAccuracy, computeWCPMRange } from './metrics.js';
```

2. Around line 587, replace computeWCPM call with computeWCPMRange:
```javascript
// Replace: const wcpm = computeWCPM(alignment, effectiveElapsedSeconds);
// With:
const wcpm = computeWCPMRange(alignment, effectiveElapsedSeconds);
```

3. Around line 610, update displayAlignmentResults call to pass disfluencySummary and safetyData:
```javascript
// Find the existing displayAlignmentResults call and add two parameters:
// disfluencyResult.summary (available from around line 220)
// safetyResult._safety (available from around line 245)

displayAlignmentResults(
  alignment,
  wcpm,
  accuracy,
  sttLookup,
  diagnostics,
  transcriptWords,
  tierBreakdown,
  disfluencyResult?.summary || null,   // NEW: disfluency counts by severity
  safetyResult?._safety || null        // NEW: collapse state and flags
);
```

Note: The disfluencyResult and safetyResult variables should already exist from the pipeline (Phase 14-15). Use optional chaining for graceful degradation on older assessments.
  </action>
  <verify>
1. grep "computeWCPMRange" js/app.js shows import and call
2. grep "disfluencyResult.*summary" js/app.js shows parameter being passed
3. grep "safetyResult.*_safety" js/app.js shows parameter being passed
  </verify>
  <done>app.js imports computeWCPMRange, calls it instead of computeWCPM, and passes disfluencySummary and safetyData to displayAlignmentResults</done>
</task>

</tasks>

<verification>
- [ ] style.css contains `.wcpm-container`, `.wcpm-primary`, `.wcpm-range`
- [ ] style.css contains `.fluency-summary` with severity color classes
- [ ] style.css contains `.collapse-banner` styling
- [ ] metrics.js exports `computeWCPMRange` function
- [ ] ui.js displayAlignmentResults handles wcpmMin/wcpmMax
- [ ] ui.js shows fluency summary with colored severity counts
- [ ] ui.js shows collapse banner when safetyData.collapse.collapsed is true
- [ ] app.js imports `computeWCPMRange` from metrics.js
- [ ] app.js calls `computeWCPMRange` instead of `computeWCPM`
- [ ] app.js passes disfluencyResult.summary to displayAlignmentResults
- [ ] app.js passes safetyResult._safety to displayAlignmentResults
</verification>

<success_criteria>
1. WCPM shows min value prominently (e.g., "85") with range below ("85-92 WCPM")
2. If wcpmMin equals wcpmMax, only single value is shown
3. Below WCPM, fluency summary shows "3 significant, 5 moderate, 8 minor" with appropriate colors
4. When collapse state is true, WCPM is hidden and warning banner appears
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-enhancements/16-03-SUMMARY.md`
</output>
