---
phase: 16-ui-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui.js
  - style.css
autonomous: true

must_haves:
  truths:
    - "Minor disfluency shows single yellow dot badge"
    - "Moderate disfluency shows double orange dot badge"
    - "Significant disfluency shows red warning icon badge"
    - "Badge position is superscript (top-right of word)"
    - "Hovering badge shows attempt trace (fragments)"
  artifacts:
    - path: "js/ui.js"
      provides: "Badge rendering in displayAlignmentResults"
      contains: "disfluency-badge"
    - path: "style.css"
      provides: "Badge positioning and severity colors"
      contains: "disfluency-badge"
  key_links:
    - from: "js/ui.js"
      to: "word.severity"
      via: "badge class selection"
      pattern: "severity.*minor|moderate|significant"
---

<objective>
Add disfluency severity badges to words showing stutter counts with visual hierarchy.

Purpose: Teachers see at a glance which words caused reading difficulty. Per CONTEXT.md: "eye skips over yellow dot, pauses on orange dots, stops at red icon"

Output: Badge elements on words with disfluency, styled by severity, with hover tooltip showing attempt trace.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ui-enhancements/16-CONTEXT.md
@.planning/phases/16-ui-enhancements/16-RESEARCH.md

@js/ui.js (displayAlignmentResults function)
@js/disfluency-detector.js (word.severity, word._disfluency data structure)
@style.css (existing word classes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disfluency badge CSS</name>
  <files>style.css</files>
  <action>
Add CSS classes for disfluency badges at end of file:

```css
/* Disfluency badges - superscript position (Phase 16) */
.word-with-disfluency {
  position: relative;
  display: inline-block;
}

.disfluency-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  font-size: 0.65rem;
  line-height: 1;
  z-index: 10;
  pointer-events: auto;
  cursor: help;
}

/* Severity colors per CONTEXT.md */
.disfluency-badge.minor { color: #ffc107; }      /* Yellow - single dot */
.disfluency-badge.moderate { color: #ff9800; }   /* Orange - double dot */
.disfluency-badge.significant { color: #f44336; } /* Red - warning icon */

/* Prevent badge crowding adjacent words */
.word-with-disfluency + .word {
  margin-left: 4px;
}
```

Per CONTEXT.md: "Badge position: superscript (top-right of word)" and "word keeps correctness color, badge has its own severity color"
  </action>
  <verify>grep "disfluency-badge" style.css returns badge classes with all three severity colors</verify>
  <done>CSS classes exist for badge positioning and severity colors (yellow/orange/red)</done>
</task>

<task type="auto">
  <name>Task 2: Render disfluency badges in displayAlignmentResults</name>
  <files>js/ui.js</files>
  <action>
Add helper function near buildNLTooltip (around line 65):

```javascript
/**
 * Build disfluency badge tooltip showing attempt trace.
 * Per CONTEXT.md: "Tooltip on disfluency badge should reveal the 'trace' (fragments)"
 */
function buildDisfluencyTooltip(word) {
  if (!word._disfluency) {
    return `${word.attempts || 1} attempt${word.attempts !== 1 ? 's' : ''}`;
  }

  const frags = word._disfluency.fragments || [];
  if (frags.length === 0) {
    return `${word.attempts} attempts`;
  }

  // Show trace: "Attempts: b, ba, ball"
  const trace = frags.map(f => f.word).join(', ');
  return `Attempts: ${trace}, ${word.word}`;
}

/**
 * Create disfluency badge element based on severity.
 * Per CONTEXT.md: minor=dot, moderate=double-dot, significant=warning
 */
function createDisfluencyBadge(word) {
  const severity = word.severity || 'none';
  if (severity === 'none') return null;

  const badge = document.createElement('span');
  badge.className = `disfluency-badge ${severity}`;

  // Badge content per CONTEXT.md
  const badges = {
    minor: '\u2022',           // • single dot
    moderate: '\u2022\u2022',  // •• double dot
    significant: '\u26A0\uFE0F' // ⚠️ warning icon
  };
  badge.textContent = badges[severity] || '';
  badge.title = buildDisfluencyTooltip(word);

  return badge;
}
```

In the word span building loop (around line 245-340), after creating span element but before appending to wordsDiv:

1. Check if word has severity !== 'none'
2. If so, wrap span in a container div with class 'word-with-disfluency'
3. Append badge to container
4. Append container instead of span directly

Find the existing pattern (approximately):
```javascript
wordsDiv.appendChild(span);
wordsDiv.appendChild(document.createTextNode(' '));
```

Replace with:
```javascript
// Get word data from sttLookup for disfluency info
const sttMeta = sttLookup?.get(hypKey)?.[0]; // Don't shift, just peek
const hasDisfluency = sttMeta?.severity && sttMeta.severity !== 'none';

if (hasDisfluency) {
  // Wrap word in container for badge positioning
  const container = document.createElement('span');
  container.className = 'word-with-disfluency';
  container.appendChild(span);

  const badge = createDisfluencyBadge(sttMeta);
  if (badge) container.appendChild(badge);

  wordsDiv.appendChild(container);
} else {
  wordsDiv.appendChild(span);
}
wordsDiv.appendChild(document.createTextNode(' '));
```

Note: The sttWord metadata needs to include severity from the disfluency detector. Check if it's passed through correctly from app.js. The word objects in transcriptWords should have .severity and ._disfluency from the pipeline.
  </action>
  <verify>
1. Read js/ui.js and confirm createDisfluencyBadge function exists
2. Verify badge classes use severity levels: minor, moderate, significant
3. Verify tooltip shows "Attempts: frag1, frag2, word" format
  </verify>
  <done>Words with disfluency show colored badges in superscript position with attempt trace on hover</done>
</task>

</tasks>

<verification>
- [ ] style.css contains `.disfluency-badge` with absolute positioning
- [ ] style.css contains severity colors: minor=yellow, moderate=orange, significant=red
- [ ] ui.js contains `createDisfluencyBadge` function
- [ ] ui.js contains `buildDisfluencyTooltip` function
- [ ] Badge shows dot(s) or warning icon based on severity
- [ ] Badge tooltip shows fragment trace
</verification>

<success_criteria>
1. Words with severity='minor' show single yellow dot in top-right
2. Words with severity='moderate' show double orange dots in top-right
3. Words with severity='significant' show red warning icon in top-right
4. Hovering badge shows "Attempts: b, ba, ball" trace
5. Badge color is independent of word correctness color
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-enhancements/16-02-SUMMARY.md`
</output>
