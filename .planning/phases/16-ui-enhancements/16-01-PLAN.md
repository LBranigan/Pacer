---
phase: 16-ui-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui.js
  - style.css
autonomous: true

must_haves:
  truths:
    - "Hovering a word shows both model results with timestamps"
    - "Timestamps show offset range AND duration"
    - "Flags appear as text list in tooltip"
    - "Rate anomaly words have dashed orange underline"
  artifacts:
    - path: "js/ui.js"
      provides: "Enhanced buildWordTooltip function"
      contains: "_debug"
    - path: "style.css"
      provides: "Rate anomaly CSS class"
      contains: "word-rate-anomaly"
  key_links:
    - from: "js/ui.js"
      to: "sttWord._debug"
      via: "tooltip content building"
      pattern: "_debug\\.latest|_debug\\.default"
---

<objective>
Extend word tooltips to show ensemble debug info (both model results) and flag rate anomaly words with dashed underline.

Purpose: Teachers see full diagnostic info on hover (per CONTEXT.md: "Full debug info visible to ALL teachers"). Rate anomalies are visually distinct from correctness colors.

Output: Enhanced word tooltip with timestamps/duration/model results/flags, plus CSS class for rate anomaly underline.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ui-enhancements/16-CONTEXT.md
@.planning/phases/16-ui-enhancements/16-RESEARCH.md

@js/ui.js (displayAlignmentResults function)
@style.css (existing word classes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate anomaly CSS class</name>
  <files>style.css</files>
  <action>
Add CSS class for rate anomaly visual indicator at end of file:

```css
/* Rate anomaly - dashed underline (Phase 16) */
.word-rate-anomaly {
  text-decoration: underline dashed;
  text-decoration-color: #e65100;
  text-underline-offset: 3px;
}
```

Per CONTEXT.md: "Rate anomaly flags use DIFFERENT visual: border/underline (dashed underline or dotted border), not badges"

Place after existing `.word-*` classes section.
  </action>
  <verify>grep "word-rate-anomaly" style.css returns the new class definition</verify>
  <done>CSS class exists with dashed orange underline styling</done>
</task>

<task type="auto">
  <name>Task 2: Extend tooltip with ensemble debug info</name>
  <files>js/ui.js</files>
  <action>
In `displayAlignmentResults()`, enhance the tooltip building logic to show:

1. Both model results with timestamps when `sttWord._debug` exists:
   - Format: `latest_long: "word" (85.3%) 0.50s-0.80s`
   - Format: `default: "word" (90.1%) 0.52s-0.78s`

2. Timestamps with duration (per CONTEXT.md):
   - Format: `Time: 0.50s - 0.80s (300ms)`

3. Flags as text list (per CONTEXT.md: "no icons in tooltip"):
   - Format: `Flags: rate_anomaly, ghost`

4. Apply `word-rate-anomaly` class when word has rate_anomaly flag

Create helper function `buildEnhancedTooltip(item, sttWord)` near line 46 (after buildNLTooltip):

```javascript
/**
 * Build enhanced tooltip with ensemble debug info.
 * Per CONTEXT.md: Full debug info visible to ALL teachers (not dev mode gated).
 */
function buildEnhancedTooltip(item, sttWord) {
  const lines = [];

  // Existing type info
  if (item.type === 'substitution') {
    lines.push(`Expected: ${item.ref}, Said: ${item.hyp}`);
  } else if (item.type === 'omission') {
    lines.push('Omitted (not read)');
  }

  // Timestamps with duration (per CONTEXT.md: "offset range AND duration")
  if (sttWord) {
    const start = parseSttTime(sttWord.startTime);
    const end = parseSttTime(sttWord.endTime);
    const durationMs = Math.round((end - start) * 1000);
    lines.push(`Time: ${start.toFixed(2)}s - ${end.toFixed(2)}s (${durationMs}ms)`);

    // Dual model info
    if (sttWord._debug) {
      if (sttWord._debug.latest) {
        const l = sttWord._debug.latest;
        const lStart = parseSttTime(l.startTime);
        const lEnd = parseSttTime(l.endTime);
        const conf = l.confidence != null ? (l.confidence * 100).toFixed(1) + '%' : '—';
        lines.push(`latest_long: "${l.word}" (${conf}) ${lStart.toFixed(2)}s-${lEnd.toFixed(2)}s`);
      }
      if (sttWord._debug.default) {
        const d = sttWord._debug.default;
        const dStart = parseSttTime(d.startTime);
        const dEnd = parseSttTime(d.endTime);
        const conf = d.confidence != null ? (d.confidence * 100).toFixed(1) + '%' : '—';
        lines.push(`default: "${d.word}" (${conf}) ${dStart.toFixed(2)}s-${dEnd.toFixed(2)}s`);
      }
    }
  }

  // Flags as text list (per CONTEXT.md: "no icons in tooltip")
  if (sttWord?._flags && sttWord._flags.length > 0) {
    lines.push(`Flags: ${sttWord._flags.join(', ')}`);
  }

  return lines.join('\n');
}
```

In the word span building loop (around line 245), update to:
1. Use new tooltip function
2. Add rate anomaly class when word._flags includes 'rate_anomaly'

Find where span.title is set and replace/enhance with:
- Call buildEnhancedTooltip instead of inline string building
- Add: `if (sttWord?._flags?.includes('rate_anomaly')) span.classList.add('word-rate-anomaly');`

The sttWord comes from the sttLookup map - follow existing pattern.
  </action>
  <verify>
1. Read js/ui.js and confirm buildEnhancedTooltip function exists
2. Verify it references _debug.latest and _debug.default
3. Verify word-rate-anomaly class is applied conditionally
  </verify>
  <done>Tooltip shows both model timestamps, flags as text, and rate anomaly words have dashed underline</done>
</task>

</tasks>

<verification>
- [ ] style.css contains `.word-rate-anomaly` with dashed underline
- [ ] ui.js contains `buildEnhancedTooltip` function
- [ ] Function accesses `_debug.latest` and `_debug.default`
- [ ] Function formats timestamps as "X.XXs - X.XXs (Xms)"
- [ ] Function shows flags as "Flags: flag1, flag2"
- [ ] Rate anomaly words get `.word-rate-anomaly` class
</verification>

<success_criteria>
1. Hovering any word shows timestamps with duration in "0.50s - 0.80s (300ms)" format
2. Words from ensemble show both model results with their individual timestamps
3. Words with _flags show them as text list
4. Words flagged with rate_anomaly have visible dashed orange underline
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-enhancements/16-01-SUMMARY.md`
</output>
