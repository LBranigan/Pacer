---
phase: 16-ui-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["16-01", "16-02", "16-03"]
files_modified:
  - index.html
  - js/app.js
  - style.css
autonomous: true

must_haves:
  truths:
    - "VAD calibration button is on Settings page area"
    - "VAD slider is hidden by default (dev mode only)"
    - "Calibration shows spinner with Calibrating text"
    - "Result shows noise level and threshold value"
    - "Dev mode toggle reveals slider for manual adjustment"
  artifacts:
    - path: "index.html"
      provides: "Dev mode gated slider"
      contains: "dev-mode-only"
    - path: "style.css"
      provides: "Dev mode CSS toggle"
      contains: "body.dev-mode"
  key_links:
    - from: "index.html"
      to: "style.css"
      via: "dev-mode-only class"
      pattern: "dev-mode-only"
---

<objective>
Restructure VAD calibration UI: move from main recording area to settings section, gate slider behind dev mode.

Purpose: Per CONTEXT.md: "Button location: Settings page" and "Dev mode only shows slider â€” normal users see noise level and threshold value, dev mode adds the slider"

Output: Clean calibration UI for teachers with dev mode toggle for advanced users.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ui-enhancements/16-CONTEXT.md
@.planning/phases/16-ui-enhancements/16-RESEARCH.md

@index.html (current VAD settings section)
@js/app.js (VAD wiring around line 803-868)
@style.css (current .vad-* classes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dev mode CSS toggle</name>
  <files>style.css</files>
  <action>
Add dev mode visibility classes at end of file:

```css
/* Dev mode toggle (Phase 16) */
.dev-mode-only {
  display: none !important;
}

body.dev-mode .dev-mode-only {
  display: block !important;
}

/* Dev mode toggle button */
.dev-mode-toggle {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: #666;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 0.4rem 0.8rem;
  font-size: 0.75rem;
  cursor: pointer;
  opacity: 0.6;
  z-index: 1000;
}

.dev-mode-toggle:hover {
  opacity: 1;
}

body.dev-mode .dev-mode-toggle {
  background: #7b1fa2;
  opacity: 1;
}

/* VAD calibration spinner (Phase 16) */
.vad-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #ccc;
  border-top-color: #1976d2;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-right: 0.5rem;
  vertical-align: middle;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
```

Per CONTEXT.md: "Dev mode only shows slider"
  </action>
  <verify>grep "dev-mode-only" style.css returns the visibility class</verify>
  <done>CSS classes exist for dev mode toggle and spinner animation</done>
</task>

<task type="auto">
  <name>Task 2: Restructure VAD settings in HTML</name>
  <files>index.html</files>
  <action>
Modify the VAD settings section (lines 27-47) to:
1. Keep calibration button and status visible to all
2. Wrap slider and presets in dev-mode-only class
3. Add dev mode toggle button at bottom of page
4. Update calibration status to support spinner

Replace the vadSettingsSection with:

```html
<div class="section" id="vadSettingsSection">
  <label>Ghost Detection Settings</label>
  <div class="vad-settings">
    <div class="vad-calibration">
      <button id="vadCalibrateBtn" title="Record 2 seconds of ambient noise to optimize detection">Calibrate Microphone</button>
      <span id="vadCalibrationStatus">Not calibrated (using default)</span>
    </div>
    <div class="vad-info" id="vadNoiseInfo" style="display:none;">
      <!-- Shown after calibration: "Noise Level: Low (0.20)" -->
    </div>
    <!-- Dev mode only: manual threshold control -->
    <div class="vad-threshold dev-mode-only">
      <label for="vadThresholdSlider">Manual Threshold: <span id="vadThresholdValue">0.375</span></label>
      <input type="range" id="vadThresholdSlider" min="0.15" max="0.60" step="0.01" value="0.375">
      <div class="vad-presets">
        <button class="vad-preset" data-threshold="0.20">Quiet Room</button>
        <button class="vad-preset" data-threshold="0.375">Normal</button>
        <button class="vad-preset" data-threshold="0.50">Noisy</button>
      </div>
    </div>
  </div>
</div>
```

Add dev mode toggle button just before closing </body> tag (after scripts):

```html
<!-- Dev mode toggle -->
<button class="dev-mode-toggle" id="devModeToggle" title="Toggle developer mode">Dev Mode</button>
```

Update version timestamp in #version element to current time.
  </action>
  <verify>grep "dev-mode-only" index.html returns the slider wrapper</verify>
  <done>Slider is wrapped in dev-mode-only class, dev toggle button exists</done>
</task>

<task type="auto">
  <name>Task 3: Wire dev mode toggle and update calibration UX</name>
  <files>js/app.js</files>
  <action>
Add dev mode toggle wiring at end of file (after VAD settings wiring, around line 868):

```javascript
// --- Dev mode toggle (Phase 16) ---
const devModeToggle = document.getElementById('devModeToggle');
if (devModeToggle) {
  // Check localStorage for saved dev mode state
  if (localStorage.getItem('orf_dev_mode') === 'true') {
    document.body.classList.add('dev-mode');
  }

  devModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dev-mode');
    const isDevMode = document.body.classList.contains('dev-mode');
    localStorage.setItem('orf_dev_mode', isDevMode);
  });
}
```

Update the calibration button handler (around line 812-838) to use spinner:

Find the existing vadCalibrateBtn event listener and update:

```javascript
if (vadCalibrateBtn) {
  vadCalibrateBtn.addEventListener('click', async () => {
    vadCalibrateBtn.disabled = true;
    // Show spinner per CONTEXT.md: "simple spinner with 'Calibrating...' text"
    vadCalibrationStatus.innerHTML = '<span class="vad-spinner"></span>Calibrating...';

    const result = await vadProcessor.calibrateMicrophone();

    if (result.error) {
      vadCalibrationStatus.textContent = `Error: ${result.error}`;
    } else {
      vadCalibrationStatus.textContent = 'Calibrated';

      // Update slider (for dev mode users)
      if (vadThresholdSlider) {
        vadThresholdSlider.value = result.threshold;
        vadThresholdValue.textContent = result.threshold.toFixed(2);
      }

      // Show noise info per CONTEXT.md: "Noise Level: Low (0.20)"
      vadNoiseInfo.style.display = 'block';
      vadNoiseInfo.textContent = `Noise Level: ${result.noiseLevel} (${result.threshold.toFixed(2)})`;
      vadNoiseInfo.className = 'vad-info' + (result.noiseLevel === 'High' ? ' high-noise' : '');

      // Per CONTEXT.md: subtle note for high noise
      if (result.noiseLevel === 'High') {
        vadNoiseInfo.innerHTML += '<br><small>Higher background noise detected</small>';
      }
    }

    vadCalibrateBtn.disabled = false;
  });
}
```

Note: The slider wiring (input event, presets) stays the same - it's just hidden unless dev mode is active.
  </action>
  <verify>
1. Read js/app.js and confirm devModeToggle event listener exists
2. Verify calibration shows spinner element
3. Verify dev mode persists to localStorage
  </verify>
  <done>Dev mode toggle works, calibration shows spinner, slider hidden unless dev mode active</done>
</task>

</tasks>

<verification>
- [ ] style.css contains `.dev-mode-only` with `display: none`
- [ ] style.css contains `body.dev-mode .dev-mode-only` override
- [ ] style.css contains `.vad-spinner` animation
- [ ] index.html has slider wrapped in `dev-mode-only` class
- [ ] index.html has dev mode toggle button
- [ ] app.js toggles `dev-mode` class on body
- [ ] app.js persists dev mode to localStorage
- [ ] Calibration button shows spinner during calibration
</verification>

<success_criteria>
1. VAD slider is hidden by default
2. Clicking dev mode toggle button reveals slider
3. Dev mode state persists across page reload
4. Calibration shows spinner with "Calibrating..." text
5. After calibration, noise level and threshold are visible to all users
6. Only dev mode users see the manual adjustment slider
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-enhancements/16-04-SUMMARY.md`
</output>
