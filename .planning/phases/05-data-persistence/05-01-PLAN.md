---
phase: 05-data-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/storage.js
  - index.html
  - style.css
autonomous: true

must_haves:
  truths:
    - "Storage module provides CRUD for students and assessments via clean API"
    - "HTML has student selector dropdown, add-student input, and history table container"
    - "Student profiles and assessments persist in localStorage under single key"
  artifacts:
    - path: "js/storage.js"
      provides: "localStorage CRUD for students and assessments"
      exports: ["getStudents", "addStudent", "deleteStudent", "saveAssessment", "getAssessments"]
    - path: "index.html"
      provides: "Student selector UI and history section"
      contains: "studentSelect"
    - path: "style.css"
      provides: "Styles for student selector and history table"
      contains: "student-bar"
  key_links:
    - from: "js/storage.js"
      to: "localStorage"
      via: "single orf_data key with version field"
      pattern: "localStorage\\.(get|set)Item.*orf_data"
---

<objective>
Create the storage module and HTML/CSS scaffolding for student profiles and assessment history.

Purpose: Establishes the data layer and UI elements that Plan 02 will wire together.
Output: js/storage.js with full CRUD API, index.html with student bar and history section, style.css with new styles.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-data-persistence/05-RESEARCH.md
@js/app.js
@index.html
@style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage.js module</name>
  <files>js/storage.js</files>
  <action>
Create js/storage.js as an ES module with all localStorage access behind a clean repository API.

Use a single localStorage key `orf_data` containing `{ version: 1, students: [], assessments: [] }`.

Internal helpers (not exported):
- `load()` -- JSON.parse from localStorage with try/catch, falls back to `defaultData()`
- `save(data)` -- JSON.stringify to localStorage with try/catch for QuotaExceededError
- `defaultData()` -- returns `{ version: 1, students: [], assessments: [] }`
- `migrate(data)` -- checks version field, sets to 1 if missing (future migration hook)

Exported functions:
- `getStudents()` -- returns students array
- `addStudent(name)` -- creates `{ id: crypto.randomUUID(), name: name.trim(), createdAt: new Date().toISOString() }`, pushes to students, saves, returns the new student
- `deleteStudent(id)` -- filters out student AND all assessments with that studentId (cascade delete), saves
- `saveAssessment(studentId, results)` -- creates record with `{ id: crypto.randomUUID(), studentId, date: new Date().toISOString(), passageText: results.passageText || '', wcpm: results.wcpm, accuracy: results.accuracy, alignment: results.alignment, diagnostics: results.diagnostics || null }`, pushes to assessments, saves, returns the record
- `getAssessments(studentId)` -- returns assessments filtered by studentId, sorted newest-first by date string comparison

Do NOT store audio blobs or raw STT responses. Only computed results.
  </action>
  <verify>Open browser console, run: `import('./js/storage.js').then(s => { const st = s.addStudent('Test'); console.log(s.getStudents()); const a = s.saveAssessment(st.id, {wcpm:{wcpm:85}, accuracy:{accuracy:92}}); console.log(s.getAssessments(st.id)); s.deleteStudent(st.id); console.log(s.getStudents(), s.getAssessments(st.id)); })` -- should show student created, assessment saved, then both removed after delete.</verify>
  <done>storage.js exports all 5 functions, data round-trips through localStorage, cascade delete works.</done>
</task>

<task type="auto">
  <name>Task 2: Add student selector and history HTML/CSS</name>
  <files>index.html, style.css</files>
  <action>
In index.html, add a new section BEFORE the "Audio Input" section (after Reference Passage). This is the student management bar:

```html
<div class="section student-bar">
  <label>Student</label>
  <div class="student-controls">
    <select id="studentSelect">
      <option value="">-- No Student (won't save) --</option>
    </select>
    <input type="text" id="newStudentName" placeholder="New student name">
    <button id="addStudentBtn">Add</button>
    <button id="deleteStudentBtn" style="background:#c62828;color:#fff;">Delete</button>
  </div>
</div>
```

After the existing "Alignment Results" section (at the end of body, before the scripts), add a history section:

```html
<div class="section" id="historySection" style="display:none;">
  <label>Assessment History</label>
  <div id="historyList">No student selected.</div>
</div>
```

In style.css, add styles:
- `.student-bar` -- no special styling needed beyond existing .section
- `.student-controls` -- flexbox row, gap 0.5rem, flex-wrap wrap, align-items center
- `#studentSelect` -- flex: 1, min-width: 150px, padding matching existing inputs
- `#newStudentName` -- flex: 0 1 180px, padding matching existing inputs
- `#addStudentBtn, #deleteStudentBtn` -- padding 0.5rem 1rem
- `#historyList table` -- width 100%, border-collapse collapse
- `#historyList th, #historyList td` -- padding 0.5rem, text-align left, border-bottom 1px solid #e0e0e0
- `#historyList th` -- font-weight 600, background #f5f5f5
  </action>
  <verify>Open index.html in browser. Student dropdown, name input, Add/Delete buttons visible. History section exists in DOM (hidden). No layout breakage.</verify>
  <done>Student selector bar appears between Reference Passage and Audio Input. History section exists in DOM. Styles applied. No JS wired yet.</done>
</task>

</tasks>

<verification>
- js/storage.js exists and exports getStudents, addStudent, deleteStudent, saveAssessment, getAssessments
- localStorage round-trip works (add student, save assessment, retrieve, delete with cascade)
- index.html has studentSelect, newStudentName, addStudentBtn, deleteStudentBtn, historySection, historyList elements
- style.css has student-controls and history table styles
- No existing functionality broken
</verification>

<success_criteria>
Storage module fully functional with all CRUD operations. HTML has all UI scaffolding for student management and history display. CSS styles applied. Ready for Plan 02 to wire everything together.
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-persistence/05-01-SUMMARY.md`
</output>
