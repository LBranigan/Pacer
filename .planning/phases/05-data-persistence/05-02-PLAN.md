---
phase: 05-data-persistence
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - js/app.js
  - js/ui.js
  - sw.js
autonomous: true

must_haves:
  truths:
    - "Teacher can create and select student profiles stored in localStorage"
    - "Completed assessments are saved and persist across browser sessions"
    - "Assessment history is viewable per student, showing all past assessments with dates and scores"
  artifacts:
    - path: "js/app.js"
      provides: "Storage wiring: student selector events, auto-save after analysis"
      contains: "saveAssessment"
    - path: "js/ui.js"
      provides: "renderStudentSelector and renderHistory functions"
      exports: ["renderStudentSelector", "renderHistory"]
    - path: "sw.js"
      provides: "Updated cache including storage.js"
      contains: "storage.js"
  key_links:
    - from: "js/app.js"
      to: "js/storage.js"
      via: "import and call saveAssessment after runAnalysis completes"
      pattern: "import.*storage"
    - from: "js/app.js"
      to: "js/ui.js"
      via: "calls renderStudentSelector and renderHistory on student change"
      pattern: "renderStudentSelector|renderHistory"
    - from: "js/ui.js"
      to: "DOM"
      via: "populates studentSelect dropdown and historyList table"
      pattern: "studentSelect|historyList"
---

<objective>
Wire storage into the app: student selector interactions, auto-save assessments after analysis, history display, and SW cache update.

Purpose: Connects the storage module and UI scaffolding from Plan 01 into a working feature.
Output: Fully functional student profiles and assessment history persisting across sessions.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-data-persistence/05-RESEARCH.md
@.planning/phases/05-data-persistence/05-01-SUMMARY.md
@js/app.js
@js/ui.js
@js/storage.js
@sw.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add renderStudentSelector and renderHistory to ui.js</name>
  <files>js/ui.js</files>
  <action>
Add two new exported functions to ui.js:

1. `renderStudentSelector(students, selectedId)`:
   - Gets `#studentSelect` element
   - Clears all options except first default option `-- No Student (won't save) --`
   - For each student, creates an `<option>` with value=student.id, text=student.name
   - If student.id matches selectedId, set `selected = true`

2. `renderHistory(assessments)`:
   - Gets `#historySection` and `#historyList` elements
   - If no student selected (assessments is null), hide historySection, set historyList text to "No student selected."
   - If assessments is empty array, show historySection, set historyList text to "No assessments yet."
   - If assessments has items, show historySection, build a table:
     - thead: Date | Passage | WCPM | Accuracy
     - For each assessment: `new Date(a.date).toLocaleDateString()` | first 30 chars of passageText + "..." | `a.wcpm?.wcpm ?? 'N/A'` | `(a.accuracy?.accuracy ?? 'N/A') + '%'`
   - Replace historyList innerHTML with the table

Keep all existing functions unchanged. Add the new functions at the end of the file.
  </action>
  <verify>Functions exist as exports in ui.js. No syntax errors (page loads without console errors).</verify>
  <done>ui.js exports renderStudentSelector and renderHistory. Existing display functions unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Wire storage into app.js and update SW cache</name>
  <files>js/app.js, sw.js</files>
  <action>
In app.js:

1. Add imports at top:
   ```
   import { getStudents, addStudent, deleteStudent, saveAssessment, getAssessments } from './storage.js';
   import { renderStudentSelector, renderHistory } from './ui.js';
   ```
   (renderStudentSelector and renderHistory are new imports; existing ui.js imports stay)

2. Add `selectedStudentId: null` to appState.

3. Create a `refreshStudentUI()` function that:
   - Calls `renderStudentSelector(getStudents(), appState.selectedStudentId)`
   - If selectedStudentId is set, calls `renderHistory(getAssessments(appState.selectedStudentId))`
   - Else calls `renderHistory(null)`

4. Wire student selector events (after existing event listeners, before OCR wiring):
   - `#studentSelect` change: set `appState.selectedStudentId` to select value (or null if empty), call refreshStudentUI()
   - `#addStudentBtn` click: get name from `#newStudentName`, if not empty after trim, call `addStudent(name)`, clear the input, set selectedStudentId to the new student's id, call refreshStudentUI()
   - `#deleteStudentBtn` click: if selectedStudentId is set, call `confirm('Delete this student and all their assessments?')`, if confirmed call `deleteStudent(appState.selectedStudentId)`, set selectedStudentId to null, call refreshStudentUI()

5. In runAnalysis(), after `displayAlignmentResults(...)` and before `setStatus('Done.')`:
   - If `appState.selectedStudentId` is set:
     - Call `saveAssessment(appState.selectedStudentId, { passageText: referenceText, wcpm, accuracy, alignment, diagnostics })`
     - Call `refreshStudentUI()` to update history
     - Append " (saved)" to status: `setStatus('Done (saved).')`

6. At the bottom of the file (after OCR wiring), call `refreshStudentUI()` to populate selector on page load.

In sw.js:
- Bump CACHE_NAME to 'orf-v3'
- Add './js/storage.js' to the SHELL array
- Add './js/alignment.js', './js/metrics.js', './js/diagnostics.js' to SHELL if not already present (they were added in prior phases but may be missing from cache list)
  </action>
  <verify>
1. Open app in browser, create a student "Test Student" via the Add button
2. Student appears in dropdown, is auto-selected
3. Record or upload audio, add reference text, click Analyze
4. Status shows "Done (saved)."
5. History table shows the assessment with date, WCPM, accuracy
6. Refresh the page -- student still in dropdown, history still shows assessment
7. Delete the student -- confirm dialog, student and history removed
8. Run assessment with no student selected -- status shows "Done." (no save)
  </verify>
  <done>Students persist in localStorage. Assessments auto-save on analysis completion when student is selected. History displays per student. Data survives page refresh. Cascade delete works. SW caches storage.js.</done>
</task>

</tasks>

<verification>
- Create student -> appears in dropdown
- Select student -> history section appears
- Run assessment with student selected -> "Done (saved)", history updates
- Refresh page -> student and assessment still present
- Run assessment without student -> "Done.", no save
- Delete student -> student and all assessments removed
- SW cache includes storage.js (check in DevTools > Application > Cache Storage)
</verification>

<success_criteria>
All three phase success criteria met:
1. Teacher can create and select student profiles stored in localStorage
2. Completed assessments are saved and persist across browser sessions
3. Assessment history is viewable per student, showing all past assessments with dates and scores
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-persistence/05-02-SUMMARY.md`
</output>
