---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - style.css
  - js/app.js
  - js/ui.js
  - js/recorder.js
  - js/file-handler.js
  - js/stt-api.js
autonomous: true

must_haves:
  truths:
    - "App loads in browser via local server and shows the same UI as the original monolith"
    - "Teacher can type or paste a reference passage into the text area"
    - "Record button captures mic audio and sends to STT, displaying word-level results"
    - "Upload button accepts audio files and sends to STT with correct encoding"
  artifacts:
    - path: "index.html"
      provides: "HTML shell with no inline JS or CSS"
      contains: "script type=\"module\""
    - path: "style.css"
      provides: "All styles extracted from original inline block"
    - path: "js/app.js"
      provides: "Entry module, imports and initializes all modules"
      exports: ["(init side effects)"]
    - path: "js/ui.js"
      provides: "DOM helpers: setStatus, displayResults"
      exports: ["setStatus", "displayResults"]
    - path: "js/recorder.js"
      provides: "MediaRecorder mic capture"
      exports: ["initRecorder"]
    - path: "js/file-handler.js"
      provides: "File upload with format detection"
      exports: ["initFileHandler"]
    - path: "js/stt-api.js"
      provides: "Google Cloud STT API call"
      exports: ["sendToSTT"]
  key_links:
    - from: "js/app.js"
      to: "js/ui.js, js/recorder.js, js/file-handler.js"
      via: "ES module imports"
      pattern: "import.*from.*\\./"
    - from: "js/recorder.js"
      to: "js/stt-api.js"
      via: "sendToSTT call after recording stops"
      pattern: "sendToSTT"
    - from: "js/file-handler.js"
      to: "js/stt-api.js"
      via: "sendToSTT call after file selected"
      pattern: "sendToSTT"
    - from: "index.html"
      to: "js/app.js"
      via: "script type=module src"
      pattern: "type=\"module\""
---

<objective>
Modularize the monolithic orf_assessment.html into ES modules with extracted CSS.

Purpose: Converts the 236-line single-file app into a clean module structure that all future phases build on. Preserves all existing functionality (mic recording, file upload, STT transcription, reference passage input).

Output: index.html + style.css + 5 JS modules in js/ directory. Original orf_assessment.html is kept as reference but no longer the entry point.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@orf_assessment.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract CSS and create HTML shell</name>
  <files>index.html, style.css</files>
  <action>
1. Create `style.css` with ALL styles from the inline `<style>` block in orf_assessment.html. Copy exactly, no changes to CSS rules.

2. Create `index.html` as a copy of orf_assessment.html with these changes:
   - Replace the inline `<style>...</style>` with `<link rel="stylesheet" href="style.css">`
   - Remove the entire `<script>...</script>` block
   - Add `<script type="module" src="js/app.js"></script>` before `</body>`
   - Remove ALL inline event handlers: `onclick="toggleRecord()"` from the record button, `onchange="handleFile(event)"` from the file input
   - Keep all HTML structure, IDs, and classes exactly the same
   - Add `<meta name="theme-color" content="#d32f2f">` to head (needed for PWA in Plan 02)

3. Do NOT delete orf_assessment.html. Keep it as reference.
  </action>
  <verify>Open index.html in a text editor and confirm: no `<style>` block, no `<script>` block (except the module import), no onclick/onchange attributes. style.css contains all original CSS rules.</verify>
  <done>index.html is a clean HTML shell linking to style.css and js/app.js. No inline JS or CSS. All original HTML structure preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Create ES modules from inline script</name>
  <files>js/app.js, js/ui.js, js/recorder.js, js/file-handler.js, js/stt-api.js</files>
  <action>
Create the `js/` directory and split the inline script into 5 modules. Reference the original orf_assessment.html for the exact logic.

**js/stt-api.js** - STT API communication:
- Export `async function sendToSTT(blob, encoding)` - takes blob and encoding string, reads API key from `document.getElementById('apiKey').value`, reads passage text from `document.getElementById('transcript').value` for speechContexts, calls Google Cloud STT REST API, returns parsed JSON response.
- Keep `blobToBase64` as a private function (not exported).
- Keep the exact same API request body structure: encoding, languageCode 'en-US', model 'latest_long', useEnhanced true, enableAutomaticPunctuation false, enableSpokenPunctuation false, enableWordTimeOffsets true, enableWordConfidence true, maxAlternatives 2, speechContexts.

**js/ui.js** - DOM helpers:
- Export `function setStatus(msg)` - sets status element textContent.
- Export `function displayResults(data)` - the exact displayResults function from the monolith. Renders word spans with confidence coloring (high/mid/low), plain text, JSON details, and alternative transcripts.

**js/recorder.js** - Mic recording:
- Import `{ sendToSTT }` from `./stt-api.js`
- Import `{ setStatus }` from `./ui.js`
- Keep `mediaRecorder`, `audioChunks`, `recording`, `timerInterval`, `seconds` as module-scoped variables (private).
- Export `function initRecorder()` - attaches click listener to `#recordBtn`. This replaces the old `onclick="toggleRecord()"`.
- Keep `toggleRecord`, `startRecording`, `stopRecording` as private functions. Exact same logic as original.
- In `mediaRecorder.onstop`, call `sendToSTT(blob, 'WEBM_OPUS')` and then call `displayResults` with the result. Import `{ displayResults }` from `./ui.js`.

**js/file-handler.js** - File upload:
- Import `{ sendToSTT }` from `./stt-api.js`
- Import `{ setStatus, displayResults }` from `./ui.js`
- Export `function initFileHandler()` - attaches change listener to `#fileInput`. This replaces the old `onchange="handleFile(event)"`.
- Keep `handleFile` as a private function. Same logic: detect encoding from extension (wav->LINEAR16, flac->FLAC, ogg->OGG_OPUS, webm->WEBM_OPUS, mp3->MP3), call sendToSTT, display results.

**js/app.js** - Entry point:
- Import `{ initRecorder }` from `./recorder.js`
- Import `{ initFileHandler }` from `./file-handler.js`
- Call `initRecorder()` and `initFileHandler()` on module load (modules execute after DOM is ready when loaded with `type="module"`).

IMPORTANT: The original `sendToSTT` function updates status via `setStatus()` calls. In the modular version, `stt-api.js` should import `{ setStatus }` from `./ui.js` and call it the same way: 'Sending to Google Cloud STT...' before the fetch, 'API Error: ...' on error, etc. The `recorder.js` onstop handler should call `setStatus('Processing...')` and then after getting STT results call `setStatus('Done.')` and `displayResults(data)`. Similarly `file-handler.js` should call `setStatus('Uploading filename...')` and after results `setStatus('Done.')` and `displayResults(data)`.

IMPORTANT: Make sure sendToSTT returns the data (or throws), so callers can handle display. Two approaches work:
  - Option A: sendToSTT handles status updates AND display internally (simpler, matches original flow)
  - Option B: sendToSTT returns data, callers handle display

Use Option A for minimal deviation from original: sendToSTT imports setStatus and displayResults from ui.js, handles the full flow including calling displayResults on success. Recorder and file-handler just call sendToSTT and don't need to handle the response. This matches the original monolith behavior exactly.
  </action>
  <verify>
Run from the project root:
```bash
npx serve . &
# Wait for server to start, then:
curl -s http://localhost:3000/ | grep 'type="module"'
curl -s http://localhost:3000/js/app.js | head -5
curl -s http://localhost:3000/js/stt-api.js | grep 'export'
```
Verify all 5 JS files exist, app.js imports from the other modules, and no syntax errors in module files. Kill the server after.

For a more thorough check, open http://localhost:3000 in a browser and verify:
- Page renders with correct styling
- No console errors about module imports
- Record button is clickable (asks for mic permission)
- Upload button opens file picker
  </verify>
  <done>Five ES modules in js/ directory. All original functionality preserved: mic recording, file upload with format detection, STT API calls with speech contexts, result display with confidence coloring. No inline event handlers, no global functions.</done>
</task>

</tasks>

<verification>
1. `index.html` has no inline `<style>` or `<script>` blocks (except module import)
2. `style.css` contains all original CSS rules
3. All 5 JS files exist in `js/` directory
4. `js/app.js` imports from all other modules
5. No `onclick` or `onchange` attributes in HTML
6. App loads without JS errors via `npx serve`
7. Reference passage textarea is present and functional
8. Record and Upload buttons have event listeners attached
</verification>

<success_criteria>
- The modularized app at index.html is functionally identical to orf_assessment.html
- Teacher can type/paste reference passage (INPT-01)
- Mic recording works (INPT-03)
- File upload with format detection works (INPT-04)
- Code is split into 5 ES modules with clean imports/exports (INFR-01)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
