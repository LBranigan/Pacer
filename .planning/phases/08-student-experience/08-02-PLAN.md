---
phase: 08-student-experience
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - student-playback.html
  - js/student-playback.js
  - css/student-playback.css
autonomous: true

must_haves:
  truths:
    - "Student can watch character hop word-by-word across highlighted passage in sync with audio"
    - "Character visibly battles at error words and words with long delays"
    - "Playback has play/pause controls and auto-advances through words"
  artifacts:
    - path: "student-playback.html"
      provides: "Student playback page"
      contains: "canvas"
    - path: "js/student-playback.js"
      provides: "Orchestrator: canvas + audio sync + character animation"
      exports: ["initStudentPlayback"]
    - path: "css/student-playback.css"
      provides: "Student playback styles"
  key_links:
    - from: "js/student-playback.js"
      to: "js/sprite-animator.js"
      via: "import SpriteAnimator"
      pattern: "import.*SpriteAnimator.*sprite-animator"
    - from: "js/student-playback.js"
      to: "js/audio-store.js"
      via: "getAudioBlob for playback"
      pattern: "getAudioBlob"
    - from: "js/student-playback.js"
      to: "alignment + sttWords"
      via: "URL params to load assessment data"
      pattern: "getAssessment"
---

<objective>
Build the student-facing animated playback page where a character hops across words in sync with audio, battling at error words.

Purpose: This is the core student experience -- STUD-01 and STUD-02. The character reacts to their reading performance in real-time as audio plays.
Output: student-playback.html, js/student-playback.js, css/student-playback.css
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-student-experience/08-RESEARCH.md
@.planning/phases/08-student-experience/08-01-SUMMARY.md
@js/audio-playback.js
@js/storage.js
@js/audio-store.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Student playback HTML page and CSS</name>
  <files>student-playback.html, css/student-playback.css</files>
  <action>
Create student-playback.html as a standalone page (same pattern as dashboard.html and report.html).

HTML structure:
- Title bar: "Your Reading Adventure!" with back button (links to index.html)
- Word area: a div#word-area that holds passage words as span elements. Words are styled large and readable (font-size 1.4rem, line-height 2.2 for character space above).
- Canvas overlay: a canvas#character-canvas positioned absolutely over #word-area using CSS. Same width/height as word-area. pointer-events: none so words underneath are still visible.
- Controls: Play/Pause button, a simple progress indicator (current word / total words)
- Feedback area: div#feedback-area (empty, used by Plan 03 for gamification display)

The page loads assessment data via URL params: ?student=ID&assessment=ID
Script tag: <script type="module" src="js/student-playback.js"></script>
Link: <link rel="stylesheet" href="css/student-playback.css">

CSS (css/student-playback.css):
- #word-area: position relative, padding 2rem, max-width 700px, margin auto, background white, border-radius 12px, box-shadow
- .word-span: display inline-block, padding 4px 6px, margin 2px, border-radius 4px, font-size 1.4rem, transition background 0.3s
- .word-span.active: background #E3F2FD (light blue highlight for current word)
- .word-span.correct-done: background #C8E6C9 (green, already passed correctly)
- .word-span.error-done: background #FFCDD2 (red, already passed with error)
- #character-canvas: position absolute, top 0, left 0, width 100%, height 100%, pointer-events none
- .playback-controls: text-align center, margin 1rem
- .play-btn: large friendly button, green, border-radius 50%, width 64px height 64px, font-size 1.5rem
- Body: background #F5F5F5, child-friendly feel, system font stack
  </action>
  <verify>Open student-playback.html in browser. Page loads without errors. Word area and canvas overlay are visible (canvas transparent over word area). Controls section visible.</verify>
  <done>student-playback.html renders a clean student-facing page with word area, canvas overlay, and controls</done>
</task>

<task type="auto">
  <name>Task 2: Audio-synced character animation engine</name>
  <files>js/student-playback.js</files>
  <action>
Create js/student-playback.js as the main orchestrator module.

Imports: SpriteAnimator from sprite-animator.js, getAudioBlob from audio-store.js, getAssessment/getStudent from storage.js.

Export: initStudentPlayback() called on DOMContentLoaded.

Flow:

1. Parse URL params (studentId, assessmentId). Load assessment via getAssessment(assessmentId). If not found, show "Assessment not found" message.

2. Extract alignment array and sttWords from assessment data. Build wordSequence: for each alignment entry (skip insertions for word display -- show ref words only as the "passage"), create an object:
   { text: entry.ref, type: entry.type, startTime, endTime, el: null }

   Map STT timings same way as audio-playback.js: maintain sttIdx, skip omissions (no spoken timing), advance for correct/substitution.

   Use the same parseTime helper as audio-playback.js (copy the function -- handles string "1.200s" and protobuf Duration objects).

3. Render word spans in #word-area. For each word in wordSequence, create a span.word-span, set textContent to word.text, append to #word-area. Store reference in word.el.

4. Set up canvas: get #character-canvas, size it to match #word-area dimensions using ResizeObserver. Get 2d context. Create SpriteAnimator instance.

5. Load audio: getAudioBlob(assessment.audioRef), create objectURL, set as Audio element src.

6. Play button: on click, start audio playback and begin animation loop.

7. Animation loop (requestAnimationFrame):
   - Get audioEl.currentTime
   - Find current word index: the word whose startTime <= currentTime < endTime. If between words, show character idle at last word position.
   - For current word, compute character position: get word.el.getBoundingClientRect() relative to canvas, position character centered above the word span (x = wordRect.left + wordRect.width/2 - canvas.offsetLeft, y = wordRect.top - canvas.offsetTop - 20).
   - Determine animation state:
     a) If transitioning to a new word (index changed), start a hop animation (300ms duration). Track hopStart timestamp. During hop, interpolate position from previous word to current word, call sprite.drawHop(x, y, hopPhase).
     b) If current word is type 'substitution' or 'omission', after hop completes start a battle animation (500ms). Call sprite.drawBattle(x, y, battlePhase). Also draw enemy via sprite.drawEnemy().
     c) If current word is correct and idle, call sprite.drawIdle(x, y).
   - Update word span classes: words before current get .correct-done or .error-done based on type. Current word gets .active. Future words stay unstyled.
   - Clear canvas each frame before drawing.
   - Update progress indicator text: "Word X of Y"

8. Handle long delays: if a word's startTime - previous word's endTime > 1.5s (diagnostic threshold), treat it as a struggle point -- draw battle animation during the gap period before the word.

9. On audio ended: clear canvas, show all words in final state, dispatch custom event 'playback-complete' (Plan 03 listens for this to show feedback).

10. Pause: stop audio, cancel rAF. Resume: play audio, restart rAF loop.

Key implementation notes:
- Canvas coordinates must be recalculated if window resizes (ResizeObserver already handles canvas sizing)
- Omission words in the passage get battle animation even though they have no timing -- trigger battle when audio time passes through the gap where the omission sits (use surrounding words' timing to estimate position)
- Keep animation simple: 30fps is fine for Chromebooks (use timestamp delta, don't skip frames)
  </action>
  <verify>
Open student-playback.html?student=STUDENT_ID&assessment=ASSESSMENT_ID (use real IDs from an existing assessment in localStorage). Click Play. Character should hop across words as audio plays. At error words, character should visibly battle. Words highlight as character passes.
  </verify>
  <done>Character hops word-by-word in sync with audio, battles at error/delay words, words highlight progressively</done>
</task>

</tasks>

<verification>
- student-playback.html loads without console errors
- Character animation syncs with audio playback (character on correct word)
- Error words trigger visible battle animation
- Play/Pause controls work
- Page is responsive and works on narrow screens
</verification>

<success_criteria>
- STUD-01 met: animated character hops word-by-word across highlighted passage in sync with audio
- STUD-02 met: character battles at words where student struggled
</success_criteria>

<output>
After completion, create `.planning/phases/08-student-experience/08-02-SUMMARY.md`
</output>
