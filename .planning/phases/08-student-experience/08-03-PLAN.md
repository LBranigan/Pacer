---
phase: 08-student-experience
plan: 03
type: execute
wave: 3
depends_on: ["08-01", "08-02"]
files_modified:
  - js/student-playback.js
  - css/student-playback.css
  - student-playback.html
  - js/storage.js
  - js/app.js
autonomous: false

must_haves:
  truths:
    - "Student sees points earned and streak count after playback"
    - "Progress ring shows improvement over past attempts"
    - "Student can access playback from main assessment flow"
  artifacts:
    - path: "js/student-playback.js"
      provides: "Gamification display integrated into playback page"
      contains: "computeScore"
    - path: "js/storage.js"
      provides: "v4 schema with gamification field on assessments"
      contains: "version: 4"
  key_links:
    - from: "js/student-playback.js"
      to: "js/gamification.js"
      via: "import computeScore"
      pattern: "import.*computeScore.*gamification"
    - from: "js/student-playback.js"
      to: "js/storage.js"
      via: "getAssessmentsForStudent for past scores"
      pattern: "getAssessmentsForStudent"
---

<objective>
Add gamified feedback (points, streaks, progress ring) to the student playback page and wire the entry point from the main app.

Purpose: STUD-03 -- after playback, students get motivating feedback showing their score and improvement. Also adds the navigation link so students can actually reach the playback page.
Output: Gamification UI in student-playback, storage v4 migration, entry point from app
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-student-experience/08-RESEARCH.md
@.planning/phases/08-student-experience/08-01-SUMMARY.md
@.planning/phases/08-student-experience/08-02-SUMMARY.md
@js/storage.js
@js/app.js
@js/gamification.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Storage v4 migration and gamification feedback UI</name>
  <files>js/storage.js, js/student-playback.js, css/student-playback.css, student-playback.html</files>
  <action>
**Storage migration (js/storage.js):**
Add v3 -> v4 migration in the migrate() function. For each assessment, add gamification field (null by default -- populated when student views playback). Update defaultData version to 4.

```
if (data.version === 3) {
  for (const a of data.assessments) {
    if (a.gamification === undefined) a.gamification = null;
  }
  data.version = 4;
}
```

Add exported function saveGamification(assessmentId, scoreData) that stores the computeScore result on the assessment record.

**Gamification feedback UI (js/student-playback.js):**
After Plan 02's playback engine, add gamification display that triggers on 'playback-complete' event (or when audio ends).

Import computeScore from gamification.js. Import getAssessmentsForStudent, saveGamification from storage.js.

On playback complete:
1. Compute score: computeScore(alignment, pastScores) where pastScores = past assessments' gamification.totalPoints (filter nulls).
2. Save score: saveGamification(assessmentId, score).
3. Show feedback panel in #feedback-area:

Feedback panel layout (inject into #feedback-area):
- Big animated score: "{totalPoints} points!" with count-up animation (0 to totalPoints over 1.5s using rAF)
- Streak badge: "Best Streak: {bestStreak} words in a row!" with a flame icon (CSS-drawn or emoji)
- Level indicator: "Level {level}" with star icons
- Progress ring (SVG): circular ring showing progress value.
  - SVG circle with stroke-dasharray/stroke-dashoffset technique.
  - Ring diameter 120px, stroke 8px. Green fill proportional to progress ratio.
  - Center text: improvement percentage (e.g., "+15%" or "First try!" if no past data).
- "Play Again" button that reloads the page, "Back" button to index.html.

**CSS additions (css/student-playback.css):**
- #feedback-area: text-align center, padding 2rem, display none initially, shown via .visible class
- .score-display: font-size 3rem, font-weight bold, color #4CAF50
- .streak-badge: font-size 1.2rem, background #FFF3E0, padding 8px 16px, border-radius 20px, display inline-block
- .level-display: font-size 1.1rem, color #666
- .progress-ring svg: width 120px height 120px
- .progress-ring circle: transition stroke-dashoffset 1.5s ease-in-out
- Count-up animation: use @keyframes or rAF-driven textContent update

**HTML update (student-playback.html):**
Ensure #feedback-area div exists (should already be there from Plan 02). No other HTML changes needed.
  </action>
  <verify>
Complete a playback on student-playback.html. After audio finishes, feedback panel should appear with points (count-up animation), streak badge, level, and progress ring. Refresh page and replay -- progress ring should show improvement ratio vs first attempt.
  </verify>
  <done>After playback, student sees animated score, streak, level, and progress ring. Scores persist to storage.</done>
</task>

<task type="auto">
  <name>Task 2: Wire entry point from main app</name>
  <files>js/app.js, index.html</files>
  <action>
After an assessment completes (student is selected and analysis finishes), add a "Watch Your Reading!" button that navigates to student-playback.html with the correct URL params.

In js/app.js, find where assessment results are displayed after analysis. Add a button/link:
- Text: "Watch Your Reading Adventure!"
- Style: large, green, friendly (add inline or class-based styles)
- onClick: window.location.href = `student-playback.html?student=${studentId}&assessment=${assessmentId}`
- Only show this button when a student is selected AND assessment has audioRef (audio was saved)

In index.html, no structural changes needed -- the button is dynamically added by app.js.

Also add a link in the student playback entries in dashboard.html if there's a natural place -- but only if dashboard already shows per-assessment actions. Check dashboard.html first. If it has a "play audio" button per assessment, add a "Student View" link next to it. If not, skip dashboard integration.
  </action>
  <verify>
1. Select a student, run an assessment, see results. "Watch Your Reading Adventure!" button should appear.
2. Click button -- should navigate to student-playback.html with correct params and playback works.
  </verify>
  <done>Students can access animated playback directly after completing an assessment</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete student experience: animated character playback with battles at error words, gamified feedback with points/streaks/progress ring, accessible from main assessment flow</what-built>
  <how-to-verify>
1. Go to index.html, select or create a student, enter a short passage, record audio reading it (deliberately mispronounce 1-2 words)
2. After assessment completes, click "Watch Your Reading Adventure!" button
3. On student-playback.html, click Play:
   - Verify character hops word-by-word in sync with audio
   - Verify words highlight as character passes (green for correct, red for errors)
   - Verify character battles/shakes at mispronounced words
4. After playback completes, verify feedback panel:
   - Points display with count-up animation
   - Streak badge showing best streak
   - Level indicator
   - Progress ring (shows "First try!" for first assessment)
5. Go back, do another assessment for same student, watch playback again
   - Progress ring should now show improvement percentage
6. Test Play/Pause controls work correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Storage migrates to v4 without data loss
- Gamification scores persist across sessions
- Progress ring accurately reflects improvement
- Entry point button only shows when student selected and audio available
- Full flow works: assess -> watch playback -> see feedback
</verification>

<success_criteria>
- STUD-03 met: points, streaks, progress ring displayed after playback
- Navigation: students can reach playback from assessment results
- Data: gamification scores saved to storage for progress tracking
</success_criteria>

<output>
After completion, create `.planning/phases/08-student-experience/08-03-SUMMARY.md`
</output>
