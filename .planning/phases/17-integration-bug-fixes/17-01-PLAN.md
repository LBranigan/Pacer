---
phase: 17-integration-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/ui.js
  - js/app.js
  - index.html
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Teacher tooltip shows latest_long model data when hovering words"
    - "WCPM range shows different min/max when words have moderate/significant disfluency"
    - "Assessment E2E flow displays correct ensemble data"
    - "Teacher Review flow shows ensemble data in tooltips"
  artifacts:
    - path: "js/ui.js"
      provides: "Tooltip with correct _debug.latestLong property reference"
      contains: "_debug.latestLong"
    - path: "js/app.js"
      provides: "Severity propagation to alignment items"
      contains: "item.severity = sttWord"
  key_links:
    - from: "js/ui.js"
      to: "word._debug.latestLong"
      via: "buildEnhancedTooltip function"
      pattern: "_debug\\.latestLong"
    - from: "js/app.js"
      to: "alignment items"
      via: "severity propagation after alignWords()"
      pattern: "alignment\\.forEach.*severity"
---

<objective>
Fix 2 critical integration bugs identified in v1.1-MILESTONE-AUDIT.md that prevent teacher tooltips from displaying ensemble data and cause WCPM range to always show equal min/max values.

Purpose: Complete v1.1 milestone by fixing wiring issues between phases (11->16 property mismatch, 14->metrics severity propagation)
Output: Working tooltip display and accurate WCPM range calculation
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.1-MILESTONE-AUDIT.md

# Affected source files
@js/ui.js
@js/app.js
@js/metrics.js
@js/ensemble-merger.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tooltip property mismatch in ui.js</name>
  <files>js/ui.js</files>
  <action>
In js/ui.js around line 139, change the property reference from `_debug.latest` to `_debug.latestLong`.

Current code (WRONG):
```javascript
if (sttWord._debug.latest) {
  const l = sttWord._debug.latest;
```

Change to (CORRECT):
```javascript
if (sttWord._debug.latestLong) {
  const l = sttWord._debug.latestLong;
```

This fixes the property name mismatch. Phase 11 (ensemble-merger.js:62) creates `word._debug.latestLong`, but Phase 16 was reading `word._debug.latest` which doesn't exist.

Also update the tooltip label from `latest_long:` to match the actual data being displayed (already correct, just verify).
  </action>
  <verify>
Search for "_debug.latest" in js/ui.js - should find ONLY "_debug.latestLong" references, no "_debug.latest" without the "Long" suffix.
  </verify>
  <done>Tooltip code references correct property name `_debug.latestLong` matching what ensemble-merger.js creates.</done>
</task>

<task type="auto">
  <name>Task 2: Propagate severity to alignment items in app.js</name>
  <files>js/app.js</files>
  <action>
In js/app.js, after the `alignWords()` call (around line 390), add severity propagation to alignment items.

Find this line:
```javascript
const alignment = alignWords(referenceText, transcriptWords);
```

Add this block immediately after:
```javascript
// Propagate severity from STT words to alignment items for WCPM range calculation
alignment.forEach(item => {
  if (item.hyp) {
    const sttWord = transcriptWords.find(w =>
      w.word?.toLowerCase() === item.hyp?.toLowerCase()
    );
    if (sttWord?.severity) {
      item.severity = sttWord.severity;
    }
  }
});
```

This ensures that alignment items (which originally only have `{ref, hyp, type}`) get the `severity` field that metrics.js:88 expects for WCPM range calculation.

The severity comes from Phase 14 disfluency detection which adds it to transcriptWords. This fix wires it through to the alignment items so computeWCPMRange can filter by severity.
  </action>
  <verify>
Search for "item.severity = sttWord" in js/app.js - should find the new propagation code.
  </verify>
  <done>Alignment items receive severity field from transcriptWords, enabling WCPM range to show different min/max when disfluencies exist.</done>
</task>

<task type="auto">
  <name>Task 3: Update version timestamp</name>
  <files>index.html</files>
  <action>
Update the version timestamp in index.html (the `#version` element) to reflect this bug fix.

Find the version element and update to current timestamp format: `v YYYY-MM-DD HH:MM`

This follows the project instruction from CLAUDE.md: "Whenever any update is made to the codebase, update the version timestamp at the top of index.html".
  </action>
  <verify>
Check that index.html contains updated version timestamp.
  </verify>
  <done>Version timestamp updated to reflect bug fix deployment.</done>
</task>

</tasks>

<verification>
1. Property fix verified: `grep "_debug.latest" js/ui.js` shows only `latestLong` references
2. Severity propagation verified: `grep "item.severity" js/app.js` shows propagation code
3. Version updated: index.html has current timestamp
4. No syntax errors: Open index.html in browser, check console for JS errors
</verification>

<success_criteria>
1. Teacher tooltip displays ensemble debug data (latest_long model confidence, timestamps) when hovering words
2. WCPM range shows different min/max values (e.g., 78-85) when words have moderate/significant disfluency severity
3. No JavaScript console errors
4. All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/17-integration-bug-fixes/17-01-SUMMARY.md`
</output>
