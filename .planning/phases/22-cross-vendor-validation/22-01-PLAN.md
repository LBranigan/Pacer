---
phase: 22-cross-vendor-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/reverb/server.py
  - services/reverb/requirements.txt
  - services/reverb/docker-compose.yml
autonomous: true
user_setup:
  - service: deepgram
    why: "Cross-validation ASR"
    env_vars:
      - name: DEEPGRAM_API_KEY
        source: "Deepgram Console -> Settings -> API Keys -> Create Key"
    dashboard_config:
      - task: "Create Deepgram account and generate API key"
        location: "https://console.deepgram.com/"

must_haves:
  truths:
    - "Backend /deepgram endpoint accepts base64 audio and returns word-level timestamps"
    - "Deepgram API key is loaded from environment variable, not hardcoded"
    - "Health endpoint reports deepgram_configured status"
    - "Missing API key returns 503 gracefully, not crash"
  artifacts:
    - path: "services/reverb/server.py"
      provides: "/deepgram endpoint and updated /health"
      contains: "@app.post(\"/deepgram\")"
    - path: "services/reverb/requirements.txt"
      provides: "Deepgram SDK dependency"
      contains: "deepgram-sdk"
    - path: "services/reverb/docker-compose.yml"
      provides: "DEEPGRAM_API_KEY environment passthrough"
      contains: "DEEPGRAM_API_KEY"
  key_links:
    - from: "services/reverb/server.py"
      to: "Deepgram API"
      via: "DeepgramClient SDK"
      pattern: "DeepgramClient"
    - from: "services/reverb/docker-compose.yml"
      to: "services/reverb/server.py"
      via: "environment variable"
      pattern: "DEEPGRAM_API_KEY.*\\$"
---

<objective>
Add Deepgram Nova-3 proxy endpoint to the existing Reverb backend service.

Purpose: Browser cannot call Deepgram REST API directly (no CORS support). Backend proxy solves this while keeping API key secure server-side.

Output: `/deepgram` endpoint that accepts base64 audio and returns normalized word-level timestamps from Nova-3.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cross-vendor-validation/22-RESEARCH.md

# Existing backend service
@services/reverb/server.py
@services/reverb/requirements.txt
@services/reverb/docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deepgram-sdk to requirements.txt</name>
  <files>services/reverb/requirements.txt</files>
  <action>
Add `deepgram-sdk>=3.0.0` to the requirements.txt file.

This is the official Deepgram Python SDK (v3) which handles authentication, retries, and response parsing.

Keep existing dependencies (fastapi, uvicorn, python-multipart, rev-reverb).
  </action>
  <verify>Run `grep deepgram-sdk services/reverb/requirements.txt` - should show the line</verify>
  <done>requirements.txt contains deepgram-sdk>=3.0.0</done>
</task>

<task type="auto">
  <name>Task 2: Add DEEPGRAM_API_KEY to docker-compose.yml</name>
  <files>services/reverb/docker-compose.yml</files>
  <action>
Add `DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}` to the environment section of the reverb service.

This passes the environment variable from the host to the container. The user will set this via:
- `export DEEPGRAM_API_KEY=$(cat keys/deepgram-api-key.txt)` before running docker-compose
- Or by creating a .env file

The key must NOT be hardcoded in the docker-compose.yml file.
  </action>
  <verify>Run `grep DEEPGRAM_API_KEY services/reverb/docker-compose.yml` - should show environment passthrough</verify>
  <done>docker-compose.yml passes DEEPGRAM_API_KEY from host environment to container</done>
</task>

<task type="auto">
  <name>Task 3: Add /deepgram endpoint and update /health</name>
  <files>services/reverb/server.py</files>
  <action>
Add Deepgram Nova-3 transcription endpoint to the existing server.py.

**Imports to add:**
```python
from deepgram import DeepgramClient, PrerecordedOptions
```

**Deepgram client singleton (add after existing _model singleton):**
```python
# Deepgram client singleton - initialized lazily
_deepgram_client = None

def get_deepgram_client():
    """Get or initialize Deepgram client. Returns None if not configured."""
    global _deepgram_client
    if _deepgram_client is None:
        api_key = os.environ.get("DEEPGRAM_API_KEY")
        if not api_key:
            return None  # Graceful degradation
        _deepgram_client = DeepgramClient(api_key)
    return _deepgram_client
```

**Request model (add after existing models):**
```python
class DeepgramRequest(BaseModel):
    """Request model for /deepgram endpoint."""
    audio_base64: str
```

**Update /health endpoint to report Deepgram status:**
Add `"deepgram_configured": get_deepgram_client() is not None` to the health response.

**Add /deepgram endpoint:**
```python
@app.post("/deepgram")
async def deepgram_transcribe(req: DeepgramRequest):
    """
    Transcribe audio using Deepgram Nova-3 via backend proxy.

    Returns normalized word-level timestamps matching project format.
    Browser cannot call Deepgram directly (no CORS support).
    """
    client = get_deepgram_client()
    if client is None:
        raise HTTPException(
            status_code=503,
            detail="Deepgram service not configured (missing DEEPGRAM_API_KEY)"
        )

    try:
        audio_bytes = base64.b64decode(req.audio_base64)
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Invalid base64: {e}")

    try:
        options = PrerecordedOptions(
            model="nova-3",
            language="en-US",
            smart_format=True,
        )

        response = client.listen.rest.v("1").transcribe_file(
            {"buffer": audio_bytes, "mimetype": "audio/wav"},
            options
        )

        # Normalize to project format (matching Google STT structure)
        words = []
        for word_data in response.results.channels[0].alternatives[0].words:
            words.append({
                "word": word_data.punctuated_word or word_data.word,
                "startTime": f"{word_data.start}s",
                "endTime": f"{word_data.end}s",
                "confidence": word_data.confidence
            })

        return {
            "words": words,
            "transcript": response.results.channels[0].alternatives[0].transcript,
            "model": "nova-3"
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Deepgram error: {e}")
```

**Important:**
- Do NOT hold gpu_lock for Deepgram calls (it's a network call, not GPU work)
- Do NOT pre-initialize Deepgram client at startup (lazy initialization allows graceful degradation)
- Response format matches existing project word format (startTime/endTime with "s" suffix)
  </action>
  <verify>
1. `grep -c "def get_deepgram_client" services/reverb/server.py` returns 1
2. `grep -c "@app.post.*deepgram" services/reverb/server.py` returns 1
3. `grep "deepgram_configured" services/reverb/server.py` shows health endpoint update
  </verify>
  <done>
- /deepgram endpoint accepts base64 audio, returns normalized words array
- /health endpoint reports deepgram_configured status
- Missing API key returns 503, not crash
- Deepgram client initialized lazily (not at startup)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Syntax check:** `python3 -m py_compile services/reverb/server.py` passes (or equivalent validation that file is valid Python)

2. **Requirements check:**
   ```bash
   grep "deepgram-sdk" services/reverb/requirements.txt
   ```

3. **Docker config check:**
   ```bash
   grep "DEEPGRAM_API_KEY" services/reverb/docker-compose.yml
   ```

4. **Endpoint exists check:**
   ```bash
   grep -E "@app\.(post|get).*deepgram" services/reverb/server.py
   ```

Note: Full integration testing (actually calling Deepgram API) happens after docker container is rebuilt with new requirements. User must provide API key before that test can pass.
</verification>

<success_criteria>
1. requirements.txt includes deepgram-sdk>=3.0.0
2. docker-compose.yml passes DEEPGRAM_API_KEY environment variable
3. server.py has /deepgram endpoint with Nova-3 transcription
4. server.py /health endpoint reports deepgram_configured status
5. All code is syntactically valid Python
6. No API keys hardcoded anywhere
</success_criteria>

<output>
After completion, create `.planning/phases/22-cross-vendor-validation/22-01-SUMMARY.md`
</output>
