---
phase: 22-cross-vendor-validation
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - js/deepgram-api.js
autonomous: true

must_haves:
  truths:
    - "Browser can send audio to Deepgram via backend and receive word-level results"
    - "Service availability can be checked before transcription"
    - "Unavailable Deepgram service returns null gracefully, not error"
    - "Cross-validation can flag words as confirmed or unconfirmed"
  artifacts:
    - path: "js/deepgram-api.js"
      provides: "Deepgram API client and cross-validation"
      exports: ["sendToDeepgram", "isDeepgramAvailable", "crossValidateWithDeepgram"]
      min_lines: 60
  key_links:
    - from: "js/deepgram-api.js"
      to: "http://localhost:8765/deepgram"
      via: "fetch POST"
      pattern: "fetch.*8765/deepgram"
    - from: "js/deepgram-api.js"
      to: "http://localhost:8765/health"
      via: "fetch GET"
      pattern: "fetch.*8765/health"
---

<objective>
Create browser client module for Deepgram Nova-3 API and cross-validation logic.

Purpose: Complete the browser-side integration for XVAL-01 (parallel cross-validation), XVAL-02 (disagreement flagging), and XVAL-03 (graceful fallback).

Output: `js/deepgram-api.js` ES module with sendToDeepgram(), isDeepgramAvailable(), and crossValidateWithDeepgram() functions.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-cross-vendor-validation/22-RESEARCH.md
@.planning/phases/22-cross-vendor-validation/22-01-SUMMARY.md

# Existing API client patterns
@js/stt-api.js

# Backend endpoint (from Plan 01)
@services/reverb/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deepgram-api.js with sendToDeepgram and isDeepgramAvailable</name>
  <files>js/deepgram-api.js</files>
  <action>
Create `js/deepgram-api.js` as an ES module following the established pattern from `js/stt-api.js`.

**File structure:**

```javascript
/**
 * Deepgram Nova-3 API Client
 *
 * Calls backend proxy at localhost:8765/deepgram (browser cannot call Deepgram directly - no CORS).
 * Provides cross-validation against Reverb ASR for hallucination detection.
 *
 * Requirements covered:
 * - XVAL-01: Deepgram Nova-3 called for cross-validation
 * - XVAL-03: Graceful fallback when service unavailable
 * - INTG-02: deepgram-api.js client calls Deepgram Nova-3 API
 */

const BACKEND_BASE_URL = 'http://localhost:8765';

/**
 * Convert blob to base64 string.
 * @param {Blob} blob - Audio blob
 * @returns {Promise<string>} Base64 encoded audio (without data URL prefix)
 */
function blobToBase64(blob) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}

/**
 * Check if Deepgram service is available and configured.
 * Uses /health endpoint to verify backend is running and has API key.
 *
 * @returns {Promise<boolean>} True if Deepgram is available
 */
export async function isDeepgramAvailable() {
  try {
    const resp = await fetch(`${BACKEND_BASE_URL}/health`, {
      method: 'GET',
      signal: AbortSignal.timeout(3000)
    });
    if (!resp.ok) return false;
    const data = await resp.json();
    return data.deepgram_configured === true;
  } catch {
    return false;
  }
}

/**
 * Send audio to Deepgram Nova-3 via backend proxy.
 *
 * Returns null on failure for graceful degradation (XVAL-03).
 * Cross-validation is optional - if Deepgram unavailable, proceed with Reverb-only.
 *
 * @param {Blob} blob - Audio blob (WAV, WebM, etc.)
 * @returns {Promise<object|null>} Response with words array, or null if unavailable
 */
export async function sendToDeepgram(blob) {
  try {
    const base64 = await blobToBase64(blob);

    const resp = await fetch(`${BACKEND_BASE_URL}/deepgram`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ audio_base64: base64 }),
      signal: AbortSignal.timeout(30000) // 30s timeout for transcription
    });

    if (!resp.ok) {
      console.warn(`[deepgram-api] Backend returned ${resp.status}`);
      return null;
    }

    return await resp.json();
  } catch (e) {
    console.warn('[deepgram-api] Service unavailable:', e.message);
    return null; // Graceful fallback - cross-validation is optional
  }
}

/**
 * Extract words array from Deepgram response.
 * @param {object|null} deepgramResponse - Response from sendToDeepgram
 * @returns {Array} Words array or empty array if null
 */
export function extractWordsFromDeepgram(deepgramResponse) {
  if (!deepgramResponse || !deepgramResponse.words) return [];
  return deepgramResponse.words;
}
```

**Key points:**
- Backend URL is `http://localhost:8765` (same as Reverb service)
- 30 second timeout for transcription (audio files can be long)
- 3 second timeout for health check (should be fast)
- Returns null on failure, not throw (graceful degradation per XVAL-03)
- Console.warn for debugging, not console.error (expected in fallback scenarios)
  </action>
  <verify>
1. `ls -la js/deepgram-api.js` shows file exists
2. `grep "export async function sendToDeepgram" js/deepgram-api.js` returns 1 match
3. `grep "export async function isDeepgramAvailable" js/deepgram-api.js` returns 1 match
  </verify>
  <done>
- js/deepgram-api.js exists as ES module
- sendToDeepgram() calls backend /deepgram endpoint
- isDeepgramAvailable() checks /health for deepgram_configured
- Returns null on failure (graceful degradation)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add crossValidateWithDeepgram function</name>
  <files>js/deepgram-api.js</files>
  <action>
Add the cross-validation function to `js/deepgram-api.js` (append after existing functions).

This implements XVAL-02: Reverb <-> Nova-3 disagreement flags words as uncertain.

```javascript
/**
 * Normalize word for comparison (lowercase, strip punctuation).
 * @param {string} word
 * @returns {string} Normalized word
 */
function normalizeWord(word) {
  return word.toLowerCase().replace(/[^a-z']/g, '');
}

/**
 * Cross-validate Reverb transcript against Deepgram Nova-3.
 *
 * Words present in both sources are marked "confirmed".
 * Words present only in Reverb are marked "unconfirmed" (potential hallucination).
 * If Deepgram unavailable, all words marked "unavailable".
 *
 * Implements XVAL-02: Reverb <-> Nova-3 disagreement flags words as uncertain.
 *
 * @param {Array} reverbWords - Words from Reverb ensemble (verbatim or clean)
 * @param {Array|null} deepgramWords - Words from Deepgram Nova-3, or null if unavailable
 * @returns {Array} Reverb words with crossValidation property added
 */
export function crossValidateWithDeepgram(reverbWords, deepgramWords) {
  // If Deepgram unavailable, mark all as unavailable (graceful degradation)
  if (!deepgramWords || deepgramWords.length === 0) {
    return reverbWords.map(word => ({
      ...word,
      crossValidation: 'unavailable'
    }));
  }

  // Build Deepgram word set for O(1) lookup
  const dgWordSet = new Set(
    deepgramWords.map(w => normalizeWord(w.word))
  );

  // Annotate each Reverb word with cross-validation status
  return reverbWords.map(word => {
    const normalized = normalizeWord(word.word);
    const inDeepgram = dgWordSet.has(normalized);

    return {
      ...word,
      crossValidation: inDeepgram ? 'confirmed' : 'unconfirmed'
    };
  });
}
```

**Cross-validation logic:**
- `confirmed`: Word appears in both Reverb and Deepgram (likely real)
- `unconfirmed`: Word appears only in Reverb (potential hallucination)
- `unavailable`: Deepgram service was unavailable (no cross-validation possible)

**Word matching:**
- Uses normalized comparison (lowercase, no punctuation)
- Does NOT use timestamps (different models have different timing)
- Simple set membership (word exists or not)

**Future enhancement opportunity:** Consider fuzzy matching for near-misses, but start with exact match per RESEARCH.md recommendation.
  </action>
  <verify>
1. `grep "export function crossValidateWithDeepgram" js/deepgram-api.js` returns 1 match
2. `grep "'confirmed'" js/deepgram-api.js` shows confirmation status
3. `grep "'unconfirmed'" js/deepgram-api.js` shows unconfirmed status
4. `grep "'unavailable'" js/deepgram-api.js` shows unavailable status
  </verify>
  <done>
- crossValidateWithDeepgram() compares Reverb vs Deepgram words
- Words in both sources get crossValidation: "confirmed"
- Words only in Reverb get crossValidation: "unconfirmed"
- Unavailable Deepgram results in crossValidation: "unavailable"
- Comparison is case-insensitive and ignores punctuation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File exists:**
   ```bash
   ls -la js/deepgram-api.js
   ```

2. **All exports present:**
   ```bash
   grep -c "export" js/deepgram-api.js
   # Should be at least 4 (sendToDeepgram, isDeepgramAvailable, extractWordsFromDeepgram, crossValidateWithDeepgram)
   ```

3. **Backend URL correct:**
   ```bash
   grep "localhost:8765" js/deepgram-api.js
   ```

4. **Graceful degradation:**
   ```bash
   grep "return null" js/deepgram-api.js
   # Should appear in sendToDeepgram for error cases
   ```

5. **Cross-validation statuses:**
   ```bash
   grep -E "'(confirmed|unconfirmed|unavailable)'" js/deepgram-api.js
   ```

Note: Full integration testing requires:
- Backend running with Deepgram API key configured
- Tested via browser console or integration test in Phase 23
</verification>

<success_criteria>
1. js/deepgram-api.js exists as valid ES module
2. sendToDeepgram(blob) calls backend /deepgram endpoint, returns words or null
3. isDeepgramAvailable() checks health endpoint for deepgram_configured
4. crossValidateWithDeepgram() annotates words with confirmed/unconfirmed/unavailable
5. Follows existing project patterns from js/stt-api.js
6. Graceful degradation - all functions handle errors without throwing
</success_criteria>

<output>
After completion, create `.planning/phases/22-cross-vendor-validation/22-02-SUMMARY.md`
</output>
