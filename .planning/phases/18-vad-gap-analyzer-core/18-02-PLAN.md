---
phase: 18-vad-gap-analyzer-core
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - js/app.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "After runDiagnostics, longPauses have _vadAnalysis property"
    - "After runDiagnostics, onsetDelays have _vadAnalysis property"
    - "Debug log shows vad_gap_analysis stage with label counts"
    - "Version timestamp is updated in index.html"
  artifacts:
    - path: "js/app.js"
      provides: "VAD gap analyzer integration"
      contains: "enrichDiagnosticsWithVAD"
    - path: "index.html"
      provides: "Updated version timestamp"
      contains: "v 2026-02"
  key_links:
    - from: "js/app.js"
      to: "js/vad-gap-analyzer.js"
      via: "import statement"
      pattern: "import.*from.*vad-gap-analyzer"
    - from: "js/app.js"
      to: "vadResult.segments"
      via: "enrichDiagnosticsWithVAD call"
      pattern: "enrichDiagnosticsWithVAD.*vadResult\\.segments"
    - from: "js/app.js"
      to: "debug-logger.js"
      via: "addStage call"
      pattern: "addStage\\('vad_gap_analysis'"
---

<objective>
Integrate VAD Gap Analyzer into the pipeline and add debug logging.

Purpose: Connects the VAD gap analyzer module to the main processing pipeline, enriching diagnostics with acoustic context and logging results for debugging.

Output: Updated app.js with VAD gap analysis integration, debug stage logging, and updated version timestamp.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-vad-gap-analyzer-core/18-01-SUMMARY.md
@js/app.js (pipeline integration point)
@js/vad-gap-analyzer.js (module to import)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import and integrate vad-gap-analyzer in app.js</name>
  <files>js/app.js</files>
  <action>
**1. Add import statement** (near other imports at top of file):
```javascript
import { enrichDiagnosticsWithVAD, computeVADGapSummary } from './vad-gap-analyzer.js';
```

**2. Add VAD gap analysis after diagnostics stage** (after line ~628, after `addStage('diagnostics', ...)` and before self-corrections processing):

```javascript
// VAD Gap Analysis - enrich diagnostics with acoustic context (Phase 18)
if (vadResult.segments && vadResult.segments.length > 0) {
  enrichDiagnosticsWithVAD(diagnostics, transcriptWords, vadResult.segments);

  // Debug logging (DBG-01)
  const vadGapSummary = computeVADGapSummary(diagnostics);
  addStage('vad_gap_analysis', {
    longPausesAnalyzed: vadGapSummary.longPausesAnalyzed,
    hesitationsAnalyzed: vadGapSummary.hesitationsAnalyzed,
    byLabel: {
      silenceConfirmed: vadGapSummary.silenceConfirmed,
      mostlySilent: vadGapSummary.mostlySilent,
      mixedSignal: vadGapSummary.mixedSignal,
      speechDetected: vadGapSummary.speechDetected,
      continuousSpeech: vadGapSummary.continuousSpeech
    }
  });
}
```

**Integration point location:**
- After: `addStage('diagnostics', { ... });` (around line 628)
- Before: `// Reclassify alignment entries that are part of self-corrections` (around line 630)

This ensures VAD analysis happens:
1. After diagnostics are computed (longPauses, onsetDelays exist)
2. Before self-correction processing (which may modify alignment)
3. While vadResult is still in scope (defined at line 282)

**Key variables available at this point:**
- `diagnostics` - from runDiagnostics() call at line 610
- `transcriptWords` - transcript words with timing
- `vadResult.segments` - VAD speech segments in milliseconds
- `addStage` - already imported from debug-logger.js
  </action>
  <verify>
1. Syntax check: `node --check js/app.js`
2. Grep for import: `grep -n "vad-gap-analyzer" js/app.js`
3. Grep for integration: `grep -n "enrichDiagnosticsWithVAD" js/app.js`
4. Grep for debug stage: `grep -n "vad_gap_analysis" js/app.js`
  </verify>
  <done>
- Import statement added for enrichDiagnosticsWithVAD, computeVADGapSummary
- Integration code placed after diagnostics stage, before self-correction processing
- Debug stage 'vad_gap_analysis' logs summary with byLabel counts
- app.js passes syntax check
  </done>
</task>

<task type="auto">
  <name>Task 2: Update version timestamp</name>
  <files>index.html</files>
  <action>
Update the version timestamp in the `#version` element near the top of index.html.

Find the element like:
```html
<span id="version">v 2026-02-04 XX:XX</span>
```

Update to current timestamp in format `v YYYY-MM-DD HH:MM`.

Per CLAUDE.md: "Whenever any update is made to the codebase, update the version timestamp at the top of `index.html`"
  </action>
  <verify>
`grep -n "id=\"version\"" index.html` shows updated timestamp with today's date.
  </verify>
  <done>
Version timestamp updated to reflect Phase 18 changes.
  </done>
</task>

</tasks>

<verification>
1. **Syntax verification:**
   ```bash
   node --check js/app.js
   ```

2. **Import verification:**
   ```bash
   grep "import.*vad-gap-analyzer" js/app.js
   ```
   Expected: import statement present

3. **Integration verification:**
   ```bash
   grep -A5 "enrichDiagnosticsWithVAD" js/app.js
   ```
   Expected: function call with diagnostics, transcriptWords, vadResult.segments

4. **Debug stage verification:**
   ```bash
   grep -A10 "addStage('vad_gap_analysis'" js/app.js
   ```
   Expected: stage with byLabel counts

5. **End-to-end test (manual):**
   - Open app in browser
   - Record a reading sample
   - Check browser console for "[VAD Gap] Enriched diagnostics"
   - Download debug log and verify vad_gap_analysis stage appears with counts
</verification>

<success_criteria>
- VAD-03: longPauses enriched with _vadAnalysis (via enrichDiagnosticsWithVAD call)
- VAD-04: onsetDelays enriched with _vadAnalysis (via enrichDiagnosticsWithVAD call)
- DBG-01: Debug log includes vad_gap_analysis stage with counts by acoustic label
- Version timestamp updated per CLAUDE.md requirements
- No syntax errors in app.js
</success_criteria>

<output>
After completion, create `.planning/phases/18-vad-gap-analyzer-core/18-02-SUMMARY.md`
</output>
