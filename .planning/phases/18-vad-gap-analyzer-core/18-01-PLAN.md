---
phase: 18-vad-gap-analyzer-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/vad-gap-analyzer.js
autonomous: true

must_haves:
  truths:
    - "calculateSpeechPercent returns 0-100% for any time range"
    - "getAcousticLabel maps percentages to correct labels"
    - "enrichDiagnosticsWithVAD adds _vadAnalysis to longPauses"
    - "enrichDiagnosticsWithVAD adds _vadAnalysis to onsetDelays"
    - "computeVADGapSummary returns counts by acoustic label"
  artifacts:
    - path: "js/vad-gap-analyzer.js"
      provides: "VAD gap analysis module"
      exports: ["calculateSpeechPercent", "getAcousticLabel", "enrichDiagnosticsWithVAD", "computeVADGapSummary", "ACOUSTIC_LABELS"]
      min_lines: 80
  key_links:
    - from: "js/vad-gap-analyzer.js"
      to: "diagnostics.longPauses"
      via: "_vadAnalysis property mutation"
      pattern: "pause\\._vadAnalysis"
    - from: "js/vad-gap-analyzer.js"
      to: "diagnostics.onsetDelays"
      via: "_vadAnalysis property mutation"
      pattern: "delay\\._vadAnalysis"
---

<objective>
Create the VAD Gap Analyzer module with core analysis functions.

Purpose: Enables analysis of VAD speech activity within pause/hesitation time ranges, providing acoustic context for diagnostic gaps.

Output: `js/vad-gap-analyzer.js` with all exported functions ready for app.js integration.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-vad-gap-analyzer-core/18-RESEARCH.md
@js/ghost-detector.js (overlap calculation pattern)
@js/diagnostics.js (longPauses, onsetDelays structure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vad-gap-analyzer.js module</name>
  <files>js/vad-gap-analyzer.js</files>
  <action>
Create a new ES6 module `js/vad-gap-analyzer.js` with the following components:

**1. ACOUSTIC_LABELS constant** (VAD-02):
```javascript
export const ACOUSTIC_LABELS = {
  SILENCE_CONFIRMED: { max: 10, label: 'silence confirmed' },
  MOSTLY_SILENT: { max: 29, label: 'mostly silent' },
  MIXED_SIGNAL: { max: 49, label: 'mixed signal' },
  SPEECH_DETECTED: { max: 79, label: 'speech detected' },
  CONTINUOUS_SPEECH: { max: 100, label: 'continuous speech' }
};
```

**2. calculateSpeechPercent(startMs, endMs, vadSegments)** (VAD-01):
- Calculate overlap between time range and VAD segments
- Return percentage 0-100, rounded to one decimal place
- Handle edge cases: rangeDuration <= 0 returns 0, empty segments returns 0
- Follow ghost-detector.js overlap pattern

**3. getAcousticLabel(speechPercent)** (VAD-02):
- Map percentage to acoustic label using thresholds:
  - <10%: silence confirmed
  - 10-29%: mostly silent
  - 30-49%: mixed signal
  - 50-79%: speech detected
  - >=80%: continuous speech
- Return the ACOUSTIC_LABELS object (has both `label` and `max` properties)

**4. parseTimeMs(t)** (private helper):
- Parse STT timestamp "1.400s" or number to milliseconds
- Follow diagnostics.js parseTime pattern but return ms not seconds

**5. enrichDiagnosticsWithVAD(diagnostics, transcriptWords, vadSegments)** (VAD-03, VAD-04):
- Check for empty/null vadSegments, return early if none
- Loop through diagnostics.longPauses:
  - Get afterWord and nextWord from transcriptWords
  - Calculate time range: afterWord.endTime to nextWord.startTime
  - Add `_vadAnalysis: { speechPercent, label }` to each pause
- Loop through diagnostics.onsetDelays:
  - Get word and prevWord from transcriptWords
  - Calculate time range: prevWord.endTime to word.startTime
  - Add `_vadAnalysis: { speechPercent, label }` to each delay
- Log "[VAD Gap] Enriched diagnostics with VAD analysis" on success
- Log "[VAD Gap] No VAD segments available, skipping enrichment" on skip

**6. computeVADGapSummary(diagnostics)** (DBG-01 support):
- Count items with _vadAnalysis by label category
- Return object with:
  - longPausesAnalyzed, hesitationsAnalyzed (counts)
  - silenceConfirmed, mostlySilent, mixedSignal, speechDetected, continuousSpeech (counts)

Follow codebase conventions:
- ES6 module with named exports
- JSDoc comments on all exported functions
- Underscore-prefix for mutation properties (_vadAnalysis)
- Console logging with [VAD Gap] prefix

Reference: 18-RESEARCH.md contains complete working code examples.
  </action>
  <verify>
Run syntax check: `node --check js/vad-gap-analyzer.js`

Verify exports exist:
```bash
node -e "import('./js/vad-gap-analyzer.js').then(m => console.log(Object.keys(m)))"
```
Expected output includes: calculateSpeechPercent, getAcousticLabel, enrichDiagnosticsWithVAD, computeVADGapSummary, ACOUSTIC_LABELS
  </verify>
  <done>
- js/vad-gap-analyzer.js exists with all 5 exported functions/constants
- Module passes syntax check
- calculateSpeechPercent handles edge cases (zero duration, empty segments)
- getAcousticLabel returns correct labels for boundary values
- enrichDiagnosticsWithVAD mutates diagnostics with _vadAnalysis properties
- computeVADGapSummary returns structured counts object
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit verification comments</name>
  <files>js/vad-gap-analyzer.js</files>
  <action>
Add inline verification examples as comments at the end of the module:

```javascript
/*
 * Manual Verification Examples:
 *
 * calculateSpeechPercent(0, 1000, [{start: 0, end: 500}]) => 50.0
 * calculateSpeechPercent(0, 1000, [{start: 250, end: 750}]) => 50.0
 * calculateSpeechPercent(0, 1000, []) => 0
 * calculateSpeechPercent(0, 0, [{start: 0, end: 500}]) => 0
 *
 * getAcousticLabel(0).label => 'silence confirmed'
 * getAcousticLabel(9.9).label => 'silence confirmed'
 * getAcousticLabel(10).label => 'mostly silent'
 * getAcousticLabel(29.9).label => 'mostly silent'
 * getAcousticLabel(30).label => 'mixed signal'
 * getAcousticLabel(80).label => 'continuous speech'
 */
```

This provides quick reference for expected behavior without adding test framework dependencies.
  </action>
  <verify>
Read end of js/vad-gap-analyzer.js and confirm verification examples are present.
  </verify>
  <done>
Module includes verification examples as comments documenting expected behavior for edge cases and boundary values.
  </done>
</task>

</tasks>

<verification>
1. `node --check js/vad-gap-analyzer.js` passes
2. Module exports 5 items: calculateSpeechPercent, getAcousticLabel, enrichDiagnosticsWithVAD, computeVADGapSummary, ACOUSTIC_LABELS
3. Console test of calculateSpeechPercent:
   ```bash
   node -e "import('./js/vad-gap-analyzer.js').then(m => console.log(m.calculateSpeechPercent(0, 1000, [{start: 0, end: 500}])))"
   ```
   Expected: 50
4. Console test of getAcousticLabel:
   ```bash
   node -e "import('./js/vad-gap-analyzer.js').then(m => console.log(m.getAcousticLabel(25).label))"
   ```
   Expected: "mostly silent"
</verification>

<success_criteria>
- VAD-01: calculateSpeechPercent works for any time range with correct percentage
- VAD-02: getAcousticLabel returns correct labels per threshold boundaries
- VAD-03/04 foundation: enrichDiagnosticsWithVAD function exists and is ready for integration
- DBG-01 foundation: computeVADGapSummary function exists and is ready for integration
- Module follows ES6 module conventions and codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/18-vad-gap-analyzer-core/18-01-SUMMARY.md`
</output>
