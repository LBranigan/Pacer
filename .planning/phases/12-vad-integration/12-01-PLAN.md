---
phase: 12-vad-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/vad-processor.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "VAD library loads successfully in browser without errors"
    - "VADProcessor class can process audio blob and return speech segments"
    - "Speech segments have start/end timestamps in milliseconds"
  artifacts:
    - path: "js/vad-processor.js"
      provides: "VADProcessor class with init(), processAudio(), setThreshold()"
      exports: ["vadProcessor", "VAD_THRESHOLD_DEFAULT", "VAD_THRESHOLD_MIN", "VAD_THRESHOLD_MAX", "VAD_PRESETS"]
    - path: "index.html"
      provides: "CDN script tags for onnxruntime-web and vad-web"
      contains: "cdn.jsdelivr.net/npm/onnxruntime-web"
  key_links:
    - from: "index.html"
      to: "vad global object"
      via: "CDN script tag for @ricky0123/vad-web"
      pattern: "vad-web.*bundle.min.js"
    - from: "js/vad-processor.js"
      to: "vad.NonRealTimeVAD"
      via: "global vad object from CDN"
      pattern: "vad\\.NonRealTimeVAD\\.new"
---

<objective>
Set up ONNX runtime and Silero VAD for browser-based voice activity detection.

Purpose: This is the foundation for Phase 12 - we need VAD running in the browser before we can detect ghost words or build calibration. This plan creates the core VADProcessor class that all other VAD functionality depends on.

Output: `js/vad-processor.js` module with VADProcessor class, CDN script tags in `index.html`
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-vad-integration/12-CONTEXT.md
@.planning/phases/12-vad-integration/12-RESEARCH.md

# Source files to reference
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CDN script tags for ONNX runtime and vad-web</name>
  <files>index.html</files>
  <action>
Add CDN script tags to index.html for onnxruntime-web and @ricky0123/vad-web. Place them in the head section after the CSS links and before any module scripts.

Use these exact CDN URLs from RESEARCH.md:
- `https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.wasm.min.js`
- `https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.29/dist/bundle.min.js`

Add a comment indicating these are for VAD ghost detection (Phase 12).

Also update the version timestamp in the #version element.
  </action>
  <verify>Open index.html in browser, check console for no script loading errors. Verify `window.vad` object exists by typing `vad` in console.</verify>
  <done>CDN scripts load without errors, `vad.NonRealTimeVAD` is available globally</done>
</task>

<task type="auto">
  <name>Task 2: Create VADProcessor class in vad-processor.js</name>
  <files>js/vad-processor.js</files>
  <action>
Create new ES module `js/vad-processor.js` with:

1. **Constants** (export these):
```javascript
export const VAD_THRESHOLD_DEFAULT = 0.375;  // Middle of range per CONTEXT.md
export const VAD_THRESHOLD_MIN = 0.15;
export const VAD_THRESHOLD_MAX = 0.60;
export const VAD_PRESETS = {
  quietRoom: 0.20,
  normal: 0.375,
  noisy: 0.50
};
```

2. **VADProcessor class** with:
   - `constructor()`: Initialize `isLoaded = false`, `loadError = null`, `threshold = VAD_THRESHOLD_DEFAULT`
   - `async init()`:
     - Try to create a test NonRealTimeVAD instance to verify ONNX loads
     - Set `isLoaded = true` on success
     - Catch errors and set `loadError = err.message`
     - Log `[VAD] Initialized successfully` or `[VAD] Failed to load: {error}`
   - `async processAudio(audioBlob)`:
     - If not loaded, return `{ segments: [], durationMs: 0, error: this.loadError || 'VAD not loaded' }`
     - Create AudioContext with `{ sampleRate: 16000 }` (Silero's expected rate)
     - Decode blob to AudioBuffer via `decodeAudioData()`
     - Get mono channel data via `getChannelData(0)`
     - Calculate duration in ms: `(audioData.length / sampleRate) * 1000`
     - Create NonRealTimeVAD instance with current threshold settings:
       - `positiveSpeechThreshold`: this.threshold
       - `negativeSpeechThreshold`: this.threshold - 0.10
       - `redemptionMs`: 200 (short for word-level detection)
       - `minSpeechMs`: 50 (allow short words)
       - `preSpeechPadMs`: 30
     - Iterate `for await (const { start, end } of vadInstance.run(audioData, sampleRate))`
     - Collect segments as `{ start, end }` (already in milliseconds)
     - Close AudioContext in finally block
     - Return `{ segments, durationMs, error: null }`
     - Catch errors and return `{ segments: [], durationMs: 0, error: err.message }`
   - `setThreshold(value)`: Clamp value to MIN/MAX range, update `this.threshold`
   - `getThreshold()`: Return current threshold

3. **Export singleton**:
```javascript
export const vadProcessor = new VADProcessor();
```

Per RESEARCH.md, do NOT hand-roll audio resampling or ONNX loading - the library handles this.
  </action>
  <verify>Create a test script that imports vadProcessor, calls init(), then calls processAudio() on a test audio blob. Verify segments array is returned.</verify>
  <done>VADProcessor class exports correctly, init() succeeds in browser, processAudio() returns speech segments array with start/end times</done>
</task>

</tasks>

<verification>
1. Load index.html in browser
2. Check console for no CDN loading errors
3. Type `vad` in console - should show the vad-web API object
4. Type `vad.NonRealTimeVAD` - should be a constructor function
5. Import vadProcessor in app.js (next plan will do full integration)
</verification>

<success_criteria>
- [x] onnxruntime-web CDN script loads (no console errors)
- [x] @ricky0123/vad-web CDN script loads (no console errors)
- [x] `window.vad.NonRealTimeVAD` is accessible
- [x] js/vad-processor.js exists with VADProcessor class
- [x] vadProcessor.init() completes without error
- [x] vadProcessor.processAudio(blob) returns { segments, durationMs, error }
- [x] Threshold constants exported correctly
</success_criteria>

<output>
After completion, create `.planning/phases/12-vad-integration/12-01-SUMMARY.md`
</output>
