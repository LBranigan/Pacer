---
phase: 12-vad-integration
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - js/vad-processor.js
  - js/ui.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Dedicated 'Calibrate Microphone' button exists in settings area"
    - "Calibration records 2 seconds of ambient noise"
    - "Calibration determines threshold in 0.15-0.60 range based on noise floor"
    - "UI shows calibrated threshold and noise level (Low/Moderate/High)"
    - "Slider with presets (Quiet Room/Normal/Noisy) allows manual threshold adjustment"
    - "Threshold resets to default (0.375) on page reload"
  artifacts:
    - path: "js/vad-processor.js"
      provides: "calibrateMicrophone() function"
      exports: ["vadProcessor", "VAD_THRESHOLD_DEFAULT", "VAD_THRESHOLD_MIN", "VAD_THRESHOLD_MAX", "VAD_PRESETS"]
    - path: "js/ui.js"
      provides: "VAD settings UI rendering functions"
      exports: ["renderVADSettings", "updateVADStatus"]
    - path: "index.html"
      provides: "VAD settings section with calibrate button, slider, presets"
      contains: "vadCalibrateBtn"
  key_links:
    - from: "index.html"
      to: "js/vad-processor.js"
      via: "calibrate button click calls vadProcessor.calibrateMicrophone()"
      pattern: "vadCalibrateBtn"
    - from: "index.html"
      to: "js/vad-processor.js"
      via: "threshold slider calls vadProcessor.setThreshold()"
      pattern: "vadThresholdSlider"
---

<objective>
Implement VAD calibration system with dedicated microphone calibration button and settings UI.

Purpose: Different environments have different ambient noise levels. Calibration measures the noise floor and sets an appropriate VAD threshold so ghost detection works reliably in classrooms, homes, or other settings. This plan implements requirements VAD-05, VAD-06, VAD-07.

Output: Calibration function in vad-processor.js, settings UI in index.html, UI helpers in ui.js
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-vad-integration/12-CONTEXT.md
@.planning/phases/12-vad-integration/12-RESEARCH.md

# Plan 01 created vad-processor.js
@.planning/phases/12-vad-integration/12-01-PLAN.md

# Source files
@js/vad-processor.js
@js/ui.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add calibrateMicrophone() to VADProcessor class</name>
  <files>js/vad-processor.js</files>
  <action>
Add calibration method to the VADProcessor class in vad-processor.js:

```javascript
/**
 * Calibrate microphone by recording 2 seconds of ambient noise.
 * Measures noise floor and sets threshold above it.
 * @returns {Promise<{threshold: number, noiseLevel: string, error: string|null}>}
 */
async calibrateMicrophone() {
  const CALIBRATION_DURATION_MS = 2000;  // Per CONTEXT.md: 2 seconds

  try {
    // Request microphone access
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // Record ambient noise
    const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    const chunks = [];

    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

    const recordingPromise = new Promise((resolve) => {
      mediaRecorder.onstop = () => {
        stream.getTracks().forEach(t => t.stop());
        resolve(new Blob(chunks, { type: 'audio/webm' }));
      };
    });

    mediaRecorder.start();
    await new Promise(r => setTimeout(r, CALIBRATION_DURATION_MS));
    mediaRecorder.stop();

    const silenceBlob = await recordingPromise;

    // Process silence to estimate noise floor
    const audioContext = new AudioContext({ sampleRate: 16000 });
    const arrayBuffer = await silenceBlob.arrayBuffer();
    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    const audioData = audioBuffer.getChannelData(0);

    // Use a very low threshold to detect any "speech-like" noise
    const testVad = await vad.NonRealTimeVAD.new({
      positiveSpeechThreshold: 0.05,  // Very low to catch noise
      negativeSpeechThreshold: 0.02,
      minSpeechMs: 20
    });

    // Count how many segments are detected during "silence"
    // More segments = noisier environment
    let segmentCount = 0;
    let totalSegmentDuration = 0;
    for await (const { start, end } of testVad.run(audioData, audioBuffer.sampleRate)) {
      segmentCount++;
      totalSegmentDuration += (end - start);
    }

    await audioContext.close();

    // Estimate noise level based on false positive detection
    // During 2 seconds of silence, we expect 0 segments in quiet environment
    const noiseRatio = totalSegmentDuration / CALIBRATION_DURATION_MS;

    let noiseLevel, calibratedThreshold;
    if (noiseRatio < 0.05 && segmentCount <= 1) {
      noiseLevel = 'Low';
      calibratedThreshold = 0.20;  // Can use lower threshold
    } else if (noiseRatio < 0.15 && segmentCount <= 3) {
      noiseLevel = 'Moderate';
      calibratedThreshold = 0.35;  // Default range
    } else {
      noiseLevel = 'High';
      calibratedThreshold = 0.50;  // Need higher threshold
    }

    // Clamp to valid range
    calibratedThreshold = Math.max(VAD_THRESHOLD_MIN, Math.min(VAD_THRESHOLD_MAX, calibratedThreshold));

    // Apply the calibrated threshold
    this.threshold = calibratedThreshold;
    this.noiseLevel = noiseLevel;
    this.isCalibrated = true;

    console.log(`[VAD] Calibrated: threshold=${calibratedThreshold.toFixed(2)}, noise=${noiseLevel}`);

    return {
      threshold: calibratedThreshold,
      noiseLevel: noiseLevel,
      error: null
    };

  } catch (err) {
    console.error('[VAD] Calibration failed:', err);
    return {
      threshold: this.threshold,
      noiseLevel: 'Unknown',
      error: err.message
    };
  }
}

/**
 * Get current calibration status.
 * @returns {{threshold: number, noiseLevel: string, isCalibrated: boolean}}
 */
getCalibrationStatus() {
  return {
    threshold: this.threshold,
    noiseLevel: this.noiseLevel || 'Default',
    isCalibrated: this.isCalibrated || false
  };
}
```

Also add these properties to the constructor:
```javascript
constructor() {
  this.isLoaded = false;
  this.loadError = null;
  this.threshold = VAD_THRESHOLD_DEFAULT;
  this.noiseLevel = null;      // Add this
  this.isCalibrated = false;   // Add this
}
```
  </action>
  <verify>Import vadProcessor, call calibrateMicrophone(), verify it records for 2 seconds and returns threshold + noiseLevel</verify>
  <done>calibrateMicrophone() records 2s ambient noise, calculates threshold based on noise floor, classifies as Low/Moderate/High</done>
</task>

<task type="auto">
  <name>Task 2: Add VAD settings section to index.html</name>
  <files>index.html</files>
  <action>
Add a new settings section for VAD calibration after the API key section (around line 21). Per CONTEXT.md: "Location: Settings/config area only - not visible during assessment".

```html
<div class="section" id="vadSettingsSection">
  <label>Ghost Detection Settings</label>
  <div class="vad-settings">
    <div class="vad-calibration">
      <button id="vadCalibrateBtn" title="Record 2 seconds of ambient noise to optimize detection">Calibrate Microphone</button>
      <span id="vadCalibrationStatus">Not calibrated (using default)</span>
    </div>
    <div class="vad-threshold">
      <label for="vadThresholdSlider">Detection Threshold: <span id="vadThresholdValue">0.375</span></label>
      <input type="range" id="vadThresholdSlider" min="0.15" max="0.60" step="0.01" value="0.375">
      <div class="vad-presets">
        <button class="vad-preset" data-threshold="0.20">Quiet Room</button>
        <button class="vad-preset" data-threshold="0.375">Normal</button>
        <button class="vad-preset" data-threshold="0.50">Noisy</button>
      </div>
    </div>
    <div class="vad-info" id="vadNoiseInfo" style="display:none;">
      <!-- Shown after calibration: "Noise Level: Low (0.20)" -->
    </div>
  </div>
</div>
```

Add CSS in style.css or inline styles:
```css
.vad-settings { display: flex; flex-direction: column; gap: 0.75rem; }
.vad-calibration { display: flex; align-items: center; gap: 1rem; }
.vad-calibration button { background: #1976d2; color: #fff; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
.vad-calibration button:disabled { background: #666; cursor: not-allowed; }
.vad-threshold { display: flex; flex-direction: column; gap: 0.25rem; }
.vad-threshold input[type="range"] { width: 200px; }
.vad-presets { display: flex; gap: 0.5rem; margin-top: 0.25rem; }
.vad-preset { padding: 0.3rem 0.6rem; border: 1px solid #666; border-radius: 4px; background: #2a2a2a; color: #ccc; cursor: pointer; font-size: 0.8rem; }
.vad-preset:hover { background: #3a3a3a; }
.vad-info { font-size: 0.9rem; color: #aaa; }
.vad-info.high-noise { color: #ffb74d; }
```

Update version timestamp.
  </action>
  <verify>Load page, verify VAD settings section appears with Calibrate button, slider, and preset buttons</verify>
  <done>VAD settings section in index.html with calibrate button, threshold slider (0.15-0.60), and preset buttons</done>
</task>

<task type="auto">
  <name>Task 3: Wire up VAD settings UI in app.js</name>
  <files>js/app.js</files>
  <action>
Add event listeners for VAD settings after the VAD initialization code (after vadProcessor.init()):

```javascript
// VAD Settings UI wiring (Phase 12)
const vadCalibrateBtn = document.getElementById('vadCalibrateBtn');
const vadCalibrationStatus = document.getElementById('vadCalibrationStatus');
const vadThresholdSlider = document.getElementById('vadThresholdSlider');
const vadThresholdValue = document.getElementById('vadThresholdValue');
const vadNoiseInfo = document.getElementById('vadNoiseInfo');
const vadPresetBtns = document.querySelectorAll('.vad-preset');

// Calibrate button
if (vadCalibrateBtn) {
  vadCalibrateBtn.addEventListener('click', async () => {
    vadCalibrateBtn.disabled = true;
    vadCalibrationStatus.textContent = 'Calibrating...';

    const result = await vadProcessor.calibrateMicrophone();

    if (result.error) {
      vadCalibrationStatus.textContent = `Error: ${result.error}`;
    } else {
      vadCalibrationStatus.textContent = `Calibrated. Noise level: ${result.noiseLevel}`;
      vadThresholdSlider.value = result.threshold;
      vadThresholdValue.textContent = result.threshold.toFixed(2);

      // Show noise info per CONTEXT.md format
      vadNoiseInfo.style.display = 'block';
      vadNoiseInfo.textContent = `Noise Level: ${result.noiseLevel} (${result.threshold.toFixed(2)})`;
      vadNoiseInfo.className = 'vad-info' + (result.noiseLevel === 'High' ? ' high-noise' : '');

      // Per CONTEXT.md: subtle note for high noise
      if (result.noiseLevel === 'High') {
        vadNoiseInfo.innerHTML += '<br><small>Higher background noise detected</small>';
      }
    }

    vadCalibrateBtn.disabled = false;
  });
}

// Threshold slider
if (vadThresholdSlider) {
  vadThresholdSlider.addEventListener('input', () => {
    const value = parseFloat(vadThresholdSlider.value);
    vadThresholdValue.textContent = value.toFixed(2);
    vadProcessor.setThreshold(value);
    // Per CONTEXT.md: "Calibration overrides manual" - mark as not calibrated when manually changed
    vadCalibrationStatus.textContent = `Manual: ${value.toFixed(2)}`;
    vadProcessor.isCalibrated = false;
  });
}

// Preset buttons
if (vadPresetBtns) {
  vadPresetBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const threshold = parseFloat(btn.dataset.threshold);
      vadThresholdSlider.value = threshold;
      vadThresholdValue.textContent = threshold.toFixed(2);
      vadProcessor.setThreshold(threshold);
      vadCalibrationStatus.textContent = `Preset: ${btn.textContent}`;
      vadProcessor.isCalibrated = false;
    });
  });
}
```

Note: Per CONTEXT.md "Persistence: Reset each session - threshold resets to default on page reload" - we don't need to persist the threshold, the default behavior handles this.
  </action>
  <verify>Click Calibrate - should record 2s then show noise level. Move slider - threshold value updates. Click preset - slider jumps to preset value.</verify>
  <done>VAD settings UI fully functional: calibrate records 2s and sets threshold, slider allows manual adjustment, presets set common values</done>
</task>

</tasks>

<verification>
1. Load page, verify VAD settings section visible
2. Click "Calibrate Microphone" button
3. Wait 2 seconds, verify "Calibrating..." appears during recording
4. Verify calibration result shows noise level and threshold
5. Move slider, verify threshold value updates in real-time
6. Click preset buttons, verify slider jumps to preset values
7. Reload page, verify threshold resets to default (0.375)
8. In high-noise environment, verify "Higher background noise detected" note appears
</verification>

<success_criteria>
- [x] Calibrate button records 2 seconds of ambient audio
- [x] Calibration result shows threshold (0.15-0.60) and noise level (Low/Moderate/High)
- [x] Noise level display format: "Noise Level: Low (0.23)"
- [x] Slider allows manual threshold adjustment 0.15-0.60
- [x] Preset buttons (Quiet Room/Normal/Noisy) set common threshold values
- [x] Calibration overrides manual settings
- [x] High noise shows subtle guidance note
- [x] Threshold resets to 0.375 on page reload
- [x] VAD settings in settings area, not visible during assessment
</success_criteria>

<output>
After completion, create `.planning/phases/12-vad-integration/12-04-SUMMARY.md`
</output>
