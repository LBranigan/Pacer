# Plan 10-01: Implement Tiered Speech Context Boosting

## Frontmatter

```yaml
phase: 10
plan: 01
wave: 1
depends_on: []
files_modified:
  - js/stt-api.js
autonomous: true
```

## Objective

Implement tiered speech context boosting that differentiates between word types:
- Proper nouns: highest boost (5 for latest_long, 3 for default)
- Uncommon/long words (8+ chars): medium boost (3 for latest_long, 2 for default)
- Common words: no boost (0)

This reduces phantom insertions from over-boosting common words the ASR already knows.

## Context

Current code in `js/stt-api.js` line 16-21:
```javascript
const speechContexts = [];
if (passageText) {
  const words = [...new Set(passageText.toLowerCase().replace(/[^a-z'\s-]/g, '').split(/\s+/).filter(Boolean))];
  if (words.length > 0) {
    speechContexts.push({ phrases: words, boost: 5 });
  }
}
```

This applies uniform boost=5 to ALL words. The plan implements tiered boosting per the ASR Ensemble research.

## Tasks

<task id="1">
<title>Create buildSpeechContexts helper function</title>
<type>code</type>
<file>js/stt-api.js</file>
<action>
Add a new helper function `buildSpeechContexts(passageText, options)` that:
1. Parses passage text into words
2. Categorizes words into: properNouns, uncommonWords, commonWords
3. Proper nouns: words that start with capital letter (not at sentence start)
4. Uncommon words: length >= 8 characters
5. Common words: everything else
6. Returns array of speechContext objects with tiered boost values
7. Uses options.baseBoost to scale boost values (default 3 for latest_long, 2 for default)

Implementation:
```javascript
/**
 * Build tiered speech contexts for phrase boosting.
 * @param {string} passageText - The reference passage
 * @param {object} options - { properNounBoost, uncommonBoost } explicit boost values
 * @returns {Array} speechContexts array for STT config
 */
function buildSpeechContexts(passageText, options = {}) {
  // Explicit boost values per model (no formula derivation)
  // latest_long: { properNounBoost: 5, uncommonBoost: 3 }
  // default:     { properNounBoost: 3, uncommonBoost: 2 }
  const { properNounBoost = 5, uncommonBoost = 3 } = options;
  if (!passageText) return [];

  const originalWords = passageText.split(/\s+/);
  const normalized = passageText.toLowerCase().replace(/[^a-z'\s-]/g, '').split(/\s+/).filter(Boolean);

  const properNouns = [];
  const uncommonWords = [];
  // Common words get NO boost - ASR already knows them

  for (let i = 0; i < originalWords.length; i++) {
    const orig = originalWords[i];
    const norm = normalized[i];
    if (!norm) continue;

    // Proper nouns: capitalized and not at sentence start
    // Check if previous word ended with sentence-ending punctuation
    const prevWord = i > 0 ? originalWords[i - 1] : '';
    const afterSentenceEnd = /[.!?]$/.test(prevWord);

    if (/^[A-Z]/.test(orig) && i > 0 && !afterSentenceEnd) {
      properNouns.push(norm);
    } else if (norm.length >= 8) {
      // Long words are likely domain-specific
      uncommonWords.push(norm);
    }
    // Common words: skip boosting entirely
  }

  const contexts = [];

  // Proper nouns: highest boost
  if (properNouns.length > 0) {
    contexts.push({ phrases: [...new Set(properNouns)], boost: properNounBoost });
  }

  // Uncommon words: medium boost
  if (uncommonWords.length > 0) {
    contexts.push({ phrases: [...new Set(uncommonWords)], boost: uncommonBoost });
  }

  // Common words: no boost (omitted entirely)

  return contexts;
}
```
</action>
</task>

<task id="2">
<title>Update buildSTTConfig to use tiered boosting</title>
<type>code</type>
<file>js/stt-api.js</file>
<action>
Modify `buildSTTConfig()` to:
1. Call `buildSpeechContexts()` instead of inline speechContexts creation
2. Use explicit boost values for latest_long: `{ properNounBoost: 5, uncommonBoost: 3 }`
3. Reduce maxAlternatives from 2 to 1 (alternatives useless without reliable confidence)

Replace lines 14-36 with updated buildSTTConfig that uses the new helper.
</action>
</task>

<task id="3">
<title>Add getDefaultModelConfig function for Phase 11</title>
<type>code</type>
<file>js/stt-api.js</file>
<action>
Export a new function `getDefaultModelConfig(encoding, passageText)` that returns config for the `default` model:
- model: 'default'
- baseBoost: 2 (lower than latest_long)
- maxAlternatives: 1
- Same other settings as latest_long

This prepares for Phase 11 ensemble but doesn't change current behavior.

```javascript
/**
 * Build STT config for the 'default' model (used as confidence oracle in ensemble).
 * Lower boost values to reduce phantom insertions.
 */
export function getDefaultModelConfig(encoding, passageText) {
  return {
    encoding: encoding,
    languageCode: 'en-US',
    model: 'default',
    useEnhanced: true,
    enableAutomaticPunctuation: false,
    enableSpokenPunctuation: false,
    enableWordTimeOffsets: true,
    enableWordConfidence: true,
    maxAlternatives: 1,
    speechContexts: buildSpeechContexts(passageText, { properNounBoost: 3, uncommonBoost: 2 })
  };
}
```
</action>
</task>

<task id="4">
<title>Update version timestamp</title>
<type>code</type>
<file>index.html</file>
<action>
Update the version timestamp in the #version element to reflect this change.
Format: v YYYY-MM-DD HH:MM
</action>
</task>

## Verification

After completing all tasks:

1. **Boost values correct:**
   - Proper nouns in passage should get boost 5 (for latest_long)
   - Long words (8+ chars) should get boost 3
   - Common words should NOT appear in speechContexts

2. **No regression:**
   - STT still works for a test passage
   - Word timestamps still returned
   - Confidence scores still returned

3. **Export available:**
   - `getDefaultModelConfig` is exported and callable

## must_haves

These are derived from the phase goal and must be TRUE after execution:

- [ ] `latest_long` boost level reduced from 5 to 3 for uncommon words (CFG-01)
- [ ] Proper nouns receive boost 5, uncommon words boost 3, common words boost 0 (CFG-02)
- [ ] `default` model config function exists with lower boost (proper nouns: 3, uncommon: 2) (CFG-03)

## Rollback

If issues arise, revert `js/stt-api.js` to previous version:
```bash
git checkout HEAD~1 -- js/stt-api.js
```
