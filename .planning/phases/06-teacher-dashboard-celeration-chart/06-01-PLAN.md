---
phase: 06-teacher-dashboard-celeration-chart
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/storage.js
  - js/audio-store.js
  - js/app.js
autonomous: true

must_haves:
  truths:
    - "Assessments save detailed error breakdown, alignment array, and STT word timestamps"
    - "Audio blobs persist in IndexedDB keyed by assessment ID"
    - "Old v1 assessments are migrated to v2 schema with null placeholders"
  artifacts:
    - path: "js/audio-store.js"
      provides: "IndexedDB wrapper for audio blob storage"
      exports: ["saveAudioBlob", "getAudioBlob", "deleteAudioBlob", "deleteAudioBlobsForStudent"]
    - path: "js/storage.js"
      provides: "Extended assessment schema with v2 migration"
      contains: "version === 1"
    - path: "js/app.js"
      provides: "Enriched saveAssessment call with alignment, sttWords, errorBreakdown, audioRef"
      contains: "errorBreakdown"
  key_links:
    - from: "js/app.js"
      to: "js/audio-store.js"
      via: "import saveAudioBlob"
      pattern: "saveAudioBlob"
    - from: "js/app.js"
      to: "js/storage.js"
      via: "saveAssessment with enriched payload"
      pattern: "errorBreakdown|alignment|sttWords|audioRef"
    - from: "js/storage.js"
      to: "js/audio-store.js"
      via: "deleteStudent cascades to audio cleanup"
      pattern: "deleteAudioBlobsForStudent"
---

<objective>
Extend the data persistence layer to store rich assessment data (alignment, STT timestamps, error breakdown) and audio blobs in IndexedDB, enabling the dashboard and audio playback features.

Purpose: All downstream dashboard features (error breakdown display, chart population, audio playback) depend on having richer assessment data persisted.
Output: Extended storage.js with v2 migration, new audio-store.js for IndexedDB blobs, enriched app.js save call.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-teacher-dashboard-celeration-chart/06-RESEARCH.md
@js/storage.js
@js/app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audio-store.js and extend storage.js schema to v2</name>
  <files>js/audio-store.js, js/storage.js</files>
  <action>
Create `js/audio-store.js` as an ES module with IndexedDB wrapper for audio blobs:
- Database name: `orf_audio`, object store: `blobs`
- `openDB()` internal helper that opens/creates the database (version 1)
- `saveAudioBlob(assessmentId, blob)` - stores blob keyed by assessmentId
- `getAudioBlob(assessmentId)` - retrieves blob by key, returns null if not found
- `deleteAudioBlob(assessmentId)` - deletes single blob
- `deleteAudioBlobsForStudent(assessmentIds)` - takes array of assessment IDs, deletes all their blobs in a single transaction
- All functions are async, export all four public functions

Extend `js/storage.js`:
- In `migrate()`, add v1->v2 migration: loop all assessments, add null for `errorBreakdown`, `alignment`, `sttWords`, `audioRef` if missing, set `data.version = 2`
- In `saveAssessment()`, add four new fields from results: `errorBreakdown` (object: {substitutions, omissions, insertions, details}), `alignment` (array of {ref, hyp, type}), `sttWords` (array of {word, startTime, endTime, confidence}), `audioRef` (string, assessment ID for IndexedDB lookup)
- In `deleteStudent()`, import `deleteAudioBlobsForStudent` from audio-store.js. Before removing assessments, collect their IDs, then call `deleteAudioBlobsForStudent(ids)`. Make `deleteStudent` async.
- Export a new function `getAssessment(assessmentId)` that returns a single assessment by ID (needed for dashboard detail view)
  </action>
  <verify>
Open browser console on the app page. Run:
1. Confirm `import('./js/audio-store.js')` resolves without error
2. Confirm `import('./js/storage.js')` resolves without error
3. If any existing orf_data in localStorage, verify it migrates to version 2 on load (check `JSON.parse(localStorage.getItem('orf_data')).version === 2`)
  </verify>
  <done>audio-store.js exports 4 functions, storage.js has v2 migration and enriched saveAssessment accepting all new fields, deleteStudent cascades to IndexedDB cleanup</done>
</task>

<task type="auto">
  <name>Task 2: Enrich app.js saveAssessment call with full assessment data</name>
  <files>js/app.js</files>
  <action>
In `js/app.js`, modify the `runAnalysis()` function's save block (around line 126-135):

1. Import `saveAudioBlob` from `./audio-store.js`
2. After the existing `saveAssessment` call, restructure to:
   - Build an `errorBreakdown` object from the `accuracy` result: `{ substitutions: accuracy.substitutions, omissions: accuracy.omissions, insertions: accuracy.insertions, details: alignment.filter(w => w.type !== 'correct') }`
   - Generate a preliminary assessment ID: `const assessmentId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6)`
   - If `appState.audioBlob` exists, call `await saveAudioBlob(assessmentId, appState.audioBlob)` to persist audio
   - Call `saveAssessment(appState.selectedStudentId, { ...existing fields..., errorBreakdown, alignment, sttWords: transcriptWords, audioRef: appState.audioBlob ? assessmentId : null, _id: assessmentId })`
   - In storage.js `saveAssessment`, if `results._id` is provided, use it as the assessment ID instead of generating a new one (so audio-store key matches)

Note: The `alignment` variable and `transcriptWords` array are already in scope at the save point. The `accuracy` object is also in scope with `.substitutions`, `.omissions`, `.insertions` properties (from computeAccuracy).
  </action>
  <verify>
1. Run the app, select a student, record/upload audio, provide reference text, click Analyze
2. After analysis completes, check localStorage: `JSON.parse(localStorage.getItem('orf_data')).assessments.slice(-1)[0]` should have non-null `errorBreakdown`, `alignment`, `sttWords`, and `audioRef` fields
3. Check IndexedDB: In DevTools > Application > IndexedDB > orf_audio > blobs, the assessment ID key should have a blob stored
  </verify>
  <done>Every new assessment saves alignment array, STT word timestamps, error breakdown object, and audio blob reference. Audio blob persists in IndexedDB.</done>
</task>

</tasks>

<verification>
1. Existing student/assessment CRUD still works (add student, run assessment, view history, delete student)
2. New assessments contain all enriched fields
3. Old assessments (if any) are migrated to v2 with null placeholders
4. Deleting a student also removes their audio blobs from IndexedDB
</verification>

<success_criteria>
- storage.js schema is version 2 with backward-compatible migration
- audio-store.js provides IndexedDB CRUD for audio blobs
- app.js persists full assessment payload including alignment, sttWords, errorBreakdown, audioRef
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-teacher-dashboard-celeration-chart/06-01-SUMMARY.md`
</output>
