---
phase: 23-kitchen-sink-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/reverb-api.js
  - js/kitchen-sink-merger.js
autonomous: true

must_haves:
  truths:
    - "Browser can check if Reverb service is available"
    - "Browser can send audio to Reverb and receive dual-pass transcripts"
    - "Pipeline orchestrates Reverb + Deepgram in parallel"
    - "Disfluencies are detected from verbatim/clean alignment"
    - "Cross-validation flags unconfirmed words"
    - "Google fallback activates when Reverb offline"
  artifacts:
    - path: "js/reverb-api.js"
      provides: "Reverb HTTP client"
      exports: ["isReverbAvailable", "sendToReverbEnsemble"]
      min_lines: 80
    - path: "js/kitchen-sink-merger.js"
      provides: "Kitchen Sink orchestrator"
      exports: ["runKitchenSinkPipeline", "isKitchenSinkEnabled", "setKitchenSinkEnabled"]
      min_lines: 150
  key_links:
    - from: "js/reverb-api.js"
      to: "http://localhost:8765/health"
      via: "fetch in isReverbAvailable"
      pattern: "fetch.*localhost:8765/health"
    - from: "js/reverb-api.js"
      to: "http://localhost:8765/ensemble"
      via: "fetch in sendToReverbEnsemble"
      pattern: "fetch.*localhost:8765/ensemble"
    - from: "js/kitchen-sink-merger.js"
      to: "js/reverb-api.js"
      via: "import sendToReverbEnsemble"
      pattern: "import.*from.*reverb-api"
    - from: "js/kitchen-sink-merger.js"
      to: "js/sequence-aligner.js"
      via: "import alignTranscripts"
      pattern: "import.*alignTranscripts.*from.*sequence-aligner"
    - from: "js/kitchen-sink-merger.js"
      to: "js/disfluency-tagger.js"
      via: "import tagDisfluencies"
      pattern: "import.*tagDisfluencies.*from.*disfluency-tagger"
    - from: "js/kitchen-sink-merger.js"
      to: "js/deepgram-api.js"
      via: "import crossValidateWithDeepgram"
      pattern: "import.*crossValidateWithDeepgram.*from.*deepgram-api"
---

<objective>
Create Reverb API client and Kitchen Sink orchestrator that combines Reverb dual-pass transcription with Deepgram cross-validation and sequence alignment for disfluency detection.

Purpose: Enable model-level disfluency detection (fillers, repetitions, false starts) via verbatimicity diff, with cross-vendor hallucination detection - the core capability of v1.3 Kitchen Sink Ensemble.

Output: Two ES modules - `reverb-api.js` for HTTP client and `kitchen-sink-merger.js` for pipeline orchestration.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-kitchen-sink-integration/23-RESEARCH.md

# Prior phase outputs this plan depends on
@.planning/phases/21-sequence-alignment-disfluency/21-01-SUMMARY.md
@.planning/phases/22-cross-vendor-validation/22-02-SUMMARY.md

# Existing modules to integrate with
@js/sequence-aligner.js
@js/disfluency-tagger.js
@js/deepgram-api.js
@js/ensemble-merger.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reverb-api.js HTTP client</name>
  <files>js/reverb-api.js</files>
  <action>
Create ES module `js/reverb-api.js` with Reverb ASR HTTP client.

**Requirements covered:** INTG-01

**Exports:**

1. `isReverbAvailable()` - Check if Reverb service is online
   - Fetch `http://localhost:8765/health` with 3-second timeout (AbortSignal.timeout)
   - Return `true` if response.ok AND data.status === 'ok' AND data.model_loaded === true
   - Return `false` on any error (catch block returns false, no throws)

2. `sendToReverbEnsemble(blob)` - Transcribe audio with dual-pass
   - Convert blob to base64 using FileReader (blobToBase64 helper)
   - POST to `http://localhost:8765/ensemble` with JSON body `{ audio_base64: base64 }`
   - Use 60-second timeout (long audio support)
   - Normalize Reverb word format to project conventions:
     - Reverb returns: `{ word, start_time (float), end_time (float), confidence }`
     - Project uses: `{ word, startTime ("X.XXs"), endTime ("X.XXs"), confidence }`
     - Keep BOTH formats: add startTime/endTime strings AND preserve start_time/end_time floats (needed for alignment)
   - Return `{ verbatim: { words, transcript, verbatimicity }, clean: { words, transcript, verbatimicity } }` on success
   - Return `null` on failure (graceful degradation)

**Helper functions (internal):**
- `blobToBase64(blob)` - Convert blob to base64 string (strip data URL prefix)
- `normalizeWord(w)` - Transform Reverb word format to project format

**Configurable URL:**
- `const REVERB_URL = window.REVERB_API_URL || 'http://localhost:8765';`

**Console logging:**
- Log warnings on failure: `[reverb-api] Backend returned ${status}` or `[reverb-api] Service unavailable: ${error}`

**Pattern to follow:** See deepgram-api.js for similar HTTP client pattern with graceful degradation.
  </action>
  <verify>
File exists and:
1. `grep -q "export.*isReverbAvailable" js/reverb-api.js` returns 0
2. `grep -q "export.*sendToReverbEnsemble" js/reverb-api.js` returns 0
3. `grep -q "localhost:8765/health" js/reverb-api.js` returns 0
4. `grep -q "localhost:8765/ensemble" js/reverb-api.js` returns 0
5. `grep -q "AbortSignal.timeout" js/reverb-api.js` returns 0
6. `grep -q "startTime.*s" js/reverb-api.js` returns 0 (timestamp format)
  </verify>
  <done>
reverb-api.js exports isReverbAvailable and sendToReverbEnsemble. Health check uses 3s timeout. Ensemble call uses 60s timeout. Word format normalized with both string and numeric timestamps. Returns null on failure for graceful degradation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create kitchen-sink-merger.js orchestrator</name>
  <files>js/kitchen-sink-merger.js</files>
  <action>
Create ES module `js/kitchen-sink-merger.js` that orchestrates the full Kitchen Sink pipeline.

**Requirements covered:** INTG-05

**Imports:**
```javascript
import { isReverbAvailable, sendToReverbEnsemble } from './reverb-api.js';
import { alignTranscripts } from './sequence-aligner.js';
import { tagDisfluencies, computeDisfluencyStats } from './disfluency-tagger.js';
import { sendToDeepgram, crossValidateWithDeepgram } from './deepgram-api.js';
import { sendEnsembleSTT } from './stt-api.js';
import { mergeEnsembleResults, computeEnsembleStats } from './ensemble-merger.js';
```

**Exports:**

1. `isKitchenSinkEnabled()` - Check feature flag
   - Read from localStorage key `'orf_use_kitchen_sink'`
   - Return true unless explicitly set to 'false' (enabled by default)

2. `setKitchenSinkEnabled(enabled)` - Set feature flag
   - Write to localStorage: 'true' or 'false'

3. `runKitchenSinkPipeline(blob, encoding, sampleRateHertz)` - Main orchestrator
   - **Step 0:** Check feature flag - if disabled, call runGoogleFallback immediately
   - **Step 1:** Check Reverb availability with isReverbAvailable()
   - **Step 2:** If unavailable, fall back to Google ensemble (runGoogleFallback)
   - **Step 3:** Run Reverb + Deepgram in parallel using Promise.allSettled
   - **Step 4:** If Reverb result is null, fall back to Google ensemble
   - **Step 5:** Align verbatim vs clean using alignTranscripts(verbatim.words, clean.words)
   - **Step 6:** Tag disfluencies using tagDisfluencies(alignment)
   - **Step 7:** Compute stats using computeDisfluencyStats(taggedAlignment)
   - **Step 8:** Build merged words from alignment using buildMergedWordsFromAlignment()
   - **Step 9:** Apply cross-validation using crossValidateWithDeepgram(mergedWords, deepgramWords)
   - **Step 10:** Return result object

4. `computeKitchenSinkStats(result)` - Compute statistics from result

**Internal functions:**

`buildMergedWordsFromAlignment(verbatimWords, taggedAlignment)`:
- Iterate through alignment entries
- Skip entries where type === 'deletion' (clean-only words)
- For each non-deletion entry, take verbatim word and add:
  - `isDisfluency: entry.type === 'insertion'`
  - `disfluencyType: entry.disfluencyType || null`
  - `_alignment: { type, verbatim, clean }` for debugging
- Track verbatim index separately (vIdx++) to avoid index mismatch

`runGoogleFallback(blob, encoding, sampleRateHertz)`:
- Get reference text from `document.getElementById('transcript')?.value || ''`
- Call sendEnsembleSTT(blob, encoding, sampleRateHertz)
- Call mergeEnsembleResults(ensembleResult, referenceText)
- Add placeholder properties to each word: `isDisfluency: false`, `disfluencyType: null`, `crossValidation: 'unavailable'`
- Return result object with `source: 'google_fallback'`

**Return structure for runKitchenSinkPipeline:**
```javascript
{
  words: validatedWords,           // Main output for downstream
  source: 'kitchen_sink',          // or 'google_fallback'
  reverb: reverb,                  // Raw Reverb response
  deepgram: deepgram,              // Raw Deepgram response (may be null)
  disfluencyStats: disfluencyStats,
  alignment: taggedAlignment,
  _debug: {
    reverbAvailable: true,
    deepgramAvailable: !!deepgram,
    verbatimWordCount: ...,
    cleanWordCount: ...,
    disfluenciesDetected: ...,
    disfluencyBreakdown: ...
  }
}
```

**Console logging:**
- `[kitchen-sink] Feature flag disabled, using Google ensemble`
- `[kitchen-sink] Reverb offline, falling back to Google ensemble`
- `[kitchen-sink] Reverb failed, falling back to Google ensemble`
- `[kitchen-sink] Pipeline complete: { verbatimWords, cleanWords, disfluencies, crossValidated }`

**Pattern to follow:** See ensemble-merger.js for similar merge and stats patterns.
  </action>
  <verify>
File exists and:
1. `grep -q "export.*runKitchenSinkPipeline" js/kitchen-sink-merger.js` returns 0
2. `grep -q "export.*isKitchenSinkEnabled" js/kitchen-sink-merger.js` returns 0
3. `grep -q "import.*alignTranscripts.*sequence-aligner" js/kitchen-sink-merger.js` returns 0
4. `grep -q "import.*tagDisfluencies.*disfluency-tagger" js/kitchen-sink-merger.js` returns 0
5. `grep -q "import.*crossValidateWithDeepgram.*deepgram-api" js/kitchen-sink-merger.js` returns 0
6. `grep -q "Promise.allSettled" js/kitchen-sink-merger.js` returns 0
7. `grep -q "orf_use_kitchen_sink" js/kitchen-sink-merger.js` returns 0
8. `grep -q "google_fallback" js/kitchen-sink-merger.js` returns 0
  </verify>
  <done>
kitchen-sink-merger.js exports runKitchenSinkPipeline, isKitchenSinkEnabled, setKitchenSinkEnabled, computeKitchenSinkStats. Pipeline runs Reverb + Deepgram in parallel, aligns verbatim/clean for disfluencies, cross-validates against Deepgram, and falls back to Google ensemble when Reverb unavailable. Feature flag stored in localStorage.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Module structure:** Both files are valid ES modules with correct import/export syntax
2. **Reverb client:** reverb-api.js can check health and send audio (tested in isolation)
3. **Pipeline orchestration:** kitchen-sink-merger.js imports all required dependencies
4. **Feature flag:** localStorage toggle works for A/B comparison
5. **Fallback path:** Google ensemble fallback correctly adds placeholder properties

Manual verification (requires Reverb service running):
```javascript
// In browser console
import { isReverbAvailable } from './js/reverb-api.js';
console.log('Reverb available:', await isReverbAvailable());
```
</verification>

<success_criteria>
1. `js/reverb-api.js` exists with 80+ lines and exports isReverbAvailable, sendToReverbEnsemble
2. `js/kitchen-sink-merger.js` exists with 150+ lines and exports runKitchenSinkPipeline, isKitchenSinkEnabled
3. All imports resolve (sequence-aligner, disfluency-tagger, deepgram-api, ensemble-merger, stt-api)
4. Feature flag defaults to enabled (returns true when localStorage empty)
5. Fallback path adds isDisfluency, disfluencyType, crossValidation to words
</success_criteria>

<output>
After completion, create `.planning/phases/23-kitchen-sink-integration/23-01-SUMMARY.md`
</output>
