---
phase: 23-kitchen-sink-integration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - js/app.js
  - index.html
autonomous: false

must_haves:
  truths:
    - "Analysis pipeline uses Kitchen Sink ensemble when enabled"
    - "Analysis pipeline falls back to Google ensemble when Reverb offline"
    - "Word array has isDisfluency, disfluencyType, crossValidation properties"
    - "Downstream components receive consistent word format"
    - "Teacher can toggle between Kitchen Sink and legacy Google ensemble"
  artifacts:
    - path: "js/app.js"
      provides: "Kitchen Sink pipeline integration"
      contains: "runKitchenSinkPipeline"
    - path: "index.html"
      provides: "Version timestamp update"
      contains: "#version"
  key_links:
    - from: "js/app.js"
      to: "js/kitchen-sink-merger.js"
      via: "import runKitchenSinkPipeline"
      pattern: "import.*runKitchenSinkPipeline.*from.*kitchen-sink-merger"
    - from: "js/app.js"
      to: "Kitchen Sink pipeline"
      via: "await runKitchenSinkPipeline"
      pattern: "await runKitchenSinkPipeline"
---

<objective>
Wire Kitchen Sink ensemble into the main analysis pipeline in app.js, replacing Google STT ensemble as the primary transcription source.

Purpose: Enable the full Kitchen Sink pipeline (Reverb + Deepgram + disfluency detection) for end-to-end reading fluency analysis, completing the v1.3 integration.

Output: Modified app.js that uses Kitchen Sink when enabled with automatic fallback to Google ensemble.
</objective>

<execution_context>
@/home/brani/.claude/get-shit-done/workflows/execute-plan.md
@/home/brani/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-kitchen-sink-integration/23-RESEARCH.md
@.planning/phases/23-kitchen-sink-integration/23-01-SUMMARY.md

# Files to modify
@js/app.js
@index.html

# New module to integrate
@js/kitchen-sink-merger.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Kitchen Sink pipeline into app.js</name>
  <files>js/app.js, index.html</files>
  <action>
Modify `js/app.js` to use Kitchen Sink ensemble as primary transcription source.

**Requirements covered:** INTG-06

**Step 1: Add import**
Add import at top of file (near other ensemble imports):
```javascript
import { runKitchenSinkPipeline, isKitchenSinkEnabled, computeKitchenSinkStats } from './kitchen-sink-merger.js';
```

**Step 2: Modify analysis flow**
Find the section where `sendEnsembleSTT` is called (around line 150-160, inside the `else` block after chunked STT check).

Replace the Google ensemble flow with Kitchen Sink:

BEFORE (approximately):
```javascript
setStatus('Running ensemble STT analysis...');
const ensembleResult = await sendEnsembleSTT(paddedAudioBlob, effectiveEncoding, sampleRateHertz);
// ... logging and error handling ...
const referenceText = document.getElementById('transcript').value.trim();
const mergedWords = mergeEnsembleResults(ensembleResult, referenceText);
const ensembleStats = computeEnsembleStats(mergedWords);
```

AFTER:
```javascript
// Run Kitchen Sink pipeline (Reverb + Deepgram + disfluency detection)
// Falls back to Google ensemble automatically when Reverb unavailable
setStatus('Running Kitchen Sink ensemble analysis...');
const kitchenSinkResult = await runKitchenSinkPipeline(paddedAudioBlob, effectiveEncoding, sampleRateHertz);

// Log result for debugging
console.log('[Pipeline] Kitchen Sink result:', {
  source: kitchenSinkResult.source,
  wordCount: kitchenSinkResult.words?.length || 0,
  disfluencies: kitchenSinkResult.disfluencyStats?.total || 0,
  _debug: kitchenSinkResult._debug
});

// Handle empty result
if (!kitchenSinkResult.words || kitchenSinkResult.words.length === 0) {
  setStatus('No speech detected. Please try again.');
  return;
}

// Extract words for downstream processing
const mergedWords = kitchenSinkResult.words;

// Compute stats based on source
const ensembleStats = kitchenSinkResult.source === 'kitchen_sink'
  ? computeKitchenSinkStats(kitchenSinkResult)
  : computeEnsembleStats(mergedWords);
```

**Step 3: Remove duplicate code**
After the Kitchen Sink integration point, ensure that the existing Google ensemble code paths are removed or bypassed. The Kitchen Sink pipeline handles the fallback internally.

**Step 4: Preserve downstream flow**
Ensure the rest of the pipeline (VAD ghost detection, alignment, diagnostics, etc.) continues to use `mergedWords` as before. The word format is consistent:
- `word`, `startTime`, `endTime`, `confidence` (existing)
- `isDisfluency`, `disfluencyType`, `crossValidation` (new, added by Kitchen Sink)
- `source` (existing from Google ensemble, preserved)

**Step 5: Update version timestamp**
Update `index.html` version element:
```html
<span id="version">v 2026-02-05 HH:MM</span>
```
Use current timestamp at execution time.

**Important considerations:**

1. **Do NOT remove Google ensemble imports** - they are still used by the fallback path inside kitchen-sink-merger.js

2. **Do NOT modify downstream code** - alignment.js, diagnostics.js, ui.js should work unchanged because word format is backward-compatible

3. **Keep existing logging** - The merged word debugging logs should continue to work

4. **Error handling** - Kitchen Sink returns empty words array on total failure, handle gracefully
  </action>
  <verify>
1. `grep -q "import.*runKitchenSinkPipeline.*kitchen-sink-merger" js/app.js` returns 0
2. `grep -q "await runKitchenSinkPipeline" js/app.js` returns 0
3. `grep -q "Kitchen Sink" js/app.js` returns 0 (status message)
4. `grep -q "computeKitchenSinkStats" js/app.js` returns 0
5. index.html version timestamp is updated to today's date
  </verify>
  <done>
app.js imports and uses runKitchenSinkPipeline as primary transcription source. Fallback to Google ensemble handled internally by kitchen-sink-merger.js. Downstream processing unchanged. Version timestamp updated.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Kitchen Sink Integration</name>
  <what-built>
Kitchen Sink ensemble integration into main analysis pipeline. When Reverb service is running, analysis uses Reverb + Deepgram with disfluency detection. When offline, falls back to Google ensemble with placeholder properties.
  </what-built>
  <how-to-verify>
**Test 1: Fallback behavior (Reverb offline)**
1. Ensure Reverb service is NOT running (stop Docker if running)
2. Open application in browser (http://localhost:8080 or file:///.../index.html)
3. Record or upload a short audio clip
4. Click Analyze
5. Expected: Status shows "Running Kitchen Sink ensemble analysis..."
6. Expected: Console shows `[kitchen-sink] Reverb offline, falling back to Google ensemble`
7. Expected: Analysis completes using Google ensemble
8. Expected: Merged words have `isDisfluency: false`, `crossValidation: 'unavailable'`

**Test 2: Feature flag toggle**
1. In browser console: `localStorage.setItem('orf_use_kitchen_sink', 'false')`
2. Refresh and run analysis
3. Expected: Console shows `[kitchen-sink] Feature flag disabled, using Google ensemble`
4. Reset: `localStorage.removeItem('orf_use_kitchen_sink')`

**Test 3: Kitchen Sink enabled (Reverb online) - if Phase 20 complete**
1. Start Reverb service: `cd services/reverb && docker-compose up`
2. Run analysis with audio containing disfluencies (um, uh, repeated words)
3. Expected: Console shows `[kitchen-sink] Pipeline complete: { ... disfluencies: N }`
4. Expected: Merged words have `isDisfluency: true` for detected disfluencies
5. Expected: Words have `crossValidation: 'confirmed'` or `'unconfirmed'`

**Test 4: Downstream compatibility**
1. Run analysis (either mode)
2. Verify alignment display works
3. Verify diagnostics panel populates
4. Verify WCPM calculation displays
5. Expected: No JavaScript errors in console
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Import added:** app.js imports runKitchenSinkPipeline from kitchen-sink-merger.js
2. **Pipeline wired:** Analysis flow calls runKitchenSinkPipeline instead of sendEnsembleSTT directly
3. **Stats computed:** Either computeKitchenSinkStats or computeEnsembleStats based on source
4. **Backward compatibility:** Downstream code (alignment, diagnostics, UI) works unchanged
5. **Version updated:** index.html version reflects today's date
</verification>

<success_criteria>
1. Kitchen Sink pipeline is the primary analysis path
2. Google ensemble fallback works when Reverb offline
3. Feature flag toggle works via localStorage
4. Word array includes isDisfluency, disfluencyType, crossValidation properties
5. No regression in existing functionality (alignment, diagnostics, WCPM)
6. Human verification confirms end-to-end integration
</success_criteria>

<output>
After completion, create `.planning/phases/23-kitchen-sink-integration/23-02-SUMMARY.md`
</output>
