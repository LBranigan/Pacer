<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#d32f2f">
<title>Oral Reading Fluency Assessment</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>

<h1>Oral Reading Fluency Assessment</h1>
<p class="subtitle">Google Cloud Speech-to-Text &mdash; Raw Verbatim Transcription</p>

<div class="section">
  <label for="apiKey">Google Cloud API Key</label>
  <input type="text" id="apiKey" placeholder="Enter your GCP API key (Speech-to-Text API must be enabled)">
</div>

<div class="section">
  <label for="transcript">Reference Passage (optional &mdash; for alignment comparison)</label>
  <textarea id="transcript" placeholder="Paste the passage the student will read aloud..."></textarea>
</div>

<div class="section">
  <label>Audio Input</label>
  <div class="controls">
    <button id="recordBtn">Record</button>
    <span class="timer" id="timer">0:00</span>
    <label id="uploadBtn" style="background:#1976d2;color:#fff;padding:0.6rem 1.4rem;border-radius:4px;font-weight:600;cursor:pointer;">
      Upload WAV
      <input type="file" id="fileInput" accept=".wav,.flac,.ogg,.mp3,.webm" style="display:none">
    </label>
  </div>
  <div id="status"></div>
</div>

<div class="section">
  <label>Alignment Results</label>
  <div class="legend">
    <span class="word-correct" title="Word spoken matches the reference text exactly.&#10;&#10;Logic: STT hypothesis equals reference word after normalization.&#10;&#10;Example: Reference 'cat' → Student says 'cat' → Correct">Correct</span>
    <span class="word-substitution" title="Student said a different word than the reference.&#10;&#10;Logic: Diff alignment finds a DELETE+INSERT pair at the same position — the reference word was replaced by a different spoken word. Counts as an error in accuracy calculation.&#10;&#10;Example: Reference 'house' → Student says 'horse' → Substitution">Substitution</span>
    <span class="word-omission" title="Student skipped a word from the reference text.&#10;&#10;Logic: Diff alignment finds a DELETE with no corresponding INSERT — the reference word has no matching spoken word. Counts as an error in accuracy calculation.&#10;&#10;Example: Reference 'the big dog' → Student says 'the dog' → 'big' is an omission">Omission</span>
    <span class="word-insertion" title="Student said a word not in the reference text.&#10;&#10;Logic: Diff alignment finds an INSERT with no corresponding DELETE — a spoken word has no match in the reference. Does NOT count as an error per ORF standards.&#10;&#10;Example: Reference 'the dog' → Student says 'the big dog' → 'big' is an insertion">Insertion</span>
    <span class="word-self-correction" title="Student repeated a word or phrase, indicating a self-correction attempt.&#10;&#10;Logic: Consecutive identical words (or 2-word phrases) in the STT transcript that are NOT legitimate repeats in the reference text. Checked via alignment mapping back to reference positions.&#10;&#10;Example: Student says 'the the the dog' → 'the' repeated twice → self-correction">Self-correction</span>
    <span class="pause-indicator" title="A long pause detected between consecutive words.&#10;&#10;Logic: Gap between one word's endTime and the next word's startTime exceeds a threshold. Base threshold is 3 seconds. After a comma, 600ms grace is added (threshold 3.6s). After a period, 1200ms grace is added (threshold 4.2s). Punctuation positions are determined by mapping hypothesis words back to reference text via alignment.&#10;&#10;Example: 'the' ends at 2.0s, 'dog' starts at 5.5s → 3.5s gap → flagged as pause">[pause]</span>
    <span class="word-onset-developing" style="padding:2px 8px;" title="Student hesitated before saying a word.&#10;&#10;Logic: Gap between previous word's endTime and this word's startTime. Three severity tiers:&#10;• Developing (orange border): 1.5s–3s gap&#10;• Flag (red border): 3s–5s gap&#10;• Frustration (purple border): 5s+ gap&#10;&#10;First word uses a 3s minimum threshold to avoid false positives from recording lead-in silence.&#10;&#10;Example: Previous word ends at 4.0s, next word starts at 6.2s → 2.2s gap → developing onset delay">Onset delay</span>
    <span class="word-morphological" style="padding:2px 8px;" title="Student said a word sharing the same root but with a wrong ending.&#10;&#10;Logic: All three conditions must be true:&#10;1. Word is already classified as a substitution&#10;2. Reference and spoken word share a 3+ character prefix&#10;3. STT confidence for the spoken word is below 0.8&#10;&#10;Example: Reference 'running' → Student says 'runned' → shared prefix 'run' (3 chars) + low confidence → morphological error">Morphological</span>
  </div>
  <div class="result-box" id="resultWords">Awaiting audio...</div>
  <label style="margin-top:1rem;">Metrics</label>
  <div class="result-box" id="resultPlain"></div>
  <label style="margin-top:1rem;">Details (JSON)</label>
  <div class="result-box" id="resultJson"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
<script type="module" src="js/app.js"></script>
</body>
</html>
