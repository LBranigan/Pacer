<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#d32f2f">
<title>Pacer â€” Fluency and Comprehension Training</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- VAD ghost detection (Phase 12): ONNX Runtime + Silero VAD -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.wasm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.29/dist/bundle.min.js"></script>
</head>
<body>

<div id="version" style="text-align:right;font-size:0.75rem;color:#999;">v 2026-02-14 06:20</div>
<h1>Pacer â€” Fluency and Comprehension Training</h1>
<p class="subtitle">Reverb + Parakeet &mdash; 3-Engine Consensus Pipeline</p>

<div class="section">
  <label for="apiKey">Google Cloud API Key</label>
  <input type="text" id="apiKey" placeholder="Enter your GCP API key (Speech-to-Text API must be enabled)">
</div>

<div class="section">
  <label for="geminiKey">Gemini API Key <span style="font-weight:normal;color:#999;">(free â€” for Movie Trailer â€” get from aistudio.google.com)</span></label>
  <input type="password" id="geminiKey" placeholder="Enter your Gemini API key">
</div>

<div class="section" id="backendSettingsSection">
  <label>Backend Connection</label>
  <div class="backend-settings">
    <div class="backend-field">
      <label for="backendUrl">Backend URL</label>
      <input type="text" id="backendUrl" placeholder="http://localhost:8765">
    </div>
    <div class="backend-field">
      <label for="backendToken">Auth Token (optional)</label>
      <input type="password" id="backendToken" placeholder="Leave blank for local use">
    </div>
    <div class="backend-status">
      <button id="backendTestBtn" type="button">Test Connection</button>
      <span id="backendStatusText"></span>
    </div>
    <div id="backendReloadNotice" style="display:none; color:#e65100; font-size:0.85rem; margin-top:0.25rem;">
      Reload required for changes to take effect.
      <button id="backendReloadBtn" type="button" style="margin-left:0.5rem; font-size:0.8rem; padding:0.2rem 0.6rem;">Reload Now</button>
    </div>
  </div>
</div>

<div class="section" id="vadSettingsSection">
  <label>Ghost Detection Settings</label>
  <div class="vad-settings">
    <div class="vad-calibration">
      <button id="vadCalibrateBtn" title="Record 5 seconds of ambient noise to optimize detection">Calibrate Microphone</button>
      <span id="vadCalibrationStatus">Not calibrated (using default)</span>
    </div>
    <div class="vad-info" id="vadNoiseInfo" style="display:none;">
      <!-- Shown after calibration: "Noise Level: Low (0.20)" -->
    </div>
    <!-- Dev mode only: manual threshold control -->
    <div class="vad-threshold dev-mode-only">
      <label for="vadThresholdSlider">Manual Threshold: <span id="vadThresholdValue">0.375</span></label>
      <input type="range" id="vadThresholdSlider" min="0.15" max="0.60" step="0.01" value="0.375">
      <div class="vad-presets">
        <button class="vad-preset" data-threshold="0.20">Quiet Room</button>
        <button class="vad-preset" data-threshold="0.375">Normal</button>
        <button class="vad-preset" data-threshold="0.50">Noisy</button>
      </div>
    </div>
  </div>
</div>

<div class="section dev-mode-only" id="xvalEngineSection">
  <label>Cross-Validator Engine</label>
  <div class="xval-engine-options">
    <label><input type="radio" name="xvalEngine" value="parakeet"> Parakeet TDT 0.6B v3</label>
    <label><input type="radio" name="xvalEngine" value="deepgram"> Deepgram Nova-3</label>
  </div>
</div>

<div class="section">
  <label>Book Page OCR (optional)</label>
  <div class="controls" style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
    <label id="ocrUploadBtn" style="background:#388e3c;color:#fff;padding:0.6rem 1.4rem;border-radius:4px;font-weight:600;cursor:pointer;">
      ðŸ“· Photograph / Upload Page
      <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none">
    </label>
    <div class="ocr-engine-toggle" style="display:inline-flex;align-items:center;gap:0.4rem;font-size:0.85rem;">
      <span id="ocrEngineLabel" style="color:#666;">Cloud Vision</span>
      <label style="position:relative;display:inline-block;width:40px;height:22px;margin:0;">
        <input type="checkbox" id="ocrEngineToggle" style="opacity:0;width:0;height:0;">
        <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;border-radius:22px;transition:0.3s;" id="ocrToggleTrack"></span>
        <span style="position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:0.3s;box-shadow:0 1px 3px rgba(0,0,0,0.3);" id="ocrToggleThumb"></span>
      </label>
      <span style="color:#666;">Hybrid</span>
    </div>
  </div>
  <div id="ocrPreview" style="display:none; margin-top:0.5rem;">
    <img id="ocrImage" style="max-width:100%; max-height:200px; border-radius:4px; margin-bottom:0.5rem;">
    <textarea id="ocrText" rows="6" placeholder="OCR text will appear here for review..."></textarea>
    <button id="useOcrBtn" style="margin-top:0.5rem; background:#1976d2; color:#fff; padding:0.5rem 1rem; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Use as Reference Passage</button>
  </div>
  <div id="ocrStatus"></div>
</div>

<div class="section">
  <label for="transcript">Reference Passage (optional &mdash; for alignment comparison)</label>
  <textarea id="transcript" placeholder="Paste the passage the student will read aloud..."></textarea>
</div>

<div class="section student-bar">
  <label>Student</label>
  <div class="student-controls">
    <select id="studentSelect"><option value="">-- No student --</option></select>
    <input type="text" id="newStudentName" placeholder="New student name">
    <select id="newStudentGrade">
      <option value="">Grade (optional)</option>
      <option value="3">Grade 3</option>
      <option value="4">Grade 4</option>
      <option value="5">Grade 5</option>
      <option value="6">Grade 6</option>
      <option value="7">Grade 7</option>
      <option value="8">Grade 8</option>
      <option value="9">Grade 9</option>
      <option value="10">Grade 10</option>
      <option value="11">Grade 11</option>
      <option value="12">Grade 12</option>
    </select>
    <button id="addStudentBtn">+ Add</button>
    <button id="deleteStudentBtn" style="background:#c62828;color:#fff;">Delete</button>
  </div>
</div>

<div class="section">
  <label>Audio Input</label>
  <div class="controls">
    <button id="recordBtn">Record</button>
    <span class="timer" id="timer">0:00</span>
    <label id="uploadBtn" style="background:#1976d2;color:#fff;padding:0.6rem 1.4rem;border-radius:4px;font-weight:600;cursor:pointer;">
      Upload WAV
      <input type="file" id="fileInput" accept=".wav,.flac,.ogg,.mp3,.webm" style="display:none">
    </label>
  </div>
  <div id="status"></div>
  <button id="analyzeBtn" disabled style="margin-top:0.75rem;">Analyze</button>
</div>

<div class="section">
  <label>Alignment Results</label>
  <!-- New Analyzed Words (bucketed classification) -->
  <div class="result-box" id="newAnalyzedWords" style="display:none;"></div>

  <!-- Raw STT results (no-reference mode) â€” hidden when alignment is active -->
  <div class="result-box" id="resultWords" style="display:none;"></div>

  <!-- STT Transcript View (collapsed by default) -->
  <div class="stt-transcript-section" id="sttTranscriptSection">
    <div class="stt-transcript-header" onclick="document.getElementById('sttTranscriptSection').classList.toggle('expanded')">
      <h4>STT Transcripts</h4>
      <span class="stt-transcript-toggle">â–¼</span>
    </div>
    <div class="stt-transcript-body">
      <div class="stt-transcript-words" id="sttTranscriptWords">Awaiting audio...</div>
    </div>
  </div>

  <!-- Prosody Metrics - collapsed by default, rendered by ui.js -->
  <div class="prosody-container" id="prosodyContainer" style="display:none;"></div>

  <label style="margin-top:1rem;">Metrics</label>
  <div class="result-box" id="resultPlain"></div>
  <label style="margin-top:1rem;">Details (JSON)</label>
  <div class="result-box" id="resultJson"></div>
</div>

<div id="historySection" class="section" style="display:none;">
  <label>Assessment History</label>
  <button id="viewDashboardBtn" style="float:right;background:#1565c0;color:#fff;padding:0.4rem 1rem;font-size:0.85rem;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Dashboard</button>
  <div id="historyList"></div>
</div>

<script src="js/number-words.js"></script>
<script type="module" src="js/app.js?v=54"></script>
<!-- Dev mode toggle -->
<button class="dev-mode-toggle" id="devModeToggle" title="Toggle developer mode">Dev Mode</button>
</body>
</html>
