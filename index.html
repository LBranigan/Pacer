<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#d32f2f">
<title>Pacer â€” Fluency and Comprehension Training</title>
<link rel="stylesheet" href="style.css">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- VAD ghost detection (Phase 12): ONNX Runtime + Silero VAD -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.22.0/dist/ort.wasm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.29/dist/bundle.min.js"></script>
</head>
<body>

<div id="version" style="text-align:right;font-size:0.75rem;color:#999;">v 2026-02-11 20:00</div>
<h1>Pacer â€” Fluency and Comprehension Training</h1>
<p class="subtitle">Reverb + Deepgram &mdash; Kitchen Sink Pipeline</p>

<div class="section">
  <label for="apiKey">Google Cloud API Key</label>
  <input type="text" id="apiKey" placeholder="Enter your GCP API key (Speech-to-Text API must be enabled)">
</div>

<div class="section" id="backendSettingsSection">
  <label>Backend Connection</label>
  <div class="backend-settings">
    <div class="backend-field">
      <label for="backendUrl">Backend URL</label>
      <input type="text" id="backendUrl" placeholder="http://localhost:8765">
    </div>
    <div class="backend-field">
      <label for="backendToken">Auth Token (optional)</label>
      <input type="password" id="backendToken" placeholder="Leave blank for local use">
    </div>
    <div class="backend-status">
      <button id="backendTestBtn" type="button">Test Connection</button>
      <span id="backendStatusText"></span>
    </div>
    <div id="backendReloadNotice" style="display:none; color:#e65100; font-size:0.85rem; margin-top:0.25rem;">
      Reload required for changes to take effect.
      <button id="backendReloadBtn" type="button" style="margin-left:0.5rem; font-size:0.8rem; padding:0.2rem 0.6rem;">Reload Now</button>
    </div>
  </div>
</div>

<div class="section" id="vadSettingsSection">
  <label>Ghost Detection Settings</label>
  <div class="vad-settings">
    <div class="vad-calibration">
      <button id="vadCalibrateBtn" title="Record 5 seconds of ambient noise to optimize detection">Calibrate Microphone</button>
      <span id="vadCalibrationStatus">Not calibrated (using default)</span>
    </div>
    <div class="vad-info" id="vadNoiseInfo" style="display:none;">
      <!-- Shown after calibration: "Noise Level: Low (0.20)" -->
    </div>
    <!-- Dev mode only: manual threshold control -->
    <div class="vad-threshold dev-mode-only">
      <label for="vadThresholdSlider">Manual Threshold: <span id="vadThresholdValue">0.375</span></label>
      <input type="range" id="vadThresholdSlider" min="0.15" max="0.60" step="0.01" value="0.375">
      <div class="vad-presets">
        <button class="vad-preset" data-threshold="0.20">Quiet Room</button>
        <button class="vad-preset" data-threshold="0.375">Normal</button>
        <button class="vad-preset" data-threshold="0.50">Noisy</button>
      </div>
    </div>
  </div>
</div>

<div class="section dev-mode-only" id="xvalEngineSection">
  <label>Cross-Validator Engine</label>
  <div class="xval-engine-options">
    <label><input type="radio" name="xvalEngine" value="parakeet"> Parakeet TDT 0.6B v3</label>
    <label><input type="radio" name="xvalEngine" value="deepgram"> Deepgram Nova-3</label>
  </div>
</div>

<div class="section">
  <label>Book Page OCR (optional)</label>
  <div class="controls">
    <label id="ocrUploadBtn" style="background:#388e3c;color:#fff;padding:0.6rem 1.4rem;border-radius:4px;font-weight:600;cursor:pointer;">
      ðŸ“· Photograph / Upload Page
      <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none">
    </label>
  </div>
  <div id="ocrPreview" style="display:none; margin-top:0.5rem;">
    <img id="ocrImage" style="max-width:100%; max-height:200px; border-radius:4px; margin-bottom:0.5rem;">
    <textarea id="ocrText" rows="6" placeholder="OCR text will appear here for review..."></textarea>
    <button id="useOcrBtn" style="margin-top:0.5rem; background:#1976d2; color:#fff; padding:0.5rem 1rem; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Use as Reference Passage</button>
  </div>
  <div id="ocrStatus"></div>
</div>

<div class="section">
  <label for="transcript">Reference Passage (optional &mdash; for alignment comparison)</label>
  <textarea id="transcript" placeholder="Paste the passage the student will read aloud..."></textarea>
</div>

<div class="section student-bar">
  <label>Student</label>
  <div class="student-controls">
    <select id="studentSelect"><option value="">-- No student --</option></select>
    <input type="text" id="newStudentName" placeholder="New student name">
    <select id="newStudentGrade">
      <option value="">Grade (optional)</option>
      <option value="3">Grade 3</option>
      <option value="4">Grade 4</option>
      <option value="5">Grade 5</option>
      <option value="6">Grade 6</option>
      <option value="7">Grade 7</option>
      <option value="8">Grade 8</option>
      <option value="9">Grade 9</option>
      <option value="10">Grade 10</option>
      <option value="11">Grade 11</option>
      <option value="12">Grade 12</option>
    </select>
    <button id="addStudentBtn">+ Add</button>
    <button id="deleteStudentBtn" style="background:#c62828;color:#fff;">Delete</button>
  </div>
</div>

<div class="section">
  <label>Audio Input</label>
  <div class="controls">
    <button id="recordBtn">Record</button>
    <span class="timer" id="timer">0:00</span>
    <label id="uploadBtn" style="background:#1976d2;color:#fff;padding:0.6rem 1.4rem;border-radius:4px;font-weight:600;cursor:pointer;">
      Upload WAV
      <input type="file" id="fileInput" accept=".wav,.flac,.ogg,.mp3,.webm" style="display:none">
    </label>
  </div>
  <div id="status"></div>
  <button id="analyzeBtn" disabled style="margin-top:0.75rem;">Analyze</button>
</div>

<div class="section">
  <label>Alignment Results</label>
  <div class="legend">
    <span class="word-correct" title="Word spoken matches the reference text exactly.&#10;&#10;Logic: STT hypothesis equals reference word after normalization.&#10;&#10;Example: Reference 'cat' â†’ Student says 'cat' â†’ Correct">Correct</span>
    <span class="word-substitution" title="Student said a different word than the reference.&#10;&#10;Logic: Diff alignment finds a DELETE+INSERT pair at the same position â€” the reference word was replaced by a different spoken word. Counts as an error in accuracy calculation.&#10;&#10;Example: Reference 'house' â†’ Student says 'horse' â†’ Substitution">Substitution</span>
    <span class="word-omission" title="Student skipped a word from the reference text.&#10;&#10;Logic: Diff alignment finds a DELETE with no corresponding INSERT â€” the reference word has no matching spoken word. Counts as an error in accuracy calculation.&#10;&#10;Example: Reference 'the big dog' â†’ Student says 'the dog' â†’ 'big' is an omission">Omission</span>
    <span class="word-insertion" title="Student said a word not in the reference text.&#10;&#10;Logic: Diff alignment finds an INSERT with no corresponding DELETE â€” a spoken word has no match in the reference. Does NOT count as an error per ORF standards.&#10;&#10;Example: Reference 'the dog' â†’ Student says 'the big dog' â†’ 'big' is an insertion">Insertion</span>
    <span class="word-self-correction" title="Student attempted a word, then corrected themselves. Does NOT count as an error.&#10;&#10;Two detection paths:&#10;&#10;1. Repetition: Consecutive identical words (or 2-word phrases) in the transcript that are NOT legitimate repeats in the reference text.&#10;Example: Student says 'the the dog' â†’ extra 'the' is a self-correction.&#10;&#10;2. Near-miss: An extra word that shares 3+ characters (prefix or suffix) or â‰¥40% Levenshtein similarity with the NEXT correctly read word.&#10;Example: Student says 'epi- epiphany' â†’ 'epi-' is a near-miss self-correction for 'epiphany'.">Self-corr.</span>
    <span class="word-struggle" title="Substitution+ â€” student failed to produce the word with additional evidence of decoding difficulty. Always counts as an error.&#10;&#10;Three pathways (a word can match multiple):&#10;&#10;Path 1 â€” Hesitation:&#10;Substitution + pause â‰¥ 3s before the word + ref word > 3 chars.&#10;Student hesitated a long time then still got the word wrong.&#10;Example: 3.8s pause â†’ says 'jued' for 'jumped'&#10;&#10;Path 2 â€” Decoding:&#10;Substitution + near-miss insertion(s) around it.&#10;Student made multiple failed attempts at the word.&#10;Example: 'sta', 'tieion' insertions around 'staion' for 'station'&#10;&#10;Path 3 â€” Abandoned Attempt:&#10;Substitution + cross-validator N/A (unconfirmed) + near-miss match.&#10;Student produced a partial/garbled attempt only verbatim STT detected.&#10;Example: says 'cont' for 'content's' â€” cross-validator heard nothing">Struggle</span>
    <span class="pause-indicator" title="A long pause detected between consecutive words.&#10;&#10;Logic: Any gap of 3 seconds or longer between one word's endTime and the next word's startTime is flagged as an error. No exceptions for punctuation.&#10;&#10;Example: 'the' ends at 2.0s, 'dog' starts at 5.5s â†’ 3.5s gap â†’ flagged as long pause (error)">[pause]</span>
    <span class="word-hesitation" title="Student hesitated before saying a word.&#10;&#10;Logic: Gap between previous word's endTime and this word's startTime falls within the hesitation range (flagged but not counted as error):&#10;â€¢ Default: 500ms â€“ 3000ms&#10;â€¢ After comma: 800ms â€“ 3000ms&#10;â€¢ After period/!/?: 1200ms â€“ 3000ms&#10;&#10;Gaps â‰¥ 3000ms are flagged separately as long pauses (errors).&#10;&#10;Example: Previous word ends at 4.0s, next word starts at 4.8s â†’ 800ms gap â†’ hesitation">Hesit.</span>
    <span class="word-morphological" title="Student said a morphological variant of the reference word (wrong ending or wrong beginning).&#10;&#10;Logic: Both conditions must be true:&#10;1. Word is already classified as a substitution&#10;2. Reference and spoken word share a 3+ character prefix OR suffix&#10;&#10;Examples:&#10;â€¢ Suffix error: Reference 'running' â†’ Student says 'runned' â†’ shared prefix 'run' (3 chars)&#10;â€¢ Prefix error: Reference 'unhappy' â†’ Student says 'happy' â†’ shared suffix 'happy' (5 chars)&#10;â€¢ Tense error: Reference 'jumped' â†’ Student says 'jumping' â†’ shared prefix 'jump' (4 chars)">Morph.</span>
    <span class="word-forgiven" title="Error on a proper name that is phonetically close to the expected word.&#10;&#10;Logic: Word is a proper noun (via NL API) AND Levenshtein similarity â‰¥ 40%.&#10;&#10;This is a vocabulary/knowledge gap, not a decoding failure. Student used phonics rules correctly but doesn't know the accepted pronunciation.&#10;&#10;Example: Reference 'Hermione' â†’ Student says 'Her-my-oh-nee' â†’ phonetically decoded â†’ forgiven (not counted as error)">Forgiven âœ“</span>
  </div>
  <div class="result-box" id="resultWords">Awaiting audio...</div>

  <!-- STT Transcript View (collapsed by default) -->
  <div class="stt-transcript-section" id="sttTranscriptSection">
    <div class="stt-transcript-header" onclick="document.getElementById('sttTranscriptSection').classList.toggle('expanded')">
      <h4>STT Transcripts</h4>
      <span class="stt-transcript-toggle">â–¼</span>
    </div>
    <div class="stt-transcript-body">
      <div class="stt-transcript-words" id="sttTranscriptWords">Awaiting audio...</div>
    </div>
  </div>

  <!-- Prosody Metrics - collapsed by default, rendered by ui.js -->
  <div class="prosody-container" id="prosodyContainer" style="display:none;"></div>

  <!-- Disfluency Diagnostics (Phase 24) - collapsed by default -->
  <div class="disfluency-section" id="disfluencySection" style="display:none;">
    <div class="disfluency-header" onclick="document.getElementById('disfluencySection').classList.toggle('expanded')">
      <h4>Disfluencies</h4>
      <span class="disfluency-toggle">&#9660;</span>
    </div>
    <div class="disfluency-body">
      <div class="disfluency-summary" id="disfluencySummaryText"></div>
      <div class="disfluency-details" id="disfluencyDetails"></div>
    </div>
  </div>

  <label style="margin-top:1rem;">Metrics</label>
  <div class="result-box" id="resultPlain"></div>
  <label style="margin-top:1rem;">Details (JSON)</label>
  <div class="result-box" id="resultJson"></div>
</div>

<div id="historySection" class="section" style="display:none;">
  <label>Assessment History</label>
  <button id="viewDashboardBtn" style="float:right;background:#1565c0;color:#fff;padding:0.4rem 1rem;font-size:0.85rem;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Dashboard</button>
  <div id="historyList"></div>
</div>

<script type="module" src="js/app.js?v=47"></script>
<!-- Dev mode toggle -->
<button class="dev-mode-toggle" id="devModeToggle" title="Toggle developer mode">Dev Mode</button>
</body>
</html>
