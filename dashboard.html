<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f5f5f5; color: #222; padding: 1.5rem; }
h1 { font-size: 1.3rem; margin-bottom: 1rem; }
.student-name { color: #1565c0; }

/* Layout: chart top, cards + detail bottom side-by-side */
.chart-area { background: #fff; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.chart-area canvas { width: 100%; height: 450px; display: block; }

.chart-controls { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.75rem; font-size: 0.85rem; }
.zoom-btn { padding: 0.3rem 0.7rem; font-size: 0.8rem; background: #e0e0e0; color: #333; border: 1px solid #bbb; border-radius: 3px; cursor: pointer; font-weight: 600; }
.zoom-btn.active { background: #1565c0; color: #fff; border-color: #1565c0; }
.metric-toggle { display: inline-flex; align-items: center; gap: 0.25rem; font-weight: 400; font-size: 0.85rem; cursor: pointer; }
.metric-toggle input { cursor: pointer; }

.bottom-row { display: flex; gap: 1rem; align-items: flex-start; }
.card-list { flex: 0 0 320px; max-height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
.detail-area { flex: 1; min-width: 0; }

/* Assessment cards */
.assessment-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem 1rem; cursor: pointer; transition: border-color 0.15s, box-shadow 0.15s; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
.assessment-card:hover { border-color: #1565c0; box-shadow: 0 1px 4px rgba(21,101,192,0.15); }
.assessment-card.active { border-color: #1565c0; background: #e3f2fd; box-shadow: 0 1px 4px rgba(21,101,192,0.2); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
.card-date { font-weight: 600; color: #333; }
.card-wcpm { background: #1565c0; color: #fff; padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.8rem; font-weight: 700; }
.card-stats { font-size: 0.8rem; color: #666; display: flex; justify-content: space-between; }
.card-errors { font-family: 'Consolas', monospace; }
.empty-msg { color: #999; font-style: italic; padding: 1rem 0; }

/* Error breakdown */
.error-breakdown { background: #fff; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1rem; }
.error-section { margin-bottom: 1rem; }
.error-section:last-child { margin-bottom: 0; }
.error-section h4 { font-size: 0.9rem; margin-bottom: 0.5rem; }
.error-substitutions h4 { color: #e65100; }
.error-omissions h4 { color: #c62828; }
.error-insertions h4 { color: #1565c0; }
.error-section table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.error-section th, .error-section td { padding: 0.25rem 0.5rem; border-bottom: 1px solid #eee; text-align: left; }
.error-section th { font-size: 0.75rem; color: #888; }
.error-section .arrow { text-align: center; color: #e65100; font-weight: 700; }
.error-section ul { list-style: none; display: flex; flex-wrap: wrap; gap: 0.4rem; }
.error-omissions li { background: #ffcdd2; color: #c62828; padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.85rem; }
.error-insertions li { background: #bbdefb; color: #1565c0; padding: 0.15rem 0.5rem; border-radius: 3px; font-size: 0.85rem; }
.error-detail { color: #999; font-style: italic; }

/* Audio playback */
.playback-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
.playback-play-btn { background: #1976d2; color: #fff; padding: 0.4rem 1rem; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; min-width: 70px; }
.playback-progress { flex: 1; cursor: pointer; }
.playback-time { font-size: 0.85rem; color: #555; font-variant-numeric: tabular-nums; min-width: 90px; text-align: right; }
.playback-words { line-height: 2; padding: 0.5rem 0; }
.playback-word { display: inline-block; padding: 2px 6px; margin: 2px; border-radius: 12px; font-size: 0.95rem; transition: background-color 0.1s; }
.playback-word.correct { background: #e8f5e9; color: #2e7d32; }
.playback-word.substitution { background: #ffebee; color: #c62828; }
.playback-word.omission { background: #fff3e0; color: #e65100; text-decoration: line-through; }
.playback-word.insertion { background: #e3f2fd; color: #1565c0; }
.playback-word.speaking { background: #fff176; color: #222; box-shadow: 0 0 0 2px #fdd835; }
.playback-no-audio { color: #999; font-style: italic; margin: 0.5rem 0; }
#audioPlaybackArea { margin-top: 1rem; }
</style>
</head>
<body>

<h1>Dashboard: <span id="studentName" class="student-name"></span></h1>

<div class="chart-area">
  <div class="chart-controls">
    <span style="font-weight:600;margin-right:0.5rem;">Zoom:</span>
    <button class="zoom-btn" data-zoom="7">1W</button>
    <button class="zoom-btn" data-zoom="30">1M</button>
    <button class="zoom-btn" data-zoom="90">3M</button>
    <button class="zoom-btn active" data-zoom="140">Full</button>
    <span style="margin-left:1rem;font-weight:600;">Show:</span>
    <label class="metric-toggle"><input type="checkbox" data-metric="correctPerMinute" checked> Correct/Min</label>
    <label class="metric-toggle"><input type="checkbox" data-metric="errorsPerMinute" checked> Errors/Min</label>
    <label class="metric-toggle"><input type="checkbox" id="celerationLineToggle"> Celeration Lines</label>
  </div>
  <canvas id="celerationCanvas"></canvas>
</div>

<div class="bottom-row">
  <div class="card-list" id="assessmentCards"></div>
  <div class="detail-area">
    <div class="error-breakdown" id="errorBreakdown">
      <p class="error-detail">Click an assessment to see error details.</p>
    </div>
    <div id="audioPlaybackArea"></div>
  </div>
</div>

<script type="module">
import { createChart } from './js/celeration-chart.js';
import { createSyncedPlayback } from './js/audio-playback.js';
import { getStudents, getAssessments } from './js/storage.js';

const params = new URLSearchParams(window.location.search);
const studentId = params.get('student');
if (!studentId) {
  document.body.innerHTML = '<p>No student specified.</p>';
  throw new Error('Missing student param');
}

const students = getStudents();
const student = students.find(s => s.id === studentId);
document.getElementById('studentName').textContent = student ? student.name : 'Unknown';

const assessments = getAssessments(studentId);
const canvas = document.getElementById('celerationCanvas');
const cardList = document.getElementById('assessmentCards');
const errorBreakdown = document.getElementById('errorBreakdown');
const audioArea = document.getElementById('audioPlaybackArea');

let chart = null;
let playback = null;

// --- Chart ---
if (assessments.length > 0) {
  chart = createChart(canvas);
  const sorted = [...assessments].sort((a, b) => new Date(a.date) - new Date(b.date));
  const firstDate = new Date(sorted[0].date).getTime();
  const chartAssessments = sorted.map(a => {
    const calendarDay = Math.floor((new Date(a.date).getTime() - firstDate) / 86400000);
    const correctPerMinute = a.wcpm || 0;
    const errorsPerMinute = (a.duration && a.duration > 0) ? (a.errors || 0) / (a.duration / 60) : 0;
    return { calendarDay, correctPerMinute, errorsPerMinute };
  });
  chart.setData([{ name: student ? student.name : 'Student', id: studentId, assessments: chartAssessments }]);
}

// --- Zoom buttons ---
document.querySelectorAll('[data-zoom]').forEach(btn => {
  btn.addEventListener('click', () => {
    if (chart) chart.setZoom(parseInt(btn.dataset.zoom, 10));
    document.querySelectorAll('[data-zoom]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
});

// --- Metric toggles ---
document.querySelectorAll('[data-metric]').forEach(toggle => {
  toggle.addEventListener('change', () => {
    if (chart) {
      const metrics = {};
      metrics[toggle.dataset.metric] = toggle.checked;
      chart.setMetrics(metrics);
    }
  });
});

// --- Celeration line toggle ---
const celToggle = document.getElementById('celerationLineToggle');
if (celToggle) {
  celToggle.addEventListener('change', () => {
    if (chart) chart.toggleCelerationLines(celToggle.checked);
  });
}

// --- Assessment cards ---
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML;
}

function renderCards() {
  cardList.innerHTML = '';
  if (!assessments.length) {
    cardList.innerHTML = '<p class="empty-msg">No assessments yet.</p>';
    return;
  }
  const sorted = [...assessments].sort((a, b) => new Date(b.date) - new Date(a.date));
  for (const a of sorted) {
    const card = document.createElement('div');
    card.className = 'assessment-card';
    const date = new Date(a.date).toLocaleDateString();
    const wcpm = a.wcpm != null ? a.wcpm : 'N/A';
    const acc = a.accuracy != null ? a.accuracy + '%' : 'N/A';
    const subs = a.errorBreakdown ? a.errorBreakdown.substitutions : '?';
    const omit = a.errorBreakdown ? a.errorBreakdown.omissions : '?';
    const ins = a.errorBreakdown ? a.errorBreakdown.insertions : '?';
    card.innerHTML =
      '<div class="card-header">' +
        '<span class="card-date">' + date + '</span>' +
        '<span class="card-wcpm">' + wcpm + ' WCPM</span>' +
      '</div>' +
      '<div class="card-stats">' +
        '<span>Accuracy: ' + acc + '</span>' +
        '<span class="card-errors">S:' + subs + ' O:' + omit + ' I:' + ins + '</span>' +
      '</div>';
    card.addEventListener('click', () => {
      cardList.querySelectorAll('.assessment-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      showErrorBreakdown(a);
      showAudioPlayback(a);
    });
    cardList.appendChild(card);
  }
}

function showErrorBreakdown(a) {
  errorBreakdown.innerHTML = '';
  if (!a.errorBreakdown || !a.errorBreakdown.details) {
    errorBreakdown.innerHTML = '<p class="error-detail">Detailed breakdown not available for this assessment.</p>';
    return;
  }
  const eb = a.errorBreakdown;
  const details = eb.details || [];

  const subs = details.filter(d => d.type === 'substitution');
  if (subs.length > 0) {
    const section = document.createElement('div');
    section.className = 'error-section error-substitutions';
    section.innerHTML = '<h4>Substitutions (' + eb.substitutions + ')</h4>';
    const table = document.createElement('table');
    table.innerHTML = '<tr><th>Expected</th><th></th><th>Spoke</th></tr>';
    for (const s of subs) {
      const row = document.createElement('tr');
      row.innerHTML = '<td>' + esc(s.ref) + '</td><td class="arrow">&rarr;</td><td>' + esc(s.hyp) + '</td>';
      table.appendChild(row);
    }
    section.appendChild(table);
    errorBreakdown.appendChild(section);
  }

  const omissions = details.filter(d => d.type === 'omission');
  if (omissions.length > 0) {
    const section = document.createElement('div');
    section.className = 'error-section error-omissions';
    section.innerHTML = '<h4>Omissions (' + eb.omissions + ')</h4>';
    const list = document.createElement('ul');
    for (const o of omissions) {
      const li = document.createElement('li');
      li.textContent = o.ref;
      list.appendChild(li);
    }
    section.appendChild(list);
    errorBreakdown.appendChild(section);
  }

  const insertions = details.filter(d => d.type === 'insertion');
  if (insertions.length > 0) {
    const section = document.createElement('div');
    section.className = 'error-section error-insertions';
    section.innerHTML = '<h4>Insertions (' + eb.insertions + ')</h4>';
    const list = document.createElement('ul');
    for (const i of insertions) {
      const li = document.createElement('li');
      li.textContent = i.hyp;
      list.appendChild(li);
    }
    section.appendChild(list);
    errorBreakdown.appendChild(section);
  }

  if (subs.length === 0 && omissions.length === 0 && insertions.length === 0) {
    errorBreakdown.innerHTML = '<p class="error-detail">No errors in this assessment.</p>';
  }
}

function showAudioPlayback(a) {
  if (playback) {
    playback.destroy();
    playback = null;
  }
  audioArea.innerHTML = '';

  if (!a.audioRef) {
    audioArea.innerHTML = '<p class="playback-no-audio">Audio not recorded for this assessment.</p>';
    return;
  }

  const heading = document.createElement('h4');
  heading.textContent = 'Play Audio';
  heading.style.marginBottom = '0.5rem';
  audioArea.appendChild(heading);

  const playerDiv = document.createElement('div');
  audioArea.appendChild(playerDiv);

  playback = createSyncedPlayback(playerDiv);
  playback.load(a.audioRef, a.sttWords || [], a.alignment || []);
}

renderCards();
</script>
</body>
</html>
