<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beat Tester</title>
<style>
  body { background: #1a1a2e; color: #eee; font-family: system-ui; display: flex; flex-direction: column; align-items: center; padding: 2rem; gap: 1rem; }
  h1 { margin: 0; }
  .controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; justify-content: center; }
  select, button { font-size: 1.1rem; padding: 0.5rem 1.2rem; border-radius: 8px; border: none; cursor: pointer; }
  button { background: #e67e22; color: #fff; font-weight: 700; }
  button:hover { background: #d35400; }
  select { background: #2a2a4a; color: #eee; }
  .status { color: #888; font-size: 0.9rem; }
  label { white-space: nowrap; }
  .level-btn { background: #2a2a4a; color: #888; font-size: 0.95rem; padding: 0.4rem 1rem; transition: background 0.15s, color 0.15s; }
  .level-btn.active { background: #e67e22; color: #fff; }
</style>
</head>
<body>
<h1>Beat Tester</h1>
<div class="controls">
  <select id="style">
    <option value="lofi">Lo-Fi Chill</option>
    <option value="lofi4">Night Coffee</option>
    <option value="bramble">Bramble (DKC2)</option>
    <option value="jazzhop">Jazz Hop</option>
    <option value="ambient">Ambient</option>
    <option value="bossa">Bossa Nova</option>
    <option value="lounge">Lounge Bossa</option>
    <option value="chiptune">Chiptune 8-Bit</option>
    <option value="classical">Classical Piano</option>
    <option value="trap">Trap</option>
    <option value="zelda">Zelda</option>
    <option value="megaman">Mega Man 2</option>
    <option value="zelda2">Zelda II Palace</option>
    <option value="bossa2">Bossa + Piano (Clone)</option>
    <option value="bossa-piano">Bossa + Piano</option>
    <option value="jazzhop-piano">Jazz Hop + Piano</option>
    <option value="chiptune-piano">Chiptune + Piano</option>
    <option value="lounge-piano">Lounge + Piano</option>
  </select>
  <button id="playBtn">Play</button>
  <button id="stopBtn">Stop</button>
</div>
<div class="controls">
  <label>Volume: <input type="range" id="beatVol" min="0" max="100" value="70"></label>
  <label>BPM: <span id="bpmLabel">75</span> <input type="range" id="bpmSlider" min="50" max="140" value="75"></label>
</div>
<div class="controls">
  <span style="color:#888;font-size:0.85rem">Layers:</span>
  <button class="level-btn active" data-level="0">Base</button>
  <button class="level-btn" data-level="0.35">+3</button>
  <button class="level-btn" data-level="0.65">+6</button>
  <button class="level-btn" data-level="1">+9</button>
  <button class="level-btn" data-level="1.5">+12</button>
</div>
<div class="status" id="status">Ready</div>

<script type="module">
import { BeatPlayer } from './js/beat-player.js';

let player = null;

function getPlayer() {
  if (!player) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    player = new BeatPlayer(ctx);
    player.output.connect(ctx.destination);
  }
  return player;
}

const BPM_DEFAULT  = { min: 50, max: 140, value: 75 };
const BPM_OVERRIDE = {
  megaman: { min: 100, max: 200, value: 150 },
  zelda2:  { min: 110, max: 210, value: 160 },
  lofi4:   { min: 60, max: 90, value: 76 },
  bramble: { min: 70, max: 120, value: 95 },
  bossa2:  { min: 60, max: 180, value: 120 },
};

function updateBpmRange(style) {
  const cfg = BPM_OVERRIDE[style] || BPM_DEFAULT;
  const slider = document.getElementById('bpmSlider');
  slider.min = cfg.min;
  slider.max = cfg.max;
  slider.value = cfg.value;
  document.getElementById('bpmLabel').textContent = cfg.value;
}

function selectOverlayLevel(level) {
  document.querySelectorAll('.level-btn').forEach(b => {
    b.classList.toggle('active', parseFloat(b.dataset.level) === level);
  });
  const p = getPlayer();
  p.setOverlayLevel(level);
}

function playStyle(style) {
  const p = getPlayer();
  p.setStyle(style);
  p.setVolume(document.getElementById('beatVol').value / 100);
  p.setTempo(Number(document.getElementById('bpmSlider').value));
  const activeBtn = document.querySelector('.level-btn.active');
  if (activeBtn) p.setOverlayLevel(parseFloat(activeBtn.dataset.level));
  p.start();
  document.getElementById('status').textContent = 'Playing: ' + style;
}

document.getElementById('playBtn').addEventListener('click', () => {
  playStyle(document.getElementById('style').value);
});

document.getElementById('stopBtn').addEventListener('click', () => {
  if (player) player.stop();
  document.getElementById('status').textContent = 'Stopped';
});

document.getElementById('style').addEventListener('change', () => {
  const style = document.getElementById('style').value;
  updateBpmRange(style);
  if (player && player.isPlaying) playStyle(style);
});

document.getElementById('beatVol').addEventListener('input', (e) => {
  if (player) player.setVolume(e.target.value / 100);
});

document.getElementById('bpmSlider').addEventListener('input', (e) => {
  document.getElementById('bpmLabel').textContent = e.target.value;
  if (player) player.setTempo(Number(e.target.value));
});

document.querySelectorAll('.level-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    selectOverlayLevel(parseFloat(btn.dataset.level));
  });
});
</script>
</body>
</html>
